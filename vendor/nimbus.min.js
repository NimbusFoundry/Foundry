//Copyright NimbusBase (NimbusBase.com)
//Version 2.1
//License details at http://nimbusbase.com/pricing.html
// Built on 2014年 7月21日 星期一 17时30分16秒 CST
// Generated by CoffeeScript 1.6.3
(function() {
  "use strict";
  var atob, b64chars, b64tab, btoa, btou, buffer, cb_btou, cb_decode, cb_encode, cb_utob, decode, encode, encodeURI, fromCharCode, global, noEnum, re_btou, re_utob, utob, version, _decode, _encode;

  global = this;

  if (global.Base64) {
    return;
  }

  version = "2.1.2";

  buffer = void 0;

  if (typeof module !== "undefined" && module.exports) {
    buffer = require("buffer").Buffer;
  }

  b64chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

  b64tab = function(bin) {
    var i, l, t;
    t = {};
    i = 0;
    l = bin.length;
    while (i < l) {
      t[bin.charAt(i)] = i;
      i++;
    }
    return t;
  };

  b64chars;

  fromCharCode = String.fromCharCode;

  cb_utob = function(c) {
    var cc;
    if (c.length < 2) {
      cc = c.charCodeAt(0);
      if (cc < 0x80) {
        return c;
      } else {
        if (cc < 0x800) {
          return fromCharCode(0xc0 | (cc >>> 6)) + fromCharCode(0x80 | (cc & 0x3f));
        } else {
          return fromCharCode(0xe0 | ((cc >>> 12) & 0x0f)) + fromCharCode(0x80 | ((cc >>> 6) & 0x3f)) + fromCharCode(0x80 | (cc & 0x3f));
        }
      }
    } else {
      cc = 0x10000 + (c.charCodeAt(0) - 0xD800) * 0x400 + (c.charCodeAt(1) - 0xDC00);
      return fromCharCode(0xf0 | ((cc >>> 18) & 0x07)) + fromCharCode(0x80 | ((cc >>> 12) & 0x3f)) + fromCharCode(0x80 | ((cc >>> 6) & 0x3f)) + fromCharCode(0x80 | (cc & 0x3f));
    }
  };

  re_utob = /[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g;

  utob = function(u) {
    return u.replace(re_utob, cb_utob);
  };

  cb_encode = function(ccc) {
    var chars, ord, padlen;
    padlen = [0, 2, 1][ccc.length % 3];
    ord = ccc.charCodeAt(0) << 16 | ((ccc.length > 1 ? ccc.charCodeAt(1) : 0) << 8) | (ccc.length > 2 ? ccc.charCodeAt(2) : 0);
    chars = [b64chars.charAt(ord >>> 18), b64chars.charAt((ord >>> 12) & 63), (padlen >= 2 ? "=" : b64chars.charAt((ord >>> 6) & 63)), (padlen >= 1 ? "=" : b64chars.charAt(ord & 63))];
    return chars.join("");
  };

  btoa = global.btoa || function(b) {
    return b.replace(/[\s\S]{1,3}/g, cb_encode);
  };

  _encode = (buffer ? function(u) {
    return (new buffer(u)).toString("base64");
  } : function(u) {
    return btoa(utob(u));
  });

  encode = function(u, urisafe) {
    if (!urisafe) {
      return _encode(u);
    } else {
      return _encode(u).replace(/[+\/]/g, function(m0) {
        if (m0 === "+") {
          return "-";
        } else {
          return "_";
        }
      }).replace(RegExp("=", "g"), "");
    }
  };

  encodeURI = function(u) {
    return encode(u, true);
  };

  re_btou = re_btou = new RegExp(['[\xC0-\xDF][\x80-\xBF]', '[\xE0-\xEF][\x80-\xBF]{2}', '[\xF0-\xF7][\x80-\xBF]{3}'].join('|'), 'g');

  cb_btou = function(cccc) {
    var cp, offset;
    switch (cccc.length) {
      case 4:
        cp = ((0x07 & cccc.charCodeAt(0)) << 18) | ((0x3f & cccc.charCodeAt(1)) << 12) | ((0x3f & cccc.charCodeAt(2)) << 6) | (0x3f & cccc.charCodeAt(3));
        offset = cp - 0x10000;
        return fromCharCode((offset >>> 10) + 0xD800) + fromCharCode((offset & 0x3FF) + 0xDC00);
      case 3:
        return fromCharCode(((0x0f & cccc.charCodeAt(0)) << 12) | ((0x3f & cccc.charCodeAt(1)) << 6) | (0x3f & cccc.charCodeAt(2)));
      default:
        return fromCharCode(((0x1f & cccc.charCodeAt(0)) << 6) | (0x3f & cccc.charCodeAt(1)));
    }
  };

  btou = function(b) {
    return b.replace(re_btou, cb_btou);
  };

  cb_decode = function(cccc) {
    var chars, len, n, padlen;
    len = cccc.length;
    padlen = len % 4;
    n = (len > 0 ? b64tab[cccc.charAt(0)] << 18 : 0) | (len > 1 ? b64tab[cccc.charAt(1)] << 12 : 0) | (len > 2 ? b64tab[cccc.charAt(2)] << 6 : 0) | (len > 3 ? b64tab[cccc.charAt(3)] : 0);
    chars = [fromCharCode(n >>> 16), fromCharCode((n >>> 8) & 0xff), fromCharCode(n & 0xff)];
    chars.length -= [0, 0, 2, 1][padlen];
    return chars.join("");
  };

  atob = global.atob || function(a) {
    return a.replace(/[\s\S]{1,4}/g, cb_decode);
  };

  _decode = (buffer ? function(a) {
    return (new buffer(a, "base64")).toString();
  } : function(a) {
    return btou(atob(a));
  });

  decode = function(a) {
    return _decode(a.replace(/[-_]/g, function(m0) {
      if (m0 === "-") {
        return "+";
      } else {
        return "/";
      }
    }).replace(/[^A-Za-z0-9\+\/]/g, ""));
  };

  global.Base64 = {
    VERSION: version,
    atob: atob,
    btoa: btoa,
    fromBase64: decode,
    toBase64: encode,
    utob: utob,
    encode: encode,
    encodeURI: encodeURI,
    btou: btou,
    decode: decode
  };

  if (typeof Object.defineProperty === "function") {
    noEnum = function(v) {
      return {
        value: v,
        enumerable: false,
        writable: true,
        configurable: true
      };
    };
    global.Base64.extendString = function() {
      Object.defineProperty(String.prototype, "fromBase64", noEnum(function() {
        return decode(this);
      }));
      Object.defineProperty(String.prototype, "toBase64", noEnum(function(urisafe) {
        return encode(this, urisafe);
      }));
      return Object.defineProperty(String.prototype, "toBase64URI", noEnum(function() {
        return encode(this, true);
      }));
    };
  }

}).call(this);

!function(e){"object"==typeof exports?module.exports=e():"function"==typeof define&&define.amd?define(e):"undefined"!=typeof window?window.PouchDB=e():"undefined"!=typeof global?global.PouchDB=e():"undefined"!=typeof self&&(self.PouchDB=e())}(function(){var define,module,exports;return function e(t,n,r){function o(a,s){if(!n[a]){if(!t[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(i)return i(a,!0);throw new Error("Cannot find module '"+a+"'")}var c=n[a]={exports:{}};t[a][0].call(c.exports,function(e){var n=t[a][1][e];return o(n?n:e)},c,c.exports,e,t,n,r)}return n[a].exports}for(var i="function"==typeof require&&require,a=0;a<r.length;a++)o(r[a]);return o}({1:[function(require,module,exports){"use strict";function arrayFirst(e,t){for(var n=0;n<e.length;n++)if(t(e[n],n)===!0)return e[n];return!1}function yankError(e){return function(t,n){t||n[0].error?call(e,t||n[0]):call(e,null,n[0])}}function computeHeight(e){var t={},n=[];return merge.traverseRevTree(e,function(e,r,o,i){var a=r+"-"+o;return e&&(t[a]=0),void 0!==i&&n.push({from:i,to:a}),a}),n.reverse(),n.forEach(function(e){t[e.from]=void 0===t[e.from]?1+t[e.to]:Math.min(t[e.from],1+t[e.to])}),t}var utils=require("./utils"),merge=require("./merge"),errors=require("./deps/errors"),call=utils.call;module.exports=function(Pouch){return function(opts,callback){function autoCompact(e){return auto_compaction?function(t,n){if(t)call(e,t);else{var r=n.length,o=function(){r--,r||call(e,null,n)};n.forEach(function(e){e.ok?compactDocument(e.id,1,o):o()})}}:e}function compactDocument(e,t,n){customApi._getRevisionTree(e,function(r,o){if(r)return call(n);var i=computeHeight(o),a=[],s=[];Object.keys(i).forEach(function(e){i[e]>t&&a.push(e)}),merge.traverseRevTree(o,function(e,t,n,r,o){var i=t+"-"+n;"available"===o.status&&-1!==a.indexOf(i)&&(o.status="missing",s.push(i))}),customApi._doCompaction(e,o,s,n)})}function processChange(e,t,n){var r=[{rev:e._rev}];"all_docs"===n.style&&(r=merge.collectLeaves(t.rev_tree).map(function(e){return{rev:e.rev}}));var o={id:t.id,changes:r,doc:e};return utils.isDeleted(t,e._rev)&&(o.deleted=!0),n.conflicts&&(o.doc._conflicts=merge.collectConflicts(t),o.doc._conflicts.length||delete o.doc._conflicts),o}var api={},customApi=Pouch.adapters[opts.adapter](opts,function(e,t){if(e)return callback&&callback(e),void 0;for(var n in api)t.hasOwnProperty(n)||(t[n]=api[n]);opts.name===Pouch.prefix+Pouch.ALL_DBS?callback(e,t):Pouch.open(opts,function(e){callback(e,t)})}),auto_compaction=opts.auto_compaction===!0;api.post=function(e,t,n){return"function"==typeof t&&(n=t,t={}),"object"!=typeof e||Array.isArray(e)?call(n,errors.NOT_AN_OBJECT):customApi.bulkDocs({docs:[e]},t,autoCompact(yankError(n)))},api.put=function(e,t,n){return"function"==typeof t&&(n=t,t={}),"object"!=typeof e?call(n,errors.NOT_AN_OBJECT):utils.isValidId(e._id)?customApi.bulkDocs({docs:[e]},t,autoCompact(yankError(n))):call(n,errors.MISSING_ID)},api.putAttachment=function(e,t,n,r,o,i){function a(e){e._attachments=e._attachments||{},e._attachments[t]={content_type:o,data:r},api.put(e,i)}return api.taskqueue.ready()?("function"==typeof o&&(i=o,o=r,r=n,n=null),"undefined"==typeof o&&(o=r,r=n,n=null),api.get(e,function(t,r){return t&&t.error===errors.MISSING_DOC.error?(a({_id:e}),void 0):t?(call(i,t),void 0):r._rev!==n?(call(i,errors.REV_CONFLICT),void 0):(a(r),void 0)}),void 0):(api.taskqueue.addTask("putAttachment",arguments),void 0)},api.removeAttachment=function(e,t,n,r){api.get(e,function(e,o){return e?(call(r,e),void 0):o._rev!==n?(call(r,errors.REV_CONFLICT),void 0):o._attachments?(delete o._attachments[t],0===Object.keys(o._attachments).length&&delete o._attachments,api.put(o,r),void 0):call(r,null)})},api.remove=function(e,t,n){"function"==typeof t&&(n=t,t={}),void 0===t&&(t={}),t.was_delete=!0;var r={_id:e._id,_rev:e._rev};return r._deleted=!0,customApi.bulkDocs({docs:[r]},t,yankError(n))},api.revsDiff=function(e,t,n){function r(e,t){s[e]||(s[e]={missing:[]}),s[e].missing.push(t)}function o(t,n){var o=e[t].slice(0);merge.traverseRevTree(n,function(e,n,i,a,s){var u=n+"-"+i,c=o.indexOf(u);-1!==c&&(o.splice(c,1),"available"!==s.status&&r(t,u))}),o.forEach(function(e){r(t,e)})}"function"==typeof t&&(n=t,t={});var i=Object.keys(e),a=0,s={};i.map(function(t){customApi._getRevisionTree(t,function(r,u){if(r&&"not_found"===r.name&&"missing"===r.message)s[t]={missing:e[t]};else{if(r)return call(n,r);o(t,u)}return++a===i.length?call(n,null,s):void 0})})},api.compact=function(e,t){"function"==typeof e&&(t=e,e={}),api.changes({complete:function(e,n){if(e)return call(t),void 0;var r=n.results.length;return r?(n.results.forEach(function(e){compactDocument(e.id,0,function(){r--,r||call(t)})}),void 0):(call(t),void 0)}})},api.get=function(e,t,n){function r(){var r=[],i=o.length;return i?(o.forEach(function(o){api.get(e,{rev:o,revs:t.revs},function(e,t){e?r.push({missing:o}):r.push({ok:t}),i--,i||call(n,null,r)})}),void 0):call(n,null,r)}if(!api.taskqueue.ready())return api.taskqueue.addTask("get",arguments),void 0;"function"==typeof t&&(n=t,t={});var o=[];{if(!t.open_revs)return customApi._get(e,t,function(e,r){if(e)return call(n,e);var o=r.doc,i=r.metadata,a=r.ctx;if(t.conflicts){var s=merge.collectConflicts(i);s.length&&(o._conflicts=s)}if(t.revs||t.revs_info){var u=merge.rootToLeaf(i.rev_tree),c=arrayFirst(u,function(e){return-1!==e.ids.map(function(e){return e.id}).indexOf(o._rev.split("-")[1])});if(c.ids.splice(c.ids.map(function(e){return e.id}).indexOf(o._rev.split("-")[1])+1),c.ids.reverse(),t.revs&&(o._revisions={start:c.pos+c.ids.length-1,ids:c.ids.map(function(e){return e.id})}),t.revs_info){var d=c.pos+c.ids.length;o._revs_info=c.ids.map(function(e){return d--,{rev:d+"-"+e.id,status:e.opts.status}})}}if(t.local_seq&&(o._local_seq=r.metadata.seq),t.attachments&&o._attachments){var l=o._attachments,f=Object.keys(l).length;if(0===f)return call(n,null,o);Object.keys(l).forEach(function(e){customApi._getAttachment(l[e],{encode:!0,ctx:a},function(t,r){o._attachments[e].data=r,--f||call(n,null,o)})})}else{if(o._attachments)for(var p in o._attachments)o._attachments[p].stub=!0;call(n,null,o)}});if("all"===t.open_revs)customApi._getRevisionTree(e,function(e,t){e&&(t=[]),o=merge.collectLeaves(t).map(function(e){return e.rev}),r()});else{if(!Array.isArray(t.open_revs))return call(n,errors.error(errors.UNKNOWN_ERROR,"function_clause"));o=t.open_revs;for(var i=0;i<o.length;i++){var a=o[i];if("string"!=typeof a||!/^\d+-/.test(a))return call(n,errors.error(errors.BAD_REQUEST,"Invalid rev format"))}r()}}},api.getAttachment=function(e,t,n,r){return api.taskqueue.ready()?(n instanceof Function&&(r=n,n={}),customApi._get(e,n,function(e,o){return e?call(r,e):o.doc._attachments&&o.doc._attachments[t]?(n.ctx=o.ctx,customApi._getAttachment(o.doc._attachments[t],n,r),void 0):call(r,errors.MISSING_DOC)}),void 0):(api.taskqueue.addTask("getAttachment",arguments),void 0)},api.allDocs=function(e,t){if(!api.taskqueue.ready())return api.taskqueue.addTask("allDocs",arguments),void 0;if("function"==typeof e&&(t=e,e={}),"keys"in e){if("startkey"in e)return call(t,errors.error(errors.QUERY_PARSE_ERROR,"Query parameter `start_key` is not compatible with multi-get")),void 0;if("endkey"in e)return call(t,errors.error(errors.QUERY_PARSE_ERROR,"Query parameter `end_key` is not compatible with multi-get")),void 0}return"undefined"==typeof e.skip&&(e.skip=0),customApi._allDocs(e,t)},api.changes=function(opts){if(!api.taskqueue.ready()){var task=api.taskqueue.addTask("changes",arguments);return{cancel:function(){return task.task?task.task.cancel():(Pouch.DEBUG,task.parameters[0].aborted=!0,void 0)}}}if(opts=utils.extend(!0,{},opts),opts.processChange=processChange,opts.since||(opts.since=0),"latest"===opts.since){var changes;return api.info(function(e,t){opts.aborted||(opts.since=t.update_seq-1,api.changes(opts))}),{cancel:function(){return changes?changes.cancel():(Pouch.DEBUG,opts.aborted=!0,void 0)}}}if(opts.filter&&"string"==typeof opts.filter){if("_view"===opts.filter)if(opts.view&&"string"==typeof opts.view){var viewName=opts.view.split("/");api.get("_design/"+viewName[0],function(err,ddoc){if(ddoc&&ddoc.views&&ddoc.views[viewName[1]]){var filter=eval("(function () {  return function (doc) {    var emitted = false;    var emit = function (a, b) {      emitted = true;    };    var view = "+ddoc.views[viewName[1]].map+";    view(doc);    if (emitted) {      return true;    }  }})()");opts.aborted||(opts.filter=filter,api.changes(opts))}else{var msg=ddoc.views?"missing json key: "+viewName[1]:"missing json key: views";err=err||errors.error(errors.MISSING_DOC,msg),utils.call(opts.complete,err)}})}else{var err=errors.error(errors.BAD_REQUEST,"`view` filter parameter is not provided.");utils.call(opts.complete,err)}else{var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){if(ddoc&&ddoc.filters&&ddoc.filters[filterName[1]]){var filter=eval("(function () { return "+ddoc.filters[filterName[1]]+" })()");opts.aborted||(opts.filter=filter,api.changes(opts))}else{var msg=ddoc&&ddoc.filters?"missing json key: "+filterName[1]:"missing json key: filters";err=err||errors.error(errors.MISSING_DOC,msg),utils.call(opts.complete,err)}})}return{cancel:function(){Pouch.DEBUG&&console.log("Cancel Changes Feed"),opts.aborted=!0}}}return"descending"in opts||(opts.descending=!1),opts.limit=0===opts.limit?1:opts.limit,customApi._changes(opts)},api.close=function(e){return api.taskqueue.ready()?customApi._close(e):(api.taskqueue.addTask("close",arguments),void 0)},api.info=function(e){return api.taskqueue.ready()?customApi._info(e):(api.taskqueue.addTask("info",arguments),void 0)},api.id=function(){return customApi._id()},api.type=function(){return"function"==typeof customApi._type?customApi._type():opts.adapter},api.bulkDocs=function(e,t,n){if(!api.taskqueue.ready())return api.taskqueue.addTask("bulkDocs",arguments),void 0;if("function"==typeof t&&(n=t,t={}),t=t?utils.extend(!0,{},t):{},!e||!e.docs||e.docs.length<1)return call(n,errors.MISSING_BULK_DOCS);if(!Array.isArray(e.docs))return call(n,errors.QUERY_PARSE_ERROR);for(var r=0;r<e.docs.length;++r)if("object"!=typeof e.docs[r]||Array.isArray(e.docs[r]))return call(n,errors.NOT_AN_OBJECT);return e=utils.extend(!0,{},e),"new_edits"in t||(t.new_edits=!0),customApi._bulkDocs(e,t,autoCompact(n))};var taskqueue={};taskqueue.ready=!1,taskqueue.queue=[],api.taskqueue={},api.taskqueue.execute=function(e){taskqueue.ready&&taskqueue.queue.forEach(function(t){t.task=e[t.name].apply(null,t.parameters)})},api.taskqueue.ready=function(){return 0===arguments.length?taskqueue.ready:(taskqueue.ready=arguments[0],void 0)},api.taskqueue.addTask=function(e,t){var n={name:e,parameters:t};return taskqueue.queue.push(n),n},api.replicate={},api.replicate.from=function(e,t,n){return"function"==typeof t&&(n=t,t={}),Pouch.replicate(e,customApi,t,n)},api.replicate.to=function(e,t,n){return"function"==typeof t&&(n=t,t={}),Pouch.replicate(customApi,e,t,n)};for(var j in api)customApi.hasOwnProperty(j)||(customApi[j]=api[j]);return opts.skipSetup&&(api.taskqueue.ready(!0),api.taskqueue.execute(api)),utils.isCordova()&&cordova.fireWindowEvent(opts.name+"_pouch",{}),customApi}}},{"./deps/errors":8,"./merge":13,"./utils":16}],2:[function(e,t){"use strict";function n(e){for(var t=n.options,r=t.parser[t.strictMode?"strict":"loose"].exec(e),o={},i=14;i--;)o[t.key[i]]=r[i]||"";return o[t.q.name]={},o[t.key[12]].replace(t.q.parser,function(e,n,r){n&&(o[t.q.name][n]=r)}),o}function r(e){return/^_(design|local)/.test(e)?e:encodeURIComponent(e)}function o(e,t){if(/http(s?):/.test(e)){var r=n(e);r.remote=!0,(r.user||r.password)&&(r.auth={username:r.user,password:r.password});var o=r.path.replace(/(^\/|\/$)/g,"").split("/");if(r.db=o.pop(),r.path=o.join("/"),t=t||{},r.headers=t.headers||{},t.auth||r.auth){var i=t.auth||r.auth,a=u.btoa(i.username+":"+i.password);r.headers.Authorization="Basic "+a}return t.headers&&(r.headers=t.headers),r}return{host:"",path:"/",db:e,auth:!1}}function i(e,t){if(e.remote){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+e.db+"/"+t}return"/"+e.db+"/"+t}function a(e,t){if(e.remote){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+t}return"/"+t}function s(e,t){function n(e,t){return u.ajax(u.extend({},f,e),t)}var s=o(e.name,e),d=i(s,""),l={},f=e.ajax||{},p={list:[],get:function(e,t){"function"==typeof e&&(t=e,e={count:10});var r=function(e,n){!e&&"uuids"in n?(p.list=p.list.concat(n.uuids),u.call(t,null,"OK")):u.call(t,e||c.UNKNOWN_ERROR)},o="?count="+e.count;n({headers:s.headers,method:"GET",url:a(s,"_uuids")+o},r)}},v=function(){n({headers:s.headers,method:"PUT",url:d},function(e){e&&401===e.status?n({headers:s.headers,method:"HEAD",url:d},function(e){e?u.call(t,e):u.call(t,null,l)}):e&&412!==e.status?u.call(t,c.UNKNOWN_ERROR):u.call(t,null,l)})};return e.skipSetup||n({headers:s.headers,method:"GET",url:d},function(e){e?404===e.status?v():u.call(t,e):u.call(t,null,l)}),l.type=function(){return"http"},l.id=function(){return i(s,"")},l.request=function(e,t){return l.taskqueue.ready()?(e.headers=s.headers,e.url=i(s,e.url),n(e,t),void 0):(l.taskqueue.addTask("request",arguments),void 0)},l.compact=function(e,t){return l.taskqueue.ready()?("function"==typeof e&&(t=e,e={}),n({headers:s.headers,url:i(s,"_compact"),method:"POST"},function(){function n(){l.info(function(r,o){o.compact_running?setTimeout(n,e.interval||200):u.call(t,null)})}"function"==typeof t&&n()}),void 0):(l.taskqueue.addTask("compact",arguments),void 0)},l.info=function(e){return l.taskqueue.ready()?(n({headers:s.headers,method:"GET",url:i(s,"")},e),void 0):(l.taskqueue.addTask("info",arguments),void 0)},l.get=function(e,t,o){if(!l.taskqueue.ready())return l.taskqueue.addTask("get",arguments),void 0;"function"==typeof t&&(o=t,t={}),void 0===t.auto_encode&&(t.auto_encode=!0);var a=[];t.revs&&a.push("revs=true"),t.revs_info&&a.push("revs_info=true"),t.local_seq&&a.push("local_seq=true"),t.open_revs&&("all"!==t.open_revs&&(t.open_revs=JSON.stringify(t.open_revs)),a.push("open_revs="+t.open_revs)),t.attachments&&a.push("attachments=true"),t.rev&&a.push("rev="+t.rev),t.conflicts&&a.push("conflicts="+t.conflicts),a=a.join("&"),a=""===a?"":"?"+a,t.auto_encode&&(e=r(e));var c={headers:s.headers,method:"GET",url:i(s,e+a)},d=e.split("/");(d.length>1&&"_design"!==d[0]&&"_local"!==d[0]||d.length>2&&"_design"===d[0]&&"_local"!==d[0])&&(c.binary=!0),n(c,function(e,t,n){return e?u.call(o,e):(u.call(o,null,t,n),void 0)})},l.remove=function(e,t,o){return l.taskqueue.ready()?("function"==typeof t&&(o=t,t={}),n({headers:s.headers,method:"DELETE",url:i(s,r(e._id))+"?rev="+e._rev},o),void 0):(l.taskqueue.addTask("remove",arguments),void 0)},l.getAttachment=function(e,t,n,o){"function"==typeof n&&(o=n,n={}),void 0===n.auto_encode&&(n.auto_encode=!0),n.auto_encode&&(e=r(e)),n.auto_encode=!1,l.get(e+"/"+t,n,o)},l.removeAttachment=function(e,t,o,a){return l.taskqueue.ready()?(n({headers:s.headers,method:"DELETE",url:i(s,r(e)+"/"+t)+"?rev="+o},a),void 0):(l.taskqueue.addTask("removeAttachment",arguments),void 0)},l.putAttachment=function(e,t,o,a,u,c){if(!l.taskqueue.ready())return l.taskqueue.addTask("putAttachment",arguments),void 0;"function"==typeof u&&(c=u,u=a,a=o,o=null),"undefined"==typeof u&&(u=a,a=o,o=null);var d=r(e)+"/"+t,f=i(s,d);o&&(f+="?rev="+o);var p={headers:s.headers,method:"PUT",url:f,processData:!1,body:a,timeout:6e4};p.headers["Content-Type"]=u,n(p,c)},l.put=function(e,t,o){if(!l.taskqueue.ready())return l.taskqueue.addTask("put",arguments),void 0;if("function"==typeof t&&(o=t,t={}),"object"!=typeof e)return u.call(o,c.NOT_AN_OBJECT);if(!u.isValidId(e._id))return u.call(o,c.MISSING_ID);var a=[];t&&"undefined"!=typeof t.new_edits&&a.push("new_edits="+t.new_edits),a=a.join("&"),""!==a&&(a="?"+a),n({headers:s.headers,method:"PUT",url:i(s,r(e._id))+a,body:e},o)},l.post=function(e,t,n){return l.taskqueue.ready()?("function"==typeof t&&(n=t,t={}),"object"!=typeof e?u.call(n,c.NOT_AN_OBJECT):("_id"in e?l.put(e,t,n):p.list.length>0?(e._id=p.list.pop(),l.put(e,t,n)):p.get(function(r){return r?u.call(n,c.UNKNOWN_ERROR):(e._id=p.list.pop(),l.put(e,t,n),void 0)}),void 0)):(l.taskqueue.addTask("post",arguments),void 0)},l.bulkDocs=function(e,t,r){return l.taskqueue.ready()?("function"==typeof t&&(r=t,t={}),t||(t={}),"undefined"!=typeof t.new_edits&&(e.new_edits=t.new_edits),n({headers:s.headers,method:"POST",url:i(s,"_bulk_docs"),body:e},r),void 0):(l.taskqueue.addTask("bulkDocs",arguments),void 0)},l.allDocs=function(e,t){if(!l.taskqueue.ready())return l.taskqueue.addTask("allDocs",arguments),void 0;"function"==typeof e&&(t=e,e={});var r,o=[],a="GET";e.conflicts&&o.push("conflicts=true"),e.descending&&o.push("descending=true"),e.include_docs&&o.push("include_docs=true"),e.startkey&&o.push("startkey="+encodeURIComponent(JSON.stringify(e.startkey))),e.endkey&&o.push("endkey="+encodeURIComponent(JSON.stringify(e.endkey))),e.limit&&o.push("limit="+e.limit),"undefined"!=typeof e.skip&&o.push("skip="+e.skip),o=o.join("&"),""!==o&&(o="?"+o),"undefined"!=typeof e.keys&&(a="POST",r=JSON.stringify({keys:e.keys})),n({headers:s.headers,method:a,url:i(s,"_all_docs"+o),body:r},t)},l.changes=function(e){var t=25;if(!l.taskqueue.ready()){var r=l.taskqueue.addTask("changes",arguments);return{cancel:function(){return r.task?r.task.cancel():(r.parameters[0].aborted=!0,void 0)}}}if("latest"===e.since){var o;return l.info(function(t,n){e.aborted||(e.since=n.update_seq,o=l.changes(e))}),{cancel:function(){return o?o.cancel():(e.aborted=!0,void 0)}}}var a={},d="undefined"!=typeof e.limit?e.limit:!1;0===d&&(d=1);var f=d;if(e.style&&(a.style=e.style),(e.include_docs||e.filter&&"function"==typeof e.filter)&&(a.include_docs=!0),e.continuous&&(a.feed="longpoll"),e.conflicts&&(a.conflicts=!0),e.descending&&(a.descending=!0),e.filter&&"string"==typeof e.filter&&(a.filter=e.filter,"_view"===e.filter&&e.view&&"string"==typeof e.view&&(a.view=e.view)),e.query_params&&"object"==typeof e.query_params)for(var p in e.query_params)e.query_params.hasOwnProperty(p)&&(a[p]=e.query_params[p]);var v,_,h,m,g=function(r,o){a.since=r,e.continuous||m||(m=h),a.limit=!d||f>t?t:f;var u="?"+Object.keys(a).map(function(e){return e+"="+a[e]}).join("&"),c={headers:s.headers,method:"GET",url:i(s,"_changes"+u),timeout:null};_=r,e.aborted||(v=n(c,o))},y=10,b=0,w={results:[]},k=function(n,r){if(r&&r.results){w.last_seq=r.last_seq;var o={};o.query=e.query_params,r.results=r.results.filter(function(t){f--;var n=u.filterChange(e)(t);return n&&(w.results.push(t),u.call(e.onChange,t)),n})}else n&&(e.aborted=!0,u.call(e.complete,n,null));r&&r.last_seq&&(_=r.last_seq);var i=r&&r.results.length||0;m-=t;var a=d&&0>=f||r&&!i&&0>=m||i&&r.last_seq===h||e.descending&&0!==_;if(e.continuous||!a){n?b+=1:b=0;var s=1<<b,l=y*s,p=e.maximumWait||3e4;l>p&&u.call(e.complete,n||c.UNKNOWN_ERROR,null),setTimeout(function(){g(_,k)},l)}else u.call(e.complete,null,w)};return e.continuous?g(e.since||0,k):l.info(function(t,n){return t?u.call(e.complete,t):(h=n.update_seq,g(e.since||0,k),void 0)}),{cancel:function(){e.aborted=!0,v.abort()}}},l.revsDiff=function(e,t,r){return l.taskqueue.ready()?("function"==typeof t&&(r=t,t={}),n({headers:s.headers,method:"POST",url:i(s,"_revs_diff"),body:e},function(e,t){u.call(r,e,t)}),void 0):(l.taskqueue.addTask("revsDiff",arguments),void 0)},l.close=function(e){return l.taskqueue.ready()?(u.call(e,null),void 0):(l.taskqueue.addTask("close",arguments),void 0)},l.replicateOnServer=function(e,r,i){if(!l.taskqueue.ready())return l.taskqueue.addTask("replicateOnServer",arguments),i;var a=o(e.id()),c={source:s.db,target:a.protocol===s.protocol&&a.authority===s.authority?a.db:a.source};r.continuous&&(c.continuous=!0),r.create_target&&(c.create_target=!0),r.doc_ids&&(c.doc_ids=r.doc_ids),r.filter&&"string"==typeof r.filter&&(c.filter=r.filter),r.query_params&&(c.query_params=r.query_params);var d,f={},p={headers:s.headers,method:"POST",url:s.protocol+"://"+s.host+(80===s.port?"":":"+s.port)+"/_replicate",body:c};i.cancel=function(){this.cancelled=!0,d&&!f.ok&&d.abort(),f._local_id&&(p.body={replication_id:f._local_id}),p.body.cancel=!0,n(p,function(e,n,o){return e?u.call(t,e):(u.call(r.complete,null,f,o),void 0)})},i.cancelled||(d=n(p,function(e,n,o){return e?u.call(t,e):(f.ok=!0,n._local_id&&(f._local_id=n._local_id),u.call(r.complete,null,n,o),void 0)}))},l}var u=e("../utils"),c=e("../deps/errors");n.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},s.destroy=function(e,t,n){var r=o(e,t);t=t||{},"function"==typeof t&&(n=t,t={}),t.headers=r.headers,t.method="DELETE",t.url=i(r,""),u.ajax(t,n)},s.valid=function(){return!0},t.exports=s},{"../deps/errors":8,"../utils":16}],3:[function(e,t){"use strict";function n(e){return function(t){o.call(e,a.error(a.IDB_ERROR,t.target,t.type))}}function r(e,t){function s(e){e.createObjectStore(l,{keyPath:"id"}).createIndex("seq","seq",{unique:!0}),e.createObjectStore(f,{autoIncrement:!0}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0}),e.createObjectStore(p,{keyPath:"digest"}),e.createObjectStore(v,{keyPath:"id",autoIncrement:!1}),e.createObjectStore(_)}function u(e){for(var t=e.length,n=new ArrayBuffer(t),r=new Uint8Array(n),o=0;t>o;o++)r[o]=e.charCodeAt(o);return n}function c(e,t){return e._bulk_seq-t._bulk_seq}var d=1,l="document-store",f="by-sequence",p="attach-store",v="meta-store",_="detect-blob-support",h=e.name,m=window.indexedDB.open(h,d);"openReqList"in r||(r.openReqList={}),r.openReqList[h]=m;var g=null,y=null,b={},w=null;return m.onupgradeneeded=function(e){for(var t=e.target.result,n=e.oldVersion;n!==e.newVersion;)0===n&&s(t),n++},m.onsuccess=function(e){w=e.target.result,w.onversionchange=function(){w.close()};var n=w.transaction([v,_],"readwrite"),r=n.objectStore(v).get(v);r.onsuccess=function(e){var r=e.target.result||{id:v};h+"_id"in r?y=r[h+"_id"]:(y=o.uuid(),r[h+"_id"]=y,n.objectStore(v).put(r));try{n.objectStore(_).put(o.createBlob(),"key"),g=!0}catch(i){g=!1}finally{o.call(t,null,b)}}},m.onerror=n(t),b.type=function(){return"idb"},b.id=function(){return y},b._bulkDocs=function(e,t,s){function d(e){var t=e.target.result;t.updateSeq=(t.updateSeq||0)+A,N.objectStore(v).put(t)}function _(){if(!C.length)return N.objectStore(v).get(v).onsuccess=d,void 0;var e=C.shift(),t=N.objectStore(l).get(e.metadata.id);t.onsuccess=function(t){var n=t.target.result;n?q(n,e):S(e)}}function m(){var e=[];I.sort(c),I.forEach(function(t){if(delete t._bulk_seq,t.error)return e.push(t),void 0;var n=t.metadata,a=i.winningRev(n);e.push({ok:!0,id:n.id,rev:a}),o.isLocalId(n.id)||(r.Changes.notify(h),r.Changes.notifyLocalWindows(h))}),o.call(s,null,e)}function y(e,t){if(e.stub)return t();if("string"==typeof e.data){var n;try{n=atob(e.data)}catch(r){var i=a.error(a.BAD_ARG,"Attachments need to be base64 encoded");return o.call(s,i)}if(e.digest="md5-"+o.Crypto.MD5(n),g){var c=e.content_type;n=u(n),e.data=o.createBlob([n],{type:c})}return t()}var d=new FileReader;d.onloadend=function(){e.digest="md5-"+o.Crypto.MD5(this.result),g||(e.data=btoa(this.result)),t()},d.readAsBinaryString(e.data)}function b(e){function t(){n++,C.length===n&&e()}if(!C.length)return e();var n=0;C.forEach(function(e){function n(){o++,o===r.length&&t()}var r=e.data&&e.data._attachments?Object.keys(e.data._attachments):[];if(!r.length)return t();var o=0;for(var i in e.data._attachments)y(e.data._attachments[i],n)})}function k(e,t){function n(e){a||(e?(a=e,o.call(t,a)):s===u.length&&i())}function r(e){s++,n(e)}function i(){e.data._doc_id_rev=e.data._id+"::"+e.data._rev;var n=N.objectStore(f).put(e.data);n.onsuccess=function(n){e.metadata.seq=n.target.result,delete e.metadata.rev;var r=N.objectStore(l).put(e.metadata);r.onsuccess=function(){I.push(e),o.call(t)}}}var a=null,s=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,A++,o.isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var u=e.data._attachments?Object.keys(e.data._attachments):[];for(var c in e.data._attachments)if(e.data._attachments[c].stub)s++,n();else{var d=e.data._attachments[c].data;delete e.data._attachments[c].data;var p=e.data._attachments[c].digest;R(e,p,d,r)}u.length||i()}function q(e,t){var n=i.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),r=o.isDeleted(e),s=r&&o.isDeleted(t.metadata)||!r&&O&&"new_leaf"!==n.conflicts;return s?(I.push(E(a.REV_CONFLICT,t._bulk_seq)),_()):(t.metadata.rev_tree=n.tree,k(t,_),void 0)}function S(e){return"was_delete"in t&&o.isDeleted(e.metadata)?(I.push(a.MISSING_DOC),_()):(k(e,_),void 0)}function E(e,t){return e._bulk_seq=t,e}function R(e,t,n,r){{var i=N.objectStore(p);i.get(t).onsuccess=function(a){var s=a.target.result&&a.target.result.refs||{},u=[e.metadata.id,e.metadata.rev].join("@"),c={digest:t,body:n,refs:s};c.refs[u]=!0;i.put(c).onsuccess=function(){o.call(r)}}}}var O=t.new_edits,T=e.docs,C=T.map(function(e,t){var n=o.parseDoc(e,O);return n._bulk_seq=t,n}),D=C.filter(function(e){return e.error});if(D.length)return o.call(s,D[0]);var N,I=[],A=0;b(function(){N=w.transaction([l,f,p,v],"readwrite"),N.onerror=n(s),N.ontimeout=n(s),N.oncomplete=m,_()})},b._get=function(e,t,n){function r(){o.call(n,c,{doc:s,metadata:u,ctx:d})}var s,u,c,d;d=t.ctx?t.ctx:w.transaction([l,f,p],"readonly"),d.objectStore(l).get(e).onsuccess=function(e){if(u=e.target.result,!u)return c=a.MISSING_DOC,r();if(o.isDeleted(u)&&!t.rev)return c=a.error(a.MISSING_DOC,"deleted"),r();var n=i.winningRev(u),l=u.id+"::"+(t.rev?t.rev:n),p=d.objectStore(f).index("_doc_id_rev");p.get(l).onsuccess=function(e){return s=e.target.result,s&&s._doc_id_rev&&delete s._doc_id_rev,s?(r(),void 0):(c=a.MISSING_DOC,r())}}},b._getAttachment=function(e,t,n){var r,i;i=t.ctx?t.ctx:w.transaction([l,f,p],"readonly");var a=e.digest,s=e.content_type;i.objectStore(p).get(a).onsuccess=function(e){var i=e.target.result.body;if(t.encode)if(g){var a=new FileReader;a.onloadend=function(){r=btoa(this.result),o.call(n,null,r)},a.readAsBinaryString(i)}else r=i,o.call(n,null,r);else g?r=i:(i=u(atob(i)),r=o.createBlob([i],{type:s})),o.call(n,null,r)}},b._allDocs=function(e,t){var n="startkey"in e?e.startkey:!1,r="endkey"in e?e.endkey:!1,a="descending"in e?e.descending:!1;a=a?"prev":null;var s=n&&r?window.IDBKeyRange.bound(n,r):n?window.IDBKeyRange.lowerBound(n):r?window.IDBKeyRange.upperBound(r):null,u=w.transaction([l,f],"readonly");u.oncomplete=function(){"keys"in e&&(e.keys.forEach(function(e){e in v?p.push(v[e]):p.push({key:e,error:"not_found"})}),e.descending&&p.reverse()),o.call(t,null,{total_rows:p.length,offset:e.skip,rows:"limit"in e?p.slice(e.skip,e.limit+e.skip):e.skip>0?p.slice(e.skip):p})};var c=u.objectStore(l),d=a?c.openCursor(s,a):c.openCursor(s),p=[],v={};d.onsuccess=function(t){function n(t,n){if(o.isLocalId(t.id))return r["continue"]();var a={id:t.id,key:t.id,value:{rev:i.winningRev(t)}};if(e.include_docs){a.doc=n,a.doc._rev=i.winningRev(t),a.doc._doc_id_rev&&delete a.doc._doc_id_rev,e.conflicts&&(a.doc._conflicts=i.collectConflicts(t));for(var s in a.doc._attachments)a.doc._attachments[s].stub=!0}"keys"in e?e.keys.indexOf(t.id)>-1&&(o.isDeleted(t)&&(a.value.deleted=!0,a.doc=null),v[a.id]=a):o.isDeleted(t)||p.push(a),r["continue"]()}if(t.target.result){var r=t.target.result,a=r.value;if(e.include_docs){var s=u.objectStore(f).index("_doc_id_rev"),c=i.winningRev(a),d=a.id+"::"+c;s.get(d).onsuccess=function(e){n(r.value,e.target.result)}}else n(a)}}},b._info=function(e){function t(e){o=e.target.result&&e.target.result.updateSeq||0}function n(e){var n=e.target.result;return n?(n.value.deleted!==!0&&r++,n["continue"](),void 0):(i.objectStore(v).get(v).onsuccess=t,void 0)}var r=0,o=0,i=w.transaction([l,v],"readonly");i.oncomplete=function(){e(null,{db_name:h,doc_count:r,update_seq:o})},i.objectStore(l).openCursor().onsuccess=n},b._changes=function(e){function t(){p=w.transaction([l,f]),p.oncomplete=a;var t;t=c?p.objectStore(f).openCursor(window.IDBKeyRange.lowerBound(e.since,!0),c):p.objectStore(f).openCursor(window.IDBKeyRange.lowerBound(e.since,!0)),t.onsuccess=n,t.onerror=s}function n(t){if(!t.target.result){for(var n=0,r=v.length;r>n;n++){var a=v[n];a&&m.push(a)}return!1}var s=t.target.result,u=s.value._id,c=_[u];if(void 0!==c)return v[c].seq=s.key,v.push(v[c]),v[c]=null,_[u]=v.length-1,s["continue"]();var h=p.objectStore(l);h.get(s.value._id).onsuccess=function(t){var n=t.target.result;if(o.isLocalId(n.id))return s["continue"]();d<n.seq&&(d=n.seq);var r=i.winningRev(n),a=n.id+"::"+r,u=p.objectStore(f).index("_doc_id_rev");u.get(a).onsuccess=function(t){var o=t.target.result;delete o._doc_id_rev,o._rev=r;var i=e.processChange(o,n,e);i.seq=s.key;var a=i.id,u=_[a];void 0!==u&&(v[u]=null),v.push(i),_[a]=v.length-1,s["continue"]()}}}function a(){o.processChanges(e,m,d)}function s(){o.call(e.complete)}if(e.continuous){var u=h+":"+o.uuid();return e.cancelled=!1,r.Changes.addListener(h,u,b,e),r.Changes.notify(h),{cancel:function(){e.cancelled=!0,r.Changes.removeListener(h,u)}}}var c=e.descending?"prev":null,d=0;e.since=e.since&&!c?e.since:0;var p,v=[],_={},m=[];t()},b._close=function(e){return null===w?o.call(e,a.NOT_OPEN):(w.close(),o.call(e,null),void 0)},b._getRevisionTree=function(e,t){var n=w.transaction([l],"readonly"),r=n.objectStore(l).get(e);r.onsuccess=function(e){var n=e.target.result;n?o.call(t,null,n.rev_tree):o.call(t,a.MISSING_DOC)}},b._doCompaction=function(e,t,n,r){var i=w.transaction([l,f],"readwrite"),a=i.objectStore(l);a.get(e).onsuccess=function(r){var o=r.target.result;o.rev_tree=t;var a=n.length;n.forEach(function(t){var n=i.objectStore(f).index("_doc_id_rev"),r=e+"::"+t;n.getKey(r).onsuccess=function(e){var t=e.target.result;if(t){{i.objectStore(f)["delete"](t)}a--,a||i.objectStore(l).put(o)}}})},i.oncomplete=function(){o.call(r)}},b}var o=e("../utils"),i=e("../merge"),a=e("../deps/errors");r.valid=function(){return"undefined"!=typeof window&&!!window.indexedDB},r.destroy=function(e,t,i){"openReqList"in r||(r.openReqList={}),r.Changes.clearListeners(e),r.openReqList[e]&&r.openReqList[e].result&&r.openReqList[e].result.close();var a=window.indexedDB.deleteDatabase(e);a.onsuccess=function(){r.openReqList[e]&&(r.openReqList[e]=null),o.call(i,null)},a.onerror=n(i)},r.Changes=new o.Changes,t.exports=r},{"../deps/errors":8,"../merge":13,"../utils":16}],4:[function(e,t){"use strict";function n(e){return"'"+e+"'"}function r(){return"undefined"!=typeof window?window.navigator&&window.navigator.sqlitePlugin&&window.navigator.sqlitePlugin.openDatabase?navigator.sqlitePlugin.openDatabase.apply(navigator.sqlitePlugin,arguments):window.sqlitePlugin&&window.sqlitePlugin.openDatabase?window.sqlitePlugin.openDatabase.apply(window.sqlitePlugin,arguments):window.openDatabase.apply(window,arguments):void 0}function o(e){return function(t){a.call(e,{status:500,error:t.type,reason:t.target})}}function i(e,t){function _(){t(null,m)}function h(){b.transaction(function(e){var t="CREATE TABLE IF NOT EXISTS "+v+" (update_seq, dbid)",n="CREATE TABLE IF NOT EXISTS "+p+" (digest, json, body BLOB)",r="CREATE TABLE IF NOT EXISTS "+l+" (id unique, seq, json, winningseq)",o="CREATE TABLE IF NOT EXISTS "+f+" (seq INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, doc_id_rev UNIQUE, json)";e.executeSql(n),e.executeSql(r),e.executeSql(o),e.executeSql(t);var i="SELECT update_seq FROM "+v;e.executeSql(i,[],function(e,t){if(!t.rows.length){var n="INSERT INTO "+v+" (update_seq) VALUES (?)";return e.executeSql(n,[0]),void 0}});var s="SELECT dbid FROM "+v+" WHERE dbid IS NOT NULL";
e.executeSql(s,[],function(e,t){if(!t.rows.length){var n="UPDATE "+v+" SET dbid=?";return g=a.uuid(),e.executeSql(n,[g]),void 0}g=t.rows.item(0).dbid})},o(t),_)}var m={},g=null,y=e.name,b=r(y,c,y,d);return b?(a.isCordova()&&"undefined"!=typeof window?window.addEventListener(y+"_pouch",function w(){window.removeEventListener(y+"_pouch",w,!1),h()},!1):h(),m.type=function(){return"websql"},m.id=function(){return g},m._info=function(e){b.transaction(function(t){var n="SELECT COUNT(id) AS count FROM "+l;t.executeSql(n,[],function(t,n){var r=n.rows.item(0).count,o="SELECT update_seq FROM "+v;t.executeSql(o,[],function(t,n){var o=n.rows.item(0).update_seq;e(null,{db_name:y,doc_count:r,update_seq:o})})})})},m._bulkDocs=function(e,t,r){function c(e,t){return e._bulk_seq-t._bulk_seq}function d(){var e=[];I.sort(c),I.forEach(function(t){if(delete t._bulk_seq,t.error)return e.push(t),void 0;var n=t.metadata,r=s.winningRev(n);e.push({ok:!0,id:n.id,rev:r}),a.isLocalId(n.id)||(T++,i.Changes.notify(y),i.Changes.notifyLocalWindows(y))});var t="SELECT update_seq FROM "+v;N.executeSql(t,[],function(t,n){var o=n.rows.item(0).update_seq+T,i="UPDATE "+v+" SET update_seq=?";t.executeSql(i,[o],function(){a.call(r,null,e)})})}function _(e,t){if(e.stub)return t();if("string"==typeof e.data){try{e.data=atob(e.data)}catch(n){var o=u.error(u.BAD_ARG,"Attachments need to be base64 encoded");return a.call(r,o)}return e.digest="md5-"+a.Crypto.MD5(e.data),t()}var i=new FileReader;i.onloadend=function(){e.data=this.result,e.digest="md5-"+a.Crypto.MD5(this.result),t()},i.readAsBinaryString(e.data)}function h(e){function t(){n++,C.length===n&&e()}if(!C.length)return e();var n=0,r=0;C.forEach(function(e){function n(){r++,r===o.length&&t()}var o=e.data&&e.data._attachments?Object.keys(e.data._attachments):[];if(!o.length)return t();for(var i in e.data._attachments)_(e.data._attachments[i],n)})}function m(e,t,n){function r(){var t=e.data,n="INSERT INTO "+f+" (doc_id_rev, json) VALUES (?, ?);";N.executeSql(n,[t._id+"::"+t._rev,JSON.stringify(t)],u)}function o(e){c||(e?(c=e,a.call(t,c)):d===p.length&&r())}function i(e){d++,o(e)}function u(r,o){var i=e.metadata.seq=o.insertId;delete e.metadata.rev;var u=s.winningRev(e.metadata),c=n?"UPDATE "+l+" SET seq=?, json=?, winningseq=(SELECT seq FROM "+f+" WHERE doc_id_rev=?) WHERE id=?":"INSERT INTO "+l+" (id, seq, winningseq, json) VALUES (?, ?, ?, ?);",d=JSON.stringify(e.metadata),p=e.metadata.id+"::"+u,v=n?[i,d,p,e.metadata.id]:[e.metadata.id,i,i,d];r.executeSql(c,v,function(){I.push(e),a.call(t,null)})}var c=null,d=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,a.isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var p=e.data._attachments?Object.keys(e.data._attachments):[];for(var v in e.data._attachments)if(e.data._attachments[v].stub)d++,o();else{var _=e.data._attachments[v].data;delete e.data._attachments[v].data;var h=e.data._attachments[v].digest;S(e,h,_,i)}p.length||r()}function g(e,t){var n=s.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),r=a.isDeleted(e)&&a.isDeleted(t.metadata)||!a.isDeleted(e)&&R&&"new_leaf"!==n.conflicts;return r?(I.push(q(u.REV_CONFLICT,t._bulk_seq)),k()):(t.metadata.rev_tree=n.tree,m(t,k,!0),void 0)}function w(e){return"was_delete"in t&&a.isDeleted(e.metadata)?(I.push(u.MISSING_DOC),k()):(m(e,k,!1),void 0)}function k(){if(!C.length)return d();var e=C.shift(),t=e.metadata.id;t in A?g(A[t],e):(A[t]=e.metadata,w(e))}function q(e,t){return e._bulk_seq=t,e}function S(e,t,n,r){var o=[e.metadata.id,e.metadata.rev].join("@"),i={digest:t},s="SELECT digest, json FROM "+p+" WHERE digest=?";N.executeSql(s,[t],function(e,u){u.rows.length?(i.refs=JSON.parse(u.rows.item(0).json).refs,s="UPDATE "+p+" SET json=?, body=? WHERE digest=?",e.executeSql(s,[JSON.stringify(i),n,t],function(){a.call(r,null)})):(i.refs={},i.refs[o]=!0,s="INSERT INTO "+p+"(digest, json, body) VALUES (?, ?, ?)",e.executeSql(s,[t,JSON.stringify(i),n],function(){a.call(r,null)}))})}function E(e,t){for(var n=0;n<t.rows.length;n++){var r=t.rows.item(n);A[r.id]=JSON.parse(r.json)}k()}var R=t.new_edits,O=e.docs,T=0,C=O.map(function(e,t){var n=a.parseDoc(e,R);return n._bulk_seq=t,n}),D=C.filter(function(e){return e.error});if(D.length)return a.call(r,D[0]);var N,I=[],A={};h(function(){b.transaction(function(e){N=e;var t="("+C.map(function(e){return n(e.metadata.id)}).join(",")+")",r="SELECT * FROM "+l+" WHERE id IN "+t;N.executeSql(r,[],E)},o(r))})},m._get=function(e,t,n){function r(){a.call(n,c,{doc:o,metadata:i,ctx:d})}var o,i,c;if(!t.ctx)return b.transaction(function(r){t.ctx=r,m._get(e,t,n)}),void 0;var d=t.ctx,p="SELECT * FROM "+l+" WHERE id=?";d.executeSql(p,[e],function(e,n){if(!n.rows.length)return c=u.MISSING_DOC,r();if(i=JSON.parse(n.rows.item(0).json),a.isDeleted(i)&&!t.rev)return c=u.error(u.MISSING_DOC,"deleted"),r();var l=s.winningRev(i),p=t.rev?t.rev:l;p=i.id+"::"+p;var v="SELECT * FROM "+f+" WHERE doc_id_rev=?";d.executeSql(v,[p],function(e,t){return t.rows.length?(o=JSON.parse(t.rows.item(0).json),r(),void 0):(c=u.MISSING_DOC,r())})})},m._allDocs=function(e,t){var n=[],r={},i="startkey"in e?e.startkey:!1,u="endkey"in e?e.endkey:!1,c="descending"in e?e.descending:!1,d="SELECT "+l+".id, "+f+".seq, "+f+".json AS data, "+l+".json AS metadata FROM "+f+" JOIN "+l+" ON "+f+".seq = "+l+".winningseq",p=[];"keys"in e?(d+=" WHERE "+l+".id IN ("+e.keys.map(function(){return"?"}).join(",")+")",p=p.concat(e.keys)):(i&&(d+=" WHERE "+l+".id >= ?",p.push(i)),u&&(d+=(i?" AND ":" WHERE ")+l+".id <= ?",p.push(u)),d+=" ORDER BY "+l+".id "+(c?"DESC":"ASC")),b.transaction(function(t){t.executeSql(d,p,function(t,o){for(var i=0,u=o.rows.length;u>i;i++){var c=o.rows.item(i),d=JSON.parse(c.metadata),l=JSON.parse(c.data);if(!a.isLocalId(d.id)){if(c={id:d.id,key:d.id,value:{rev:s.winningRev(d)}},e.include_docs){c.doc=l,c.doc._rev=s.winningRev(d),e.conflicts&&(c.doc._conflicts=s.collectConflicts(d));for(var f in c.doc._attachments)c.doc._attachments[f].stub=!0}"keys"in e?e.keys.indexOf(d.id)>-1&&(a.isDeleted(d)&&(c.value.deleted=!0,c.doc=null),r[c.id]=c):a.isDeleted(d)||n.push(c)}}})},o(t),function(){"keys"in e&&(e.keys.forEach(function(e){e in r?n.push(r[e]):n.push({key:e,error:"not_found"})}),e.descending&&n.reverse()),a.call(t,null,{total_rows:n.length,offset:e.skip,rows:"limit"in e?n.slice(e.skip,e.limit+e.skip):e.skip>0?n.slice(e.skip):n})})},m._changes=function(e){function t(){var t="SELECT "+l+".id, "+f+".seq, "+f+".json AS data, "+l+".json AS metadata FROM "+f+" JOIN "+l+" ON "+f+".seq = "+l+".winningseq WHERE "+l+".seq > "+e.since+" ORDER BY "+l+".seq "+(r?"DESC":"ASC");b.transaction(function(n){n.executeSql(t,[],function(t,n){for(var r=0,i=0,s=n.rows.length;s>i;i++){var u=n.rows.item(i),c=JSON.parse(u.metadata);if(!a.isLocalId(c.id)){r<u.seq&&(r=u.seq);var d=JSON.parse(u.data),l=e.processChange(d,c,e);l.seq=u.seq,o.push(l)}}a.processChanges(e,o,r)})})}if(e.continuous){var n=y+":"+a.uuid();return e.cancelled=!1,i.Changes.addListener(y,n,m,e),i.Changes.notify(y),{cancel:function(){e.cancelled=!0,i.Changes.removeListener(y,n)}}}var r=e.descending;e.since=e.since&&!r?e.since:0;var o=[];t()},m._close=function(e){a.call(e,null)},m._getAttachment=function(e,t,n){var r,o=t.ctx,i=e.digest,s=e.content_type,u="SELECT body FROM "+p+" WHERE digest=?";o.executeSql(u,[i],function(e,o){var i=o.rows.item(0).body;r=t.encode?btoa(i):a.createBlob([i],{type:s}),a.call(n,null,r)})},m._getRevisionTree=function(e,t){b.transaction(function(n){var r="SELECT json AS metadata FROM "+l+" WHERE id = ?";n.executeSql(r,[e],function(e,n){if(n.rows.length){var r=JSON.parse(n.rows.item(0).metadata);a.call(t,null,r.rev_tree)}else a.call(t,u.MISSING_DOC)})})},m._doCompaction=function(e,t,r,o){b.transaction(function(i){var s="SELECT json AS metadata FROM "+l+" WHERE id = ?";i.executeSql(s,[e],function(i,s){if(!s.rows.length)return a.call(o);var u=JSON.parse(s.rows.item(0).metadata);u.rev_tree=t;var c="DELETE FROM "+f+" WHERE doc_id_rev IN ("+r.map(function(t){return n(e+"::"+t)}).join(",")+")";i.executeSql(c,[],function(t){var n="UPDATE "+l+" SET json = ? WHERE id = ?";t.executeSql(n,[JSON.stringify(u),e],function(){o()})})})})},m):a.call(t,u.UNKNOWN_ERROR)}var a=e("../utils"),s=e("../merge"),u=e("../deps/errors"),c=1,d=5242880,l=n("document-store"),f=n("by-sequence"),p=n("attach-store"),v=n("metadata-store");i.valid=function(){if("undefined"!=typeof window){if(window.navigator&&window.navigator.sqlitePlugin&&window.navigator.sqlitePlugin.openDatabase)return!0;if(window.sqlitePlugin&&window.sqlitePlugin.openDatabase)return!0;if(window.openDatabase)return!0}return!1},i.destroy=function(e,t,n){var i=r(e,c,e,d);i.transaction(function(e){e.executeSql("DROP TABLE IF EXISTS "+l,[]),e.executeSql("DROP TABLE IF EXISTS "+f,[]),e.executeSql("DROP TABLE IF EXISTS "+p,[]),e.executeSql("DROP TABLE IF EXISTS "+v,[])},o(n),function(){a.call(n,null)})},i.Changes=new a.Changes,t.exports=i},{"../deps/errors":8,"../merge":13,"../utils":16}],5:[function(e,t){"use strict";function n(e,t,o){if(!(this instanceof n))return new n(e,t,o);("function"==typeof t||"undefined"==typeof t)&&(o=t,t={}),"object"==typeof e&&(t=e,e=void 0),"undefined"==typeof o&&(o=function(){});var i=t.name||e,a=n.parseAdapter(i);if(t.originalName=i,t.name=a.name,t.adapter=t.adapter||a.adapter,!n.adapters[t.adapter])throw"Adapter is missing";if(!n.adapters[t.adapter].valid())throw"Invalid Adapter";var s=new r(t,function(e,t){if(e)return o&&o(e),void 0;for(var r in n.plugins){var i=n.plugins[r](t);for(var a in i)a in t||(t[a]=i[a])}t.taskqueue.ready(!0),t.taskqueue.execute(t),o(null,t)});for(var u in s)this[u]=s[u];for(var c in n.plugins){var d=n.plugins[c](this);for(var l in d)l in this||(this[l]=d[l])}}var r=e("./adapter")(n);t.exports=n},{"./adapter":1}],6:[function(e,t){function n(e,t){function n(e){var t=Array.prototype.slice.call(arguments,1);typeof e==typeof Function&&e.apply(this,t)}function u(t,r,o){if(e.binary||e.json||!e.processData||"string"==typeof t){if(!e.binary&&e.json&&"string"==typeof t)try{t=JSON.parse(t)}catch(i){return n(o,i),void 0}}else t=JSON.stringify(t);Array.isArray(t)&&(t=t.map(function(e){var t;return e.ok?e:e.error&&"conflict"===e.error?(t=s.REV_CONFLICT,t.id=e.id,t):e.missing?(t=s.MISSING_DOC,t.missing=e.missing,t):void 0})),n(o,null,t,r)}function c(e,t){var r,o,i,a;try{r=JSON.parse(e.responseText);for(a in s)if(s[a].name===r.error){i=s[a];break}i=i||s.UNKNOWN_ERROR,o=s.error(i,r.reason)}catch(u){o=s.error(s.UNKNOWN_ERROR)}n(t,o)}"function"==typeof e&&(t=e,e={});var d={method:"GET",headers:{},json:!0,processData:!0,timeout:1e4};if(e=i(!0,d,e),r.browser&&"undefined"!=typeof XMLHttpRequest){var l,f=!1,p=new XMLHttpRequest;p.open(e.method,e.url),p.withCredentials=!0,e.json&&(e.headers.Accept="application/json",e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.body&&e.processData&&"string"!=typeof e.body&&(e.body=JSON.stringify(e.body))),e.binary&&(p.responseType="arraybuffer");var v=function(e,t,n){var r="";if(n){var o=new Date;o.setTime(o.getTime()+24*n*60*60*1e3),r="; expires="+o.toGMTString()}document.cookie=e+"="+t+r+"; path=/"};for(var _ in e.headers)if("Cookie"===_){var h=e.headers[_].split("=");v(h[0],h[1],10)}else p.setRequestHeader(_,e.headers[_]);"body"in e||(e.body=null);var m=function(){f=!0,p.abort(),n(c,p,t)};return p.onreadystatechange=function(){if(4===p.readyState&&!f)if(clearTimeout(l),p.status>=200&&p.status<300){var r;r=e.binary?a([p.response||""],{type:p.getResponseHeader("Content-Type")}):p.responseText,n(u,r,p,t)}else n(c,p,t)},e.timeout>0&&(l=setTimeout(m,e.timeout),p.upload.onprogress=p.onprogress=function(){clearTimeout(l),l=setTimeout(m,e.timeout)}),p.send(e.body),{abort:m}}return e.json&&(e.binary||(e.headers.Accept="application/json"),e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json"),e.binary&&(e.encoding=null,e.json=!1),e.processData||(e.json=!1),o(e,function(r,o,i){if(r)return r.status=o?o.statusCode:400,n(c,r,t);var a,d=o.headers["content-type"],l=i||"";e.binary||!e.json&&e.processData||"object"==typeof l||!(/json/.test(d)||/^[\s]*\{/.test(l)&&/\}[\s]*$/.test(l))||(l=JSON.parse(l)),o.statusCode>=200&&o.statusCode<300?n(u,l,o,t):(e.binary&&(l=JSON.parse(l.toString())),a="missing"===l.reason?s.MISSING_DOC:"no_db_file"===l.reason?s.error(s.DB_MISSING,l.reason):"conflict"===l.error?s.REV_CONFLICT:s.error(s.UNKNOWN_ERROR,l.reason,l.error),a.status=o.statusCode,n(t,a))})}var r=e("__browserify_process"),o=e("request"),i=e("./extend.js"),a=e("./blob.js"),s=e("./errors");t.exports=n},{"./blob.js":7,"./errors":8,"./extend.js":9,__browserify_process:19,request:18}],7:[function(e,t){"use strict";function n(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(n){if("TypeError"!==n.name)throw n;for(var r=window.BlobBuilder||window.MSBlobBuilder||window.MozBlobBuilder||window.WebKitBlobBuilder,o=new r,i=0;i<e.length;i+=1)o.append(e[i]);return o.getBlob(t.type)}}t.exports=n},{}],8:[function(e,t,n){"use strict";function r(e){this.status=e.status,this.name=e.error,this.message=e.reason,this.error=!0}r.prototype=new Error,n.MISSING_BULK_DOCS=new r({status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"}),n.MISSING_DOC=new r({status:404,error:"not_found",reason:"missing"}),n.REV_CONFLICT=new r({status:409,error:"conflict",reason:"Document update conflict"}),n.INVALID_ID=new r({status:400,error:"invalid_id",reason:"_id field must contain a string"}),n.MISSING_ID=new r({status:412,error:"missing_id",reason:"_id is required for puts"}),n.RESERVED_ID=new r({status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."}),n.NOT_OPEN=new r({status:412,error:"precondition_failed",reason:"Database not open so cannot close"}),n.UNKNOWN_ERROR=new r({status:500,error:"unknown_error",reason:"Database encountered an unknown error"}),n.BAD_ARG=new r({status:500,error:"badarg",reason:"Some query argument is invalid"}),n.INVALID_REQUEST=new r({status:400,error:"invalid_request",reason:"Request was invalid"}),n.QUERY_PARSE_ERROR=new r({status:400,error:"query_parse_error",reason:"Some query parameter is invalid"}),n.DOC_VALIDATION=new r({status:500,error:"doc_validation",reason:"Bad special document member"}),n.BAD_REQUEST=new r({status:400,error:"bad_request",reason:"Something wrong with the request"}),n.NOT_AN_OBJECT=new r({status:400,error:"bad_request",reason:"Document must be a JSON object"}),n.DB_MISSING=new r({status:404,error:"not_found",reason:"Database not found"}),n.IDB_ERROR=new r({status:500,error:"indexed_db_went_bad",reason:"unknown"}),n.WSQ_ERROR=new r({status:500,error:"web_sql_went_bad",reason:"unknown"}),n.LDB_ERROR=new r({status:500,error:"levelDB_went_went_bad",reason:"unknown"}),n.error=function(e,t,n){function r(){this.message=t,n&&(this.name=n)}return r.prototype=e,new r(t)}},{}],9:[function(e,t){"use strict";function n(e){return null===e?String(e):"object"==typeof e||"function"==typeof e?s[l.call(e)]||"object":typeof e}function r(e){return null!==e&&e===e.window}function o(e){if(!e||"object"!==n(e)||e.nodeType||r(e))return!1;try{if(e.constructor&&!f.call(e,"constructor")&&!f.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}var o;for(o in e);return void 0===o||f.call(e,o)}function i(e){return"function"===n(e)}function a(){var e,t,n,r,s,u,c=arguments[0]||{},d=1,l=arguments.length,f=!1;for("boolean"==typeof c&&(f=c,c=arguments[1]||{},d=2),"object"==typeof c||i(c)||(c={}),l===d&&(c=this,--d);l>d;d++)if(null!=(e=arguments[d]))for(t in e)n=c[t],r=e[t],c!==r&&(f&&r&&(o(r)||(s=p(r)))?(s?(s=!1,u=n&&p(n)?n:[]):u=n&&o(n)?n:{},c[t]=a(f,u,r)):void 0!==r&&(p(e)&&i(r)||(c[t]=r)));return c}for(var s={},u=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"],c=0;c<u.length;c++){var d=u[c];s["[object "+d+"]"]=d.toLowerCase()}var l=s.toString,f=s.hasOwnProperty,p=Array.isArray||function(e){return"array"===n(e)};t.exports=a},{}],10:[function(e,t,n){var r=e("__browserify_process"),o=e("crypto");n.MD5=function(e){function t(e,t){return e<<t|e>>>32-t}function n(e,t){var n,r,o,i,a;return o=2147483648&e,i=2147483648&t,n=1073741824&e,r=1073741824&t,a=(1073741823&e)+(1073741823&t),n&r?2147483648^a^o^i:n|r?1073741824&a?3221225472^a^o^i:1073741824^a^o^i:a^o^i}function i(e,t,n){return e&t|~e&n}function a(e,t,n){return e&n|t&~n}function s(e,t,n){return e^t^n}function u(e,t,n){return t^(e|~n)}function c(e,r,o,a,s,u,c){return e=n(e,n(n(i(r,o,a),s),c)),n(t(e,u),r)}function d(e,r,o,i,s,u,c){return e=n(e,n(n(a(r,o,i),s),c)),n(t(e,u),r)}function l(e,r,o,i,a,u,c){return e=n(e,n(n(s(r,o,i),a),c)),n(t(e,u),r)}function f(e,r,o,i,a,s,c){return e=n(e,n(n(u(r,o,i),a),c)),n(t(e,s),r)}function p(e){for(var t,n=e.length,r=n+8,o=(r-r%64)/64,i=16*(o+1),a=new Array(i-1),s=0,u=0;n>u;)t=(u-u%4)/4,s=u%4*8,a[t]=a[t]|e.charCodeAt(u)<<s,u++;return t=(u-u%4)/4,s=u%4*8,a[t]=a[t]|128<<s,a[i-2]=n<<3,a[i-1]=n>>>29,a}function v(e){var t,n,r="",o="";for(n=0;3>=n;n++)t=e>>>8*n&255,o="0"+t.toString(16),r+=o.substr(o.length-2,2);return r}if(!r.browser)return o.createHash("md5").update(e).digest("hex");var _,h,m,g,y,b,w,k,q,S=[],E=7,R=12,O=17,T=22,C=5,D=9,N=14,I=20,A=4,x=11,j=16,L=23,B=6,M=10,P=15,U=21;for(S=p(e),b=1732584193,w=4023233417,k=2562383102,q=271733878,_=0;_<S.length;_+=16)h=b,m=w,g=k,y=q,b=c(b,w,k,q,S[_+0],E,3614090360),q=c(q,b,w,k,S[_+1],R,3905402710),k=c(k,q,b,w,S[_+2],O,606105819),w=c(w,k,q,b,S[_+3],T,3250441966),b=c(b,w,k,q,S[_+4],E,4118548399),q=c(q,b,w,k,S[_+5],R,1200080426),k=c(k,q,b,w,S[_+6],O,2821735955),w=c(w,k,q,b,S[_+7],T,4249261313),b=c(b,w,k,q,S[_+8],E,1770035416),q=c(q,b,w,k,S[_+9],R,2336552879),k=c(k,q,b,w,S[_+10],O,4294925233),w=c(w,k,q,b,S[_+11],T,2304563134),b=c(b,w,k,q,S[_+12],E,1804603682),q=c(q,b,w,k,S[_+13],R,4254626195),k=c(k,q,b,w,S[_+14],O,2792965006),w=c(w,k,q,b,S[_+15],T,1236535329),b=d(b,w,k,q,S[_+1],C,4129170786),q=d(q,b,w,k,S[_+6],D,3225465664),k=d(k,q,b,w,S[_+11],N,643717713),w=d(w,k,q,b,S[_+0],I,3921069994),b=d(b,w,k,q,S[_+5],C,3593408605),q=d(q,b,w,k,S[_+10],D,38016083),k=d(k,q,b,w,S[_+15],N,3634488961),w=d(w,k,q,b,S[_+4],I,3889429448),b=d(b,w,k,q,S[_+9],C,568446438),q=d(q,b,w,k,S[_+14],D,3275163606),k=d(k,q,b,w,S[_+3],N,4107603335),w=d(w,k,q,b,S[_+8],I,1163531501),b=d(b,w,k,q,S[_+13],C,2850285829),q=d(q,b,w,k,S[_+2],D,4243563512),k=d(k,q,b,w,S[_+7],N,1735328473),w=d(w,k,q,b,S[_+12],I,2368359562),b=l(b,w,k,q,S[_+5],A,4294588738),q=l(q,b,w,k,S[_+8],x,2272392833),k=l(k,q,b,w,S[_+11],j,1839030562),w=l(w,k,q,b,S[_+14],L,4259657740),b=l(b,w,k,q,S[_+1],A,2763975236),q=l(q,b,w,k,S[_+4],x,1272893353),k=l(k,q,b,w,S[_+7],j,4139469664),w=l(w,k,q,b,S[_+10],L,3200236656),b=l(b,w,k,q,S[_+13],A,681279174),q=l(q,b,w,k,S[_+0],x,3936430074),k=l(k,q,b,w,S[_+3],j,3572445317),w=l(w,k,q,b,S[_+6],L,76029189),b=l(b,w,k,q,S[_+9],A,3654602809),q=l(q,b,w,k,S[_+12],x,3873151461),k=l(k,q,b,w,S[_+15],j,530742520),w=l(w,k,q,b,S[_+2],L,3299628645),b=f(b,w,k,q,S[_+0],B,4096336452),q=f(q,b,w,k,S[_+7],M,1126891415),k=f(k,q,b,w,S[_+14],P,2878612391),w=f(w,k,q,b,S[_+5],U,4237533241),b=f(b,w,k,q,S[_+12],B,1700485571),q=f(q,b,w,k,S[_+3],M,2399980690),k=f(k,q,b,w,S[_+10],P,4293915773),w=f(w,k,q,b,S[_+1],U,2240044497),b=f(b,w,k,q,S[_+8],B,1873313359),q=f(q,b,w,k,S[_+15],M,4264355552),k=f(k,q,b,w,S[_+6],P,2734768916),w=f(w,k,q,b,S[_+13],U,1309151649),b=f(b,w,k,q,S[_+4],B,4149444226),q=f(q,b,w,k,S[_+11],M,3174756917),k=f(k,q,b,w,S[_+2],P,718787259),w=f(w,k,q,b,S[_+9],U,3951481745),b=n(b,h),w=n(w,m),k=n(k,g),q=n(q,y);var F=v(b)+v(w)+v(k)+v(q);return F.toLowerCase()}},{__browserify_process:19,crypto:18}],11:[function(e,t){"use strict";function n(e,t){var r,o=n.CHARS,i=[];if(t=t||o.length,e)for(r=0;e>r;r++)i[r]=o[0|Math.random()*t];else{var a;for(i[8]=i[13]=i[18]=i[23]="-",i[14]="4",r=0;36>r;r++)i[r]||(a=0|16*Math.random(),i[r]=o[19===r?3&a|8:a])}return i.join("")}n.CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),t.exports=n},{}],12:[function(e,t){var n=e("__browserify_process"),r=e("./setup");t.exports=r,r.ajax=e("./deps/ajax"),r.extend=e("./deps/extend"),r.utils=e("./utils"),r.Errors=e("./deps/errors"),r.replicate=e("./replicate").replicate,r.version=e("./version");var o=e("./adapters/http");if(r.adapter("http",o),r.adapter("https",o),r.adapter("idb",e("./adapters/idb")),r.adapter("websql",e("./adapters/websql")),r.plugin("mapreduce",e("pouchdb-mapreduce")),!n.browser){var i=e("./adapters/leveldb");r.adapter("ldb",i),r.adapter("leveldb",i)}},{"./adapters/http":2,"./adapters/idb":3,"./adapters/leveldb":18,"./adapters/websql":4,"./deps/ajax":6,"./deps/errors":8,"./deps/extend":9,"./replicate":14,"./setup":15,"./utils":16,"./version":17,__browserify_process:19,"pouchdb-mapreduce":20}],13:[function(e,t){"use strict";function n(e){for(var t,n=e.shift(),r=[n.id,n.opts,[]],o=r;e.length;)n=e.shift(),t=[n.id,n.opts,[]],o[2].push(t),o=t;return r}function r(e,t){for(var n=[{tree1:e,tree2:t}],r=!1;n.length>0;){var o=n.pop(),i=o.tree1,a=o.tree2;(i[1].status||a[1].status)&&(i[1].status="available"===i[1].status||"available"===a[1].status?"available":"missing");for(var s=0;s<a[2].length;s++)if(i[2][0]){for(var u=!1,c=0;c<i[2].length;c++)i[2][c][0]===a[2][s][0]&&(n.push({tree1:i[2][c],tree2:a[2][s]}),u=!0);u||(r="new_branch",i[2].push(a[2][s]),i[2].sort())}else r="new_leaf",i[2][0]=a[2][s]}return{conflicts:r,tree:e}}function o(e,t,n){var o,i=[],a=!1,s=!1;return e.length?(e.forEach(function(e){if(e.pos===t.pos&&e.ids[0]===t.ids[0])o=r(e.ids,t.ids),i.push({pos:e.pos,ids:o.tree}),a=a||o.conflicts,s=!0;else if(n!==!0){var u=e.pos<t.pos?e:t,c=e.pos<t.pos?t:e,d=c.pos-u.pos,l=[],f=[];for(f.push({ids:u.ids,diff:d,parent:null,parentIdx:null});f.length>0;){var p=f.pop();0!==p.diff?p.ids&&p.ids[2].forEach(function(e,t){f.push({ids:e,diff:p.diff-1,parent:p.ids,parentIdx:t})}):p.ids[0]===c.ids[0]&&l.push(p)}var v=l[0];v?(o=r(v.ids,c.ids),v.parent[2][v.parentIdx]=o.tree,i.push({pos:u.pos,ids:u.ids}),a=a||o.conflicts,s=!0):i.push(e)}else i.push(e)}),s||i.push(t),i.sort(function(e,t){return e.pos-t.pos}),{tree:i,conflicts:a||"internal_node"}):{tree:[t],conflicts:"new_leaf"}}function i(e,t){var r=s.rootToLeaf(e).map(function(e){var r=e.ids.slice(-t);return{pos:e.pos+(e.ids.length-r.length),ids:n(r)}});return r.reduce(function(e,t){return o(e,t,!0).tree},[r.shift()])}var a=e("./deps/extend"),s={};s.merge=function(e,t,n){e=a(!0,[],e),t=a(!0,{},t);var r=o(e,t);return{tree:i(r.tree,n),conflicts:r.conflicts}},s.winningRev=function(e){var t=[];return s.traverseRevTree(e.rev_tree,function(e,n,r,o,i){e&&t.push({pos:n,id:r,deleted:!!i.deleted})}),t.sort(function(e,t){return e.deleted!==t.deleted?e.deleted>t.deleted?1:-1:e.pos!==t.pos?t.pos-e.pos:e.id<t.id?1:-1}),t[0].pos+"-"+t[0].id},s.traverseRevTree=function(e,t){var n=[];for(e.forEach(function(e){n.push({pos:e.pos,ids:e.ids})});n.length>0;){var r=n.pop(),o=r.pos,i=r.ids,a=t(0===i[2].length,o,i[0],r.ctx,i[1]);i[2].forEach(function(e){n.push({pos:o+1,ids:e,ctx:a})})}},s.collectLeaves=function(e){var t=[];return s.traverseRevTree(e,function(e,n,r,o,i){e&&t.unshift({rev:n+"-"+r,pos:n,opts:i})}),t.sort(function(e,t){return t.pos-e.pos}),t.map(function(e){delete e.pos}),t},s.collectConflicts=function(e){var t=s.winningRev(e),n=s.collectLeaves(e.rev_tree),r=[];return n.forEach(function(e){e.rev===t||e.opts.deleted||r.push(e.rev)}),r},s.rootToLeaf=function(e){var t=[];return s.traverseRevTree(e,function(e,n,r,o,i){if(o=o?o.slice(0):[],o.push({id:r,opts:i}),e){var a=n+1-o.length;t.unshift({pos:a,ids:o})}return o}),t},t.exports=s},{"./deps/extend":9}],14:[function(e,t,n){function r(){var e=this;this.cancelled=!1,this.cancel=function(){e.cancelled=!0}}function o(e){var t=[],n={},r=!1;return n.enqueue=function(e,o){t.push({fun:e,args:o}),r||n.process()},n.process=function(){if(!r&&t.length&&!e.cancelled){r=!0;var n=t.shift();d.nextTick(function(){n.fun.apply(null,n.args)})}},n.notifyRequestComplete=function(){r=!1,n.process()},n}function i(e,t,n){var r=n.filter?n.filter.toString():"";return"_local/"+l.Crypto.MD5(e.id()+t.id()+r)}function a(e,t,n,r){t.get(n,function(t,o){t&&404===t.status?r(null,0):t?r(t):e.get(n,function(e,t){e&&404===e.status||!e&&o.last_seq!==t.last_seq?r(null,0):e?r(e):r(null,t.last_seq)})})}function s(e,t,n,r,o){function i(e,t){e.get(n,function(o,i){o&&404===o.status&&(i={_id:n}),i.last_seq=r,e.put(i,t)})}i(t,function(){i(e,function(){o()})})}function u(e,t,n,r){function u(r,o,i){if(n.onChange)for(var a=0;i>a;a++)n.onChange.apply(this,[R]);k-=i,R.docs_written+=i,s(e,t,y,q,function(){m.notifyRequestComplete(),h()})}function c(){if(!g.length)return m.notifyRequestComplete();var e=g.length;t.bulkDocs({docs:g},{new_edits:!1},function(t,n){u(t,n,e)}),g=[]}function d(t,n){e.get(t,{revs:!0,rev:n,attachments:!0},function(e,t){R.docs_read++,m.notifyRequestComplete(),g.push(t),m.enqueue(c)})}function f(e){return function(t,o){if(m.notifyRequestComplete(),t)return S&&r.cancel(),l.call(n.complete,t,null),void 0;if(0===Object.keys(o).length){for(var i in e)k-=e[i];return h(),void 0}var a=function(e){m.enqueue(d,[s,e])};for(var s in o){var u=e[s]-o[s].missing.length;k-=u,o[s].missing.forEach(a)}}}function p(e,n){t.revsDiff(e,f(n))}function v(e){q=e.seq,b.push(e);var t={};t[e.id]=e.changes.map(function(e){return e.rev});var n={};n[e.id]=e.changes.length,k+=e.changes.length,m.enqueue(p,[t,n])}function _(){w=!0,h()}function h(){w&&0===k&&(R.end_time=new Date,l.call(n.complete,null,R))}var m=new o(r),g=[],y=i(e,t,n),b=[],w=!1,k=0,q=0,S=n.continuous||!1,E=n.doc_ids,R={ok:!0,start_time:new Date,docs_read:0,docs_written:0};a(e,t,y,function(t,o){if(t)return l.call(n.complete,t);if(q=o,!r.cancelled){var i={continuous:S,since:q,style:"all_docs",onChange:v,complete:_,doc_ids:E};n.filter&&(i.filter=n.filter),n.query_params&&(i.query_params=n.query_params);var a=e.changes(i);if(n.continuous){var s=r.cancel;r.cancel=function(){s(),a.cancel()}}}})}function c(e,t){return"string"==typeof e?new f(e,t):(t(null,e),void 0)}var d=e("__browserify_process"),l=e("./utils"),f=e("./index");n.replicate=function(e,t,n,o){n instanceof Function&&(o=n,n={}),void 0===n&&(n={}),n.complete||(n.complete=o);var i=new r;return c(e,function(e,r){return e?l.call(o,e):(c(t,function(e,t){if(e)return l.call(o,e);if(n.server){if("function"!=typeof r.replicateOnServer)return l.call(o,{error:"Server replication not supported for "+r.type()+" adapter"});if(r.type()!==t.type())return l.call(o,{error:"Server replication for different adapter types ("+r.type()+" and "+t.type()+") is not supported"});r.replicateOnServer(t,n,i)}else u(r,t,n,i)}),void 0)}),i}},{"./index":12,"./utils":16,__browserify_process:19}],15:[function(e,t){"use strict";var n=e("./constructor");n.adapters={},n.plugins={},n.prefix="_pouch_",n.parseAdapter=function(e){var t,r=e.match(/([a-z\-]*):\/\/(.*)/);if(r){if(e=/http(s?)/.test(r[1])?r[1]+"://"+r[2]:r[2],t=r[1],!n.adapters[t].valid())throw"Invalid adapter";return{name:e,adapter:r[1]}}for(var o=["idb","leveldb","websql"],i=0;i<o.length;++i)if(o[i]in n.adapters){t=n.adapters[o[i]];var a="use_prefix"in t?t.use_prefix:!0;return{name:a?n.prefix+e:e,adapter:o[i]}}throw"No valid adapter found"},n.destroy=function(e,t,r){("function"==typeof t||"undefined"==typeof t)&&(r=t,t={}),"object"==typeof e&&(t=e,e=void 0),"undefined"==typeof r&&(r=function(){});var o=n.parseAdapter(t.name||e),i=o.name,a=function(e){if(e)return r(e),void 0;for(var a in n.plugins)n.plugins[a]._delete(i);n.adapters[o.adapter].destroy(i,t,r)};n.removeFromAllDbs(o,a)},n.removeFromAllDbs=function(e,t){if(!n.enableAllDbs)return t(),void 0;var r=e.adapter;return"http"===r||"https"===r?(t(),void 0):(new n(n.allDBName(e.adapter),function(r,o){if(r)return t(),void 0;var i=n.dbName(e.adapter,e.name);o.get(i,function(e,n){e?t():o.remove(n,function(e){t()})})}),void 0)},n.adapter=function(e,t){t.valid()&&(n.adapters[e]=t)},n.plugin=function(e,t){n.plugins[e]=t},n.enableAllDbs=!1,n.ALL_DBS="_allDbs",n.dbName=function(e,t){return[e,"-",t].join("")},n.realDBName=function(e,t){return[e,"://",t].join("")},n.allDBName=function(e){return[e,"://",n.prefix+n.ALL_DBS].join("")},n.open=function(e,t){if(!n.enableAllDbs)return t(),void 0;var r=e.adapter;return"http"===r||"https"===r?(t(),void 0):(new n(n.allDBName(r),function(o,i){if(o)return t(),void 0;var a=n.dbName(r,e.name);i.get(a,function(n){n&&404===n.status?i.put({_id:a,dbname:e.originalName},function(e){t()}):t()})}),void 0)},n.allDbs=function(e){var t=function(r,o){if(0===r.length){var i=[];return o.forEach(function(e){var t=i.some(function(t){return t.id===e.id});t||i.push(e)}),e(null,i.map(function(e){return e.doc.dbname})),void 0}var a=r.shift();return"http"===a||"https"===a?(t(r,o),void 0):(new n(n.allDBName(a),function(n,i){return n?(e(n),void 0):(i.allDocs({include_docs:!0},function(n,i){return n?(e(n),void 0):(o.unshift.apply(o,i.rows),t(r,o),void 0)}),void 0)}),void 0)},r=Object.keys(n.adapters);t(r,[])},t.exports=n},{"./constructor":5}],16:[function(e,t,n){function r(){return"undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage&&"undefined"!=typeof chrome.storage.local}var o=e("./merge");n.extend=e("./deps/extend"),n.ajax=e("./deps/ajax"),n.createBlob=e("./deps/blob");var i=e("./deps/uuid");n.Crypto=e("./deps/md5.js");var a=e("./deps/buffer"),s=e("./deps/errors"),u=["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree"];n.uuids=function(e,t){"object"!=typeof t&&(t={});for(var n=t.length,r=t.radix,o=[];o.push(i(n,r))<e;);return o},n.uuid=function(e){return n.uuids(1,e)[0]},n.isValidId=function(e){return e&&"string"==typeof e?/^_/.test(e)?/^_(design|local)/.test(e):!0:!1},n.call=function(e){if(typeof e==typeof Function){var t=Array.prototype.slice.call(arguments,1);e.apply(this,t)}},n.isLocalId=function(e){return/^_local/.test(e)},n.isDeleted=function(e,t){t||(t=o.winningRev(e)),t.indexOf("-")>=0&&(t=t.split("-")[1]);var n=!1;return o.traverseRevTree(e.rev_tree,function(e,r,o,i,a){o===t&&(n=!!a.deleted)}),n},n.filterChange=function(e){return function(t){var n={},r=e.filter&&"function"==typeof e.filter;if(n.query=e.query_params,e.filter&&r&&!e.filter.call(this,t.doc,n))return!1;if(e.doc_ids&&-1===e.doc_ids.indexOf(t.id))return!1;if(e.include_docs)for(var o in t.doc._attachments)t.doc._attachments[o].stub=!0;else delete t.doc;return!0}},n.processChanges=function(e,t,r){t=t.filter(n.filterChange(e)),e.limit&&e.limit<t.length&&(t.length=e.limit),t.forEach(function(t){n.call(e.onChange,t)}),n.call(e.complete,null,{results:t,last_seq:r})},n.parseDoc=function(e,t){var r,o,i,a=null,c={status:"available"};if(e._deleted&&(c.deleted=!0),t)if(e._id||(e._id=n.uuid()),o=n.uuid({length:32,radix:16}).toLowerCase(),e._rev){if(i=/^(\d+)-(.+)$/.exec(e._rev),!i)throw"invalid value for property '_rev'";e._rev_tree=[{pos:parseInt(i[1],10),ids:[i[2],{status:"missing"},[[o,c,[]]]]}],r=parseInt(i[1],10)+1}else e._rev_tree=[{pos:1,ids:[o,c,[]]}],r=1;else if(e._revisions&&(e._rev_tree=[{pos:e._revisions.start-e._revisions.ids.length+1,ids:e._revisions.ids.reduce(function(e,t){return null===e?[t,c,[]]:[t,{status:"missing"},[e]]},null)}],r=e._revisions.start,o=e._revisions.ids[0]),!e._rev_tree){if(i=/^(\d+)-(.+)$/.exec(e._rev),!i)return s.BAD_ARG;r=parseInt(i[1],10),o=i[2],e._rev_tree=[{pos:parseInt(i[1],10),ids:[i[2],c,[]]}]}"string"!=typeof e._id?a=s.INVALID_ID:n.isValidId(e._id)||(a=s.RESERVED_ID);for(var d in e)e.hasOwnProperty(d)&&"_"===d[0]&&-1===u.indexOf(d)&&(a=n.extend({},s.DOC_VALIDATION),a.reason+=": "+d);return e._id=decodeURIComponent(e._id),e._rev=[r,o].join("-"),a?a:Object.keys(e).reduce(function(t,n){return/^_/.test(n)&&"_attachments"!==n?t.metadata[n.slice(1)]=e[n]:t.data[n]=e[n],t},{metadata:{},data:{}})},n.isCordova=function(){return"undefined"!=typeof cordova||"undefined"!=typeof PhoneGap||"undefined"!=typeof phonegap},n.Changes=function(){var e={},t={};return r()?chrome.storage.onChanged.addListener(function(t){null!=t.db_name&&e.notify(t.db_name.newValue)}):"undefined"!=typeof window&&window.addEventListener("storage",function(t){e.notify(t.key)}),e.addListener=function(e,n,r,o){t[e]||(t[e]={}),t[e][n]={db:r,opts:o}
},e.removeListener=function(e,n){t[e]&&delete t[e][n]},e.clearListeners=function(e){delete t[e]},e.notifyLocalWindows=function(e){r()?chrome.storage.local.set({db_name:e}):localStorage[e]="a"===localStorage[e]?"b":"a"},e.notify=function(e){t[e]&&Object.keys(t[e]).forEach(function(r){var o=t[e][r].opts;t[e][r].db.changes({include_docs:o.include_docs,conflicts:o.conflicts,continuous:!1,descending:!1,filter:o.filter,view:o.view,since:o.since,query_params:o.query_params,onChange:function(e){e.seq>o.since&&!o.cancelled&&(o.since=e.seq,n.call(o.onChange,e))}})})},e},n.atob="undefined"!=typeof window&&"atob"in window?function(e){return atob(e)}:function(e){var t=new a(e,"base64");if(t.toString("base64")!==e)throw"Cannot base64 encode full string";return t.toString("binary")},n.btoa="undefined"!=typeof window&&"btoa"in window?function(e){return btoa(e)}:function(e){return new a(e,"binary").toString("base64")},t.exports=n},{"./deps/ajax":6,"./deps/blob":7,"./deps/buffer":18,"./deps/errors":8,"./deps/extend":9,"./deps/md5.js":10,"./deps/uuid":11,"./merge":13}],17:[function(e,t){t.exports="1.1.0"},{}],18:[function(){},{}],19:[function(e,t){var n=t.exports={};n.nextTick=function(){var e="undefined"!=typeof window&&window.setImmediate,t="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};if(t){var n=[];return window.addEventListener("message",function(e){var t=e.source;if((t===window||null===t)&&"process-tick"===e.data&&(e.stopPropagation(),n.length>0)){var r=n.shift();r()}},!0),function(e){n.push(e),window.postMessage("process-tick","*")}}return function(e){setTimeout(e,0)}}(),n.title="browser",n.browser=!0,n.env={},n.argv=[],n.binding=function(){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(){throw new Error("process.chdir is not supported")}},{}],20:[function(require,module,exports){"use strict";function MapReduce(db){function viewQuery(fun,options){function sum(e){return e.reduce(function(e,t){return e+t},0)}function emit(e,t){var n={id:current.doc._id,key:e,value:t};if(!(options.startkey&&pouchCollate(e,options.startkey)<0||options.endkey&&pouchCollate(e,options.endkey)>0||"undefined"!=typeof options.key&&0!==pouchCollate(e,options.key))){if(num_started++,options.include_docs){if(t&&"object"==typeof t&&t._id)return db.get(t._id,function(e,t){t&&(n.doc=t),results.push(n),checkComplete()}),void 0;n.doc=current.doc}results.push(n)}}function checkComplete(){if(completed&&results.length==num_started){if(results.sort(function(e,t){return pouchCollate(e.key,t.key)}),options.descending&&results.reverse(),options.reduce===!1)return options.complete(null,{total_rows:results.length,offset:options.skip,rows:"limit"in options?results.slice(options.skip,options.limit+options.skip):options.skip>0?results.slice(options.skip):results});var e=[];results.forEach(function(t){var n=e[e.length-1]||null;return n&&0===pouchCollate(n.key[0][0],t.key)?(n.key.push([t.key,t.id]),n.value.push(t.value),void 0):(e.push({key:[[t.key,t.id]],value:[t.value]}),void 0)}),e.forEach(function(e){e.value=fun.reduce(e.key,e.value),e.value="undefined"==typeof e.value?null:e.value,e.key=e.key[0][0]}),options.complete(null,{total_rows:e.length,offset:options.skip,rows:"limit"in options?e.slice(options.skip,options.limit+options.skip):options.skip>0?e.slice(options.skip):e})}}if(options.complete){options.skip||(options.skip=0),fun.reduce||(options.reduce=!1);var builtInReduce={_sum:function(e,t){return sum(t)},_count:function(e,t,n){return n?sum(t):t.length},_stats:function(e,t){return{sum:sum(t),min:Math.min.apply(null,t),max:Math.max.apply(null,t),count:t.length,sumsqr:function(){var e=0;for(var n in t)"number"==typeof t[n]&&(e+=t[n]*t[n]);return e}()}}},results=[],current=null,num_started=0,completed=!1;eval("fun.map = "+fun.map.toString()+";"),fun.reduce&&(builtInReduce[fun.reduce]&&(fun.reduce=builtInReduce[fun.reduce]),eval("fun.reduce = "+fun.reduce.toString()+";")),db.changes({conflicts:!0,include_docs:!0,onChange:function(e){"deleted"in e||(current={doc:e.doc},fun.map.call(this,e.doc))},complete:function(){completed=!0,checkComplete()}})}}function httpQuery(e,t,n){var r=[],o=void 0,i="GET";if("undefined"!=typeof t.reduce&&r.push("reduce="+t.reduce),"undefined"!=typeof t.include_docs&&r.push("include_docs="+t.include_docs),"undefined"!=typeof t.limit&&r.push("limit="+t.limit),"undefined"!=typeof t.descending&&r.push("descending="+t.descending),"undefined"!=typeof t.startkey&&r.push("startkey="+encodeURIComponent(JSON.stringify(t.startkey))),"undefined"!=typeof t.endkey&&r.push("endkey="+encodeURIComponent(JSON.stringify(t.endkey))),"undefined"!=typeof t.key&&r.push("key="+encodeURIComponent(JSON.stringify(t.key))),"undefined"!=typeof t.group&&r.push("group="+t.group),"undefined"!=typeof t.group_level&&r.push("group_level="+t.group_level),"undefined"!=typeof t.skip&&r.push("skip="+t.skip),"undefined"!=typeof t.keys&&(i="POST",o=JSON.stringify({keys:t.keys})),r=r.join("&"),r=""===r?"":"?"+r,"string"==typeof e){var a=e.split("/");return db.request({method:i,url:"_design/"+a[0]+"/_view/"+a[1]+r,body:o},n),void 0}var s=JSON.parse(JSON.stringify(e,function(e,t){return"function"==typeof t?t+"":t}));db.request({method:"POST",url:"_temp_view"+r,body:s},n)}return this instanceof MapReduce?(this.query=function(e,t,n){if("function"==typeof t&&(n=t,t={}),n&&(t.complete=n),"http"===db.type())return"function"==typeof e?httpQuery({map:e},t,n):httpQuery(e,t,n);if("object"==typeof e)return viewQuery(e,t);if("function"==typeof e)return viewQuery({map:e},t);var r=e.split("/");db.get("_design/"+r[0],function(e,o){return e?(n&&n(e),void 0):o.views[r[1]]?(viewQuery({map:o.views[r[1]].map,reduce:o.views[r[1]].reduce},t),void 0):(n&&n({error:"not_found",reason:"missing_named_view"}),void 0)})},void 0):new MapReduce(db)}var pouchCollate=require("pouchdb-collate");MapReduce._delete=function(){},module.exports=MapReduce},{"pouchdb-collate":21}],21:[function(e,t){"use strict";function n(e,t){for(var n=Math.min(e.length,t.length),r=0;n>r;r++){var o=a(e[r],t[r]);if(0!==o)return o}return e.length===t.length?0:e.length>t.length?1:-1}function r(e,t){return e===t?0:e>t?1:-1}function o(e,t){for(var n=Object.keys(e),r=Object.keys(t),o=Math.min(n.length,r.length),i=0;o>i;i++){var s=a(n[i],r[i]);if(0!==s)return s;if(s=a(e[n[i]],t[r[i]]),0!==s)return s}return n.length===r.length?0:n.length>r.length?1:-1}function i(e){var t=["boolean","number","string","object"];return-1!==t.indexOf(typeof e)?null===e?1:t.indexOf(typeof e)+2:Array.isArray(e)?4.5:"undefined"==typeof e?1:void 0}function a(e,t){var a=i(e),s=i(t);return a-s!==0?a-s:null===e||"undefined"==typeof e?0:"number"==typeof e?e-t:"boolean"==typeof e?e===t?0:t>e?-1:1:"string"==typeof e?r(e,t):Array.isArray(e)?n(e,t):"object"==typeof e?o(e,t):void 0}t.exports=a},{}]},{},[12])(12)});
(function(){var DelayedOp,DelayedSyncAnimation,Dropbox,DropboxClient,DropboxOauth,DropboxXhr,DropboxXhrCanSendForms,DropboxXhrIeMode,DropboxXhrRequest,OneOp,REALTIME_MIMETYPE,Set,add32,arrayToBase64,atob,atobNibble,base64Digits,base64HmacSha1,base64Sha1,baseUrl,btoa,btoaNibble,crypto,dropboxEncodeKey,exports,handleErrors,hmacSha1,mixpanel_token,realTimeEvents,rotateLeft32,sha1,stringToArray,_base64Digits,__hasProp={}.hasOwnProperty,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__slice=[].slice,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};(function(){var Nimbus,headID,newScript;if(window.Nimbus==null){window.Nimbus={}}Nimbus=window.Nimbus;window.handle_initialization=null;Nimbus.loaded=false;window.handleClientLoad=function(){console.log("loaded CALLED");Nimbus.loaded=true;if(Nimbus.gdrive_initialized){return Nimbus.Auth.initialize()}};headID=document.getElementsByTagName("head")[0];newScript=document.createElement("script");newScript.type="text/javascript";newScript.src="https://apis.google.com/js/client.js?onload=handleClientLoad";return headID.appendChild(newScript)})();Dropbox=function(){function Dropbox(options){this.client=new DropboxClient(options)}return Dropbox}();Dropbox.ApiError=function(){function ApiError(xhr,method,url){var e,text;this.method=method;this.url=url;this.status=xhr.status;if(xhr.responseType){text=xhr.response||xhr.responseText}else{text=xhr.responseText}if(text){try{this.responseText=text.toString();this.response=JSON.parse(text)}catch(_error){e=_error;this.response=null}}else{this.responseText="(no response)";this.response=null}}ApiError.prototype.toString=function(){return"Dropbox API error "+this.status+" from "+this.method+" "+this.url+" :: "+this.responseText};ApiError.prototype.inspect=function(){return this.toString()};return ApiError}();if(typeof window!=="undefined"&&window!==null){if(window.atob&&window.btoa){atob=function(string){return window.atob(string)};btoa=function(base64){return window.btoa(base64)}}else{base64Digits="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";btoaNibble=function(accumulator,bytes,result){var i,limit;limit=3-bytes;accumulator<<=limit*8;i=3;while(i>=limit){result.push(base64Digits.charAt(accumulator>>i*6&63));i-=1}i=bytes;while(i<3){result.push("=");i+=1}return null};atobNibble=function(accumulator,digits,result){var i,limit;limit=4-digits;accumulator<<=limit*6;i=2;while(i>=limit){result.push(String.fromCharCode(accumulator>>8*i&255));i-=1}return null};btoa=function(string){var accumulator,bytes,i,result,_i,_ref;result=[];accumulator=0;bytes=0;for(i=_i=0,_ref=string.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){accumulator=accumulator<<8|string.charCodeAt(i);bytes+=1;if(bytes===3){btoaNibble(accumulator,bytes,result);accumulator=bytes=0}}if(bytes>0){btoaNibble(accumulator,bytes,result)}return result.join("")};atob=function(base64){var accumulator,digit,digits,i,result,_i,_ref;result=[];accumulator=0;digits=0;for(i=_i=0,_ref=base64.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){digit=base64.charAt(i);if(digit==="="){break}accumulator=accumulator<<6|base64Digits.indexOf(digit);digits+=1;if(digits===4){atobNibble(accumulator,digits,result);accumulator=digits=0}}if(digits>0){atobNibble(accumulator,digits,result)}return result.join("")}}}else{atob=function(arg){var buffer,i;buffer=new Buffer(arg,"base64");return function(){var _i,_ref,_results;_results=[];for(i=_i=0,_ref=buffer.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){_results.push(String.fromCharCode(buffer[i]))}return _results}().join("")};btoa=function(arg){var buffer,i;buffer=new Buffer(function(){var _i,_ref,_results;_results=[];for(i=_i=0,_ref=arg.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){_results.push(arg.charCodeAt(i))}return _results}());return buffer.toString("base64")}}Dropbox.Client=function(){function Client(options){this.sandbox=options.sandbox||false;this.apiServer=options.server||this.defaultApiServer();this.authServer=options.authServer||this.defaultAuthServer();this.fileServer=options.fileServer||this.defaultFileServer();this.oauth=new DropboxOauth(options);this.uid=null;this.authState=null;this.authError=null;this._credentials=null;this.setCredentials(options);this.setupUrls()}Client.prototype.authDriver=function(driver){this.driver=driver;return this};Client.prototype.dropboxUid=function(){return this.uid};Client.prototype.credentials=function(){if(!this._credentials){this.computeCredentials()}return this._credentials};Client.prototype.authenticate=function(callback){var oldAuthState,_fsmStep;oldAuthState=null;_fsmStep=function(_this){return function(){var authUrl;if(oldAuthState!==_this.authState){oldAuthState=_this.authState;if(_this.driver.onAuthStateChange){return _this.driver.onAuthStateChange(_this,_fsmStep)}}switch(_this.authState){case DropboxClient.RESET:return _this.requestToken(function(error,data){var token,tokenSecret;if(error){_this.authError=error;_this.authState=DropboxClient.ERROR}else{token=data.oauth_token;tokenSecret=data.oauth_token_secret;_this.oauth.setToken(token,tokenSecret);_this.authState=DropboxClient.REQUEST}_this._credentials=null;return _fsmStep()});case DropboxClient.REQUEST:authUrl=_this.authorizeUrl(_this.oauth.token);return _this.driver.doAuthorize(authUrl,_this.oauth.token,_this.oauth.tokenSecret,function(){_this.authState=DropboxClient.AUTHORIZED;_this._credentials=null;return _fsmStep()});case DropboxClient.AUTHORIZED:return _this.getAccessToken(function(error,data){if(error){_this.authError=error;_this.authState=DropboxClient.ERROR}else{_this.oauth.setToken(data.oauth_token,data.oauth_token_secret);_this.uid=data.uid;_this.authState=DropboxClient.DONE}_this._credentials=null;return _fsmStep()});case DropboxClient.DONE:return callback(null,_this);case Dropbox.SIGNED_OFF:_this.reset();return _fsmStep();case DropboxClient.ERROR:return callback(_this.authError)}}}(this);_fsmStep();return this};Client.prototype.signOut=function(callback){var params,url;url=this.urls.signOut;params=this.oauth.addAuthParams("POST",url,{});return Dropbox.Xhr.request("POST",url,params,null,function(_this){return function(error){if(error){return callback(error)}_this.reset();_this.authState=DropboxClient.SIGNED_OFF;if(_this.driver.onAuthStateChange){return _this.driver.onAuthStateChange(_this,function(){return callback(error)})}else{return callback(error)}}}(this))};Client.prototype.signOff=function(callback){return this.signOut(callback)};Client.prototype.getUserInfo=function(callback){var params,url;url=this.urls.accountInfo;params=this.oauth.addAuthParams("GET",url,{});return Dropbox.Xhr.request("GET",url,params,null,function(error,userData){return callback(error,Dropbox.UserInfo.parse(userData),userData)})};Client.prototype.readFile=function(path,options,callback){var params,responseType,url;if(!callback&&typeof options==="function"){callback=options;options=null}url=""+this.urls.getFile+"/"+this.urlEncodePath(path);params={};responseType=null;if(options){if(options.versionTag){params.rev=options.versionTag}else if(options.rev){params.rev=options.rev}if(options.blob){responseType="blob"}if(options.binary){responseType="b"}}this.oauth.addAuthParams("GET",url,params);return Dropbox.Xhr.request2("GET",url,params,null,null,responseType,function(error,data,metadata){return callback(error,data,Dropbox.Stat.parse(metadata))})};Client.prototype.writeFile=function(path,data,options,callback){var useForm;if(!callback&&typeof options==="function"){callback=options;options=null}useForm=Dropbox.Xhr.canSendForms&&typeof data==="object";if(useForm){return this.writeFileUsingForm(path,data,options,callback)}else{return this.writeFileUsingPut(path,data,options,callback)}};Client.prototype.writeFileUsingForm=function(path,data,options,callback){var fileField,fileName,params,slashIndex,url;slashIndex=path.lastIndexOf("/");if(slashIndex===-1){fileName=path;path=""}else{fileName=path.substring(slashIndex);path=path.substring(0,slashIndex)}url=""+this.urls.postFile+"/"+this.urlEncodePath(path);params={file:fileName};if(options){if(options.noOverwrite){params.overwrite="false"}if(options.lastVersionTag){params.parent_rev=options.lastVersionTag}else if(options.parentRev||options.parent_rev){params.parent_rev=options.parentRev||options.parent_rev}}this.oauth.addAuthParams("POST",url,params);delete params.file;fileField={name:"file",value:data,fileName:fileName,contentType:"application/octet-stream"};return Dropbox.Xhr.multipartRequest(url,fileField,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.writeFileUsingPut=function(path,data,options,callback){var params,url;url=""+this.urls.putFile+"/"+this.urlEncodePath(path);params={};if(options){if(options.noOverwrite){params.overwrite="false"}if(options.lastVersionTag){params.parent_rev=options.lastVersionTag}else if(options.parentRev||options.parent_rev){params.parent_rev=options.parentRev||options.parent_rev}}this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request2("POST",url,params,null,data,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.stat=function(path,options,callback){var params,url;if(!callback&&typeof options==="function"){callback=options;options=null}url=""+this.urls.metadata+"/"+this.urlEncodePath(path);params={};if(options){if(options.version!=null){params.rev=options.version}if(options.removed||options.deleted){params.include_deleted="true"}if(options.readDir){params.list="true";if(options.readDir!==true){params.file_limit=options.readDir.toString()}}if(options.cacheHash){params.hash=options.cacheHash}}params.include_deleted||(params.include_deleted="false");params.list||(params.list="false");this.oauth.addAuthParams("GET",url,params);return Dropbox.Xhr.request("GET",url,params,null,function(error,metadata){var entries,entry,stat;stat=Dropbox.Stat.parse(metadata);if(metadata!=null?metadata.contents:void 0){entries=function(){var _i,_len,_ref,_results;_ref=metadata.contents;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){entry=_ref[_i];_results.push(Dropbox.Stat.parse(entry))}return _results}()}else{entries=void 0}return callback(error,stat,entries)})};Client.prototype.readdir=function(path,options,callback){var statOptions;if(!callback&&typeof options==="function"){callback=options;options=null}statOptions={readDir:true};if(options){if(options.limit!=null){statOptions.readDir=options.limit}if(options.versionTag){statOptions.versionTag=options.versionTag}}return this.stat(path,statOptions,function(error,stat,entry_stats){var entries,entry_stat;if(entry_stats){entries=function(){var _i,_len,_results;_results=[];for(_i=0,_len=entry_stats.length;_i<_len;_i++){entry_stat=entry_stats[_i];_results.push(entry_stat.name)}return _results}()}else{entries=null}return callback(error,entries,stat,entry_stats)})};Client.prototype.metadata=function(path,options,callback){return this.stat(path,options,callback)};Client.prototype.makeUrl=function(path,options,callback){var isDirect,params,url;if(!callback&&typeof options==="function"){callback=options;options=null}path=this.urlEncodePath(path);if(options&&options.download){isDirect=true;url=""+this.urls.media+"/"+path}else{isDirect=false;url=""+this.urls.shares+"/"+path}if(options&&(options["long"]||options.longUrl)){params={short_url:"false"}}else{params={}}this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,urlData){return callback(error,Dropbox.PublicUrl.parse(urlData,isDirect))})};Client.prototype.history=function(path,options,callback){var params,url;if(!callback&&typeof options==="function"){callback=options;options=null}url=""+this.urls.revisions+"/"+this.urlEncodePath(path);params={};if(options&&options.limit!=null){params.rev_limit=options.limit}this.oauth.addAuthParams("GET",url,params);return Dropbox.Xhr.request("GET",url,params,null,function(error,versions){var metadata,stats;if(versions){stats=function(){var _i,_len,_results;_results=[];for(_i=0,_len=versions.length;_i<_len;_i++){metadata=versions[_i];_results.push(Dropbox.Stat.parse(metadata))}return _results}()}else{stats=void 0}return callback(error,stats)})};Client.prototype.revisions=function(path,options,callback){return this.history(path,options,callback)};Client.prototype.thumbnailUrl=function(path,options){var params,url;url=""+this.urls.thumbnails+"/"+this.urlEncodePath(path);params={};if(options){if(options.format){params.format=options.format}else if(options.png){params.format="png"}if(options.size){params.size=options.size}}this.oauth.addAuthParams("GET",url,params);return""+url+"?"+Dropbox.Xhr.urlEncode(params)};Client.prototype.readThumbnail=function(path,options,callback){var responseType,url;if(!callback&&typeof options==="function"){callback=options;options=null}url=this.thumbnailUrl(path,options);responseType="b";if(options){if(options.blob){responseType="blob"}}return Dropbox.Xhr.request2("GET",url,{},null,null,responseType,function(error,data,metadata){return callback(error,data,Dropbox.Stat.parse(metadata))})};Client.prototype.revertFile=function(path,versionTag,callback){var params,url;url=""+this.urls.restore+"/"+this.urlEncodePath(path);params={rev:versionTag};this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.restore=function(path,versionTag,callback){return this.revertFile(path,versionTag,callback)};Client.prototype.findByName=function(path,namePattern,options,callback){var params,url;if(!callback&&typeof options==="function"){callback=options;options=null}url=""+this.urls.search+"/"+this.urlEncodePath(path);params={query:namePattern};if(options){if(options.limit!=null){params.file_limit=options.limit}if(options.removed||options.deleted){params.include_deleted=true}}this.oauth.addAuthParams("GET",url,params);return Dropbox.Xhr.request("GET",url,params,null,function(error,results){var metadata,stats;if(results){stats=function(){var _i,_len,_results;_results=[];for(_i=0,_len=results.length;_i<_len;_i++){metadata=results[_i];_results.push(Dropbox.Stat.parse(metadata))}return _results}()}else{stats=void 0}return callback(error,stats)})};Client.prototype.search=function(path,namePattern,options,callback){return this.findByName(path,namePattern,options,callback)};Client.prototype.makeCopyReference=function(path,callback){var params,url;url=""+this.urls.copyRef+"/"+this.urlEncodePath(path);params=this.oauth.addAuthParams("GET",url,{});return Dropbox.Xhr.request("GET",url,params,null,function(error,refData){return callback(error,Dropbox.CopyReference.parse(refData))})};Client.prototype.copyRef=function(path,callback){return this.makeCopyReference(path,callback)};Client.prototype.pullChanges=function(cursor,callback){var params,url;if(!callback&&typeof cursor==="function"){callback=cursor;cursor=null}url=this.urls.delta;params={};if(cursor){if(cursor.cursorTag){params={cursor:cursor.cursorTag}}else{params={cursor:cursor}}}else{params={}}this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,deltaInfo){return callback(error,Dropbox.PulledChanges.parse(deltaInfo))})};Client.prototype.delta=function(cursor,callback){return this.pullChanges(cursor,callback)};Client.prototype.mkdir=function(path,callback){var params,url;url=this.urls.fileopsCreateFolder;params={root:this.fileRoot,path:this.normalizePath(path)};this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.remove=function(path,callback){var params,url;url=this.urls.fileopsDelete;params={root:this.fileRoot,path:this.normalizePath(path)};this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.unlink=function(path,callback){return this.remove(path,callback)};Client.prototype["delete"]=function(path,callback){return this.remove(path,callback)};Client.prototype.copy=function(from,toPath,callback){var options,params,url;if(!callback&&typeof options==="function"){callback=options;options=null}params={root:this.fileRoot,to_path:this.normalizePath(toPath)};if(from instanceof Dropbox.CopyReference){params.from_copy_ref=from.tag}else{params.from_path=this.normalizePath(from)}url=this.urls.fileopsCopy;this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.move=function(fromPath,toPath,callback){var options,params,url;if(!callback&&typeof options==="function"){callback=options;options=null}fromPath=this.normalizePath(fromPath);toPath=this.normalizePath(toPath);url=this.urls.fileopsMove;params={root:this.fileRoot,from_path:fromPath,to_path:toPath};this.oauth.addAuthParams("POST",url,params);return Dropbox.Xhr.request("POST",url,params,null,function(error,metadata){return callback(error,Dropbox.Stat.parse(metadata))})};Client.prototype.reset=function(){this.uid=null;this.oauth.setToken(null,"");this.authState=DropboxClient.RESET;this.authError=null;this._credentials=null;return this};Client.prototype.setCredentials=function(credentials){this.oauth.reset(credentials);this.uid=credentials.uid||null;if(credentials.authState){this.authState=credentials.authState}else{if(credentials.token){this.authState=DropboxClient.DONE}else{this.authState=DropboxClient.RESET}}this.authError=null;this._credentials=null;return this};Client.prototype.appHash=function(){return this.oauth.appHash()};Client.prototype.setupUrls=function(){this.fileRoot=this.sandbox?"sandbox":"dropbox";return this.urls={requestToken:""+this.apiServer+"/1/oauth/request_token",authorize:""+this.authServer+"/1/oauth/authorize",accessToken:""+this.apiServer+"/1/oauth/access_token",signOut:""+this.apiServer+"/1/unlink_access_token",accountInfo:""+this.apiServer+"/1/account/info",getFile:""+this.fileServer+"/1/files/"+this.fileRoot,postFile:""+this.fileServer+"/1/files/"+this.fileRoot,putFile:""+this.fileServer+"/1/files_put/"+this.fileRoot,metadata:""+this.apiServer+"/1/metadata/"+this.fileRoot,delta:""+this.apiServer+"/1/delta",revisions:""+this.apiServer+"/1/revisions/"+this.fileRoot,restore:""+this.apiServer+"/1/restore/"+this.fileRoot,search:""+this.apiServer+"/1/search/"+this.fileRoot,shares:""+this.apiServer+"/1/shares/"+this.fileRoot,media:""+this.apiServer+"/1/media/"+this.fileRoot,copyRef:""+this.apiServer+"/1/copy_ref/"+this.fileRoot,thumbnails:""+this.fileServer+"/1/thumbnails/"+this.fileRoot,fileopsCopy:""+this.apiServer+"/1/fileops/copy",fileopsCreateFolder:""+this.apiServer+"/1/fileops/create_folder",fileopsDelete:""+this.apiServer+"/1/fileops/delete",fileopsMove:""+this.apiServer+"/1/fileops/move"}};Client.ERROR=0;Client.RESET=1;Client.REQUEST=2;Client.AUTHORIZED=3;Client.DONE=4;Client.SIGNED_OFF=5;Client.prototype.urlEncodePath=function(path){return Dropbox.Xhr.urlEncodeValue(this.normalizePath(path)).replace(/%2F/gi,"/")};Client.prototype.normalizePath=function(path){var i;if(path.substring(0,1)==="/"){i=1;while(path.substring(i,i+1)==="/"){i+=1}return path.substring(i)}else{return path}};Client.prototype.requestToken=function(callback){var params;params=this.oauth.addAuthParams("POST",this.urls.requestToken,{});return Dropbox.Xhr.request("POST",this.urls.requestToken,params,null,callback)};Client.prototype.authorizeUrl=function(token){var params;params={oauth_token:token,oauth_callback:this.driver.url()};return""+this.urls.authorize+"?"+Dropbox.Xhr.urlEncode(params)};Client.prototype.getAccessToken=function(callback){var params;params=this.oauth.addAuthParams("POST",this.urls.accessToken,{});return Dropbox.Xhr.request("POST",this.urls.accessToken,params,null,callback)};Client.prototype.defaultApiServer=function(){return"https://api.dropbox.com"};Client.prototype.defaultAuthServer=function(){return this.apiServer.replace("api.","www.")};Client.prototype.defaultFileServer=function(){return this.apiServer.replace("api.","api-content.")};Client.prototype.computeCredentials=function(){var value;value={key:this.oauth.key,sandbox:this.sandbox};if(this.oauth.secret){value.secret=this.oauth.secret}if(this.oauth.token){value.token=this.oauth.token;value.tokenSecret=this.oauth.tokenSecret}if(this.uid){value.uid=this.uid}if(this.authState!==DropboxClient.ERROR&&this.authState!==DropboxClient.RESET&&this.authState!==DropboxClient.DONE&&this.authState!==DropboxClient.SIGNED_OFF){value.authState=this.authState}if(this.apiServer!==this.defaultApiServer()){value.server=this.apiServer}if(this.authServer!==this.defaultAuthServer()){value.authServer=this.authServer}if(this.fileServer!==this.defaultFileServer()){value.fileServer=this.fileServer}return this._credentials=value};return Client}();DropboxClient=Dropbox.Client;Dropbox.AuthDriver=function(){function AuthDriver(){}AuthDriver.prototype.url=function(){return"https://some.url"};AuthDriver.prototype.doAuthorize=function(authUrl,token,tokenSecret,callback){return callback("oauth-token")};AuthDriver.prototype.onAuthStateChange=function(client,done){return done()};return AuthDriver}();Dropbox.Drivers={};Dropbox.Drivers.Redirect=function(){function Redirect(options){this.rememberUser=(options!=null?options.rememberUser:void 0)||false;this.scope=(options!=null?options.scope:void 0)||"default";this.useQuery=(options!=null?options.useQuery:void 0)||false;this.receiverUrl=this.computeUrl(options);this.tokenRe=new RegExp("(#|\\?|&)oauth_token=([^&#]+)(&|#|$)")}Redirect.prototype.url=function(){return this.receiverUrl};Redirect.prototype.doAuthorize=function(authUrl){return window.location.assign(authUrl)};Redirect.prototype.onAuthStateChange=function(client,done){var credentials;this.storageKey="dropbox-auth:"+this.scope+":"+client.appHash();switch(client.authState){case DropboxClient.RESET:if(!(credentials=this.loadCredentials())){return done()}if(credentials.authState){if(credentials.token===this.locationToken()){if(credentials.authState===DropboxClient.REQUEST){this.forgetCredentials();credentials.authState=DropboxClient.AUTHORIZED}client.setCredentials(credentials)}return done()}if(!this.rememberUser){this.forgetCredentials();return done()}client.setCredentials(credentials);return client.getUserInfo(function(_this){return function(error){if(error){client.reset();_this.forgetCredentials()}return done()}}(this));case DropboxClient.REQUEST:this.storeCredentials(client.credentials());return done();case DropboxClient.DONE:if(this.rememberUser){this.storeCredentials(client.credentials())}return done();case DropboxClient.SIGNED_OFF:this.forgetCredentials();return done();case DropboxClient.ERROR:this.forgetCredentials();return done();default:return done()}};Redirect.prototype.computeUrl=function(){var fragment,location,locationPair,querySuffix;querySuffix="_dropboxjs_scope="+encodeURIComponent(this.scope);location=Dropbox.Drivers.Redirect.currentLocation();if(location.indexOf("#")===-1){fragment=null}else{locationPair=location.split("#",2);location=locationPair[0];fragment=locationPair[1]}if(this.useQuery){if(location.indexOf("?")===-1){location+="?"+querySuffix}else{location+="&"+querySuffix}}else{fragment="?"+querySuffix}if(fragment){return location+"#"+fragment}else{return location}};Redirect.prototype.locationToken=function(){var location,match,scopePattern;location=Dropbox.Drivers.Redirect.currentLocation();scopePattern="_dropboxjs_scope="+encodeURIComponent(this.scope)+"&";if((typeof location.indexOf==="function"?location.indexOf(scopePattern):void 0)===-1){return null}match=this.tokenRe.exec(location);if(match){return decodeURIComponent(match[2])}else{return null}};Redirect.currentLocation=function(){return window.location.href};Redirect.prototype.storeCredentials=function(credentials){return localStorage.setItem(this.storageKey,JSON.stringify(credentials))};Redirect.prototype.loadCredentials=function(){var e,jsonString;jsonString=localStorage.getItem(this.storageKey);if(!jsonString){return null}try{return JSON.parse(jsonString)}catch(_error){e=_error;return null}};Redirect.prototype.forgetCredentials=function(){return localStorage.removeItem(this.storageKey)};return Redirect}();Dropbox.Drivers.Popup=function(){function Popup(options){this.receiverUrl=this.computeUrl(options);this.tokenRe=new RegExp("(#|\\?|&)oauth_token=([^&#]+)(&|#|$)")}Popup.prototype.doAuthorize=function(authUrl,token,tokenSecret,callback){this.listenForMessage(token,callback);return this.openWindow(authUrl)};Popup.prototype.url=function(){return this.receiverUrl};Popup.prototype.computeUrl=function(options){var fragments;if(options){if(options.receiverUrl){if(options.noFragment||options.receiverUrl.indexOf("#")!==-1){return options.receiverUrl}else{return options.receiverUrl+"#"}}else if(options.receiverFile){fragments=Dropbox.Drivers.Popup.currentLocation().split("/");fragments[fragments.length-1]=options.receiverFile;if(options.noFragment){return fragments.join("/")}else{return fragments.join("/")+"#"}}}return Dropbox.Drivers.Popup.currentLocation()};Popup.currentLocation=function(){return window.location.href};Popup.prototype.openWindow=function(url){return window.open(url,"_dropboxOauthSigninWindow",this.popupWindowSpec(980,980))};Popup.prototype.popupWindowSpec=function(popupWidth,popupHeight){var height,popupLeft,popupTop,width,x0,y0,_ref,_ref1,_ref2,_ref3;x0=(_ref=window.screenX)!=null?_ref:window.screenLeft;y0=(_ref1=window.screenY)!=null?_ref1:window.screenTop;width=(_ref2=window.outerWidth)!=null?_ref2:document.documentElement.clientWidth;height=(_ref3=window.outerHeight)!=null?_ref3:document.documentElement.clientHeight;popupLeft=Math.round(x0+(width-popupWidth)/2);popupTop=Math.round(y0+(height-popupHeight)/2.5);return"width="+popupWidth+",height="+popupHeight+","+("left="+popupLeft+",top="+popupTop)+"dialog=yes,dependent=yes,scrollbars=yes,location=yes"};Popup.prototype.listenForMessage=function(token,callback){var listener,tokenRe;tokenRe=this.tokenRe;listener=function(event){var match;match=tokenRe.exec(event.data.toString());if(match&&decodeURIComponent(match[2])===token){window.removeEventListener("message",listener);return callback()}};return window.addEventListener("message",listener,false)};return Popup}();Dropbox.Drivers.NodeServer=function(){function NodeServer(options){this.port=(options!=null?options.port:void 0)||8912;this.faviconFile=(options!=null?options.favicon:void 0)||null;this.fs=require("fs");this.http=require("http");this.open=require("open");this.callbacks={};this.urlRe=new RegExp("^/oauth_callback\\?");this.tokenRe=new RegExp("(\\?|&)oauth_token=([^&]+)(&|$)");this.createApp()}NodeServer.prototype.url=function(){return"http://localhost:"+this.port+"/oauth_callback"};NodeServer.prototype.doAuthorize=function(authUrl,token,tokenSecret,callback){this.callbacks[token]=callback;return this.openBrowser(authUrl)};NodeServer.prototype.openBrowser=function(url){if(!url.match(/^https?:\/\//)){throw new Error("Not a http/https URL: "+url)}return this.open(url)};NodeServer.prototype.createApp=function(){this.app=this.http.createServer(function(_this){return function(request,response){return _this.doRequest(request,response)}}(this));return this.app.listen(this.port)};NodeServer.prototype.closeServer=function(){return this.app.close()};NodeServer.prototype.doRequest=function(request,response){var data,match,token;if(this.urlRe.exec(request.url)){match=this.tokenRe.exec(request.url);if(match){token=decodeURIComponent(match[2]);if(this.callbacks[token]){this.callbacks[token]();delete this.callbacks[token]}}}data="";request.on("data",function(dataFragment){return data+=dataFragment});return request.on("end",function(_this){return function(){if(_this.faviconFile&&request.url==="/favicon.ico"){return _this.sendFavicon(response)}else{return _this.closeBrowser(response)}}}(this))};NodeServer.prototype.closeBrowser=function(response){var closeHtml;closeHtml='<!doctype html>\n<script type="text/javascript">window.close();</script>\n<p>Please close this window.</p>';response.writeHead(200,{"Content-Length":closeHtml.length,"Content-Type":"text/html"});response.write(closeHtml);return response.end};NodeServer.prototype.sendFavicon=function(response){return this.fs.readFile(this.faviconFile,function(error,data){response.writeHead(200,{"Content-Length":data.length,"Content-Type":"image/x-icon"});response.write(data);return response.end})};return NodeServer}();base64HmacSha1=function(string,key){return arrayToBase64(hmacSha1(stringToArray(string),stringToArray(key),string.length,key.length))};base64Sha1=function(string){return arrayToBase64(sha1(stringToArray(string),string.length))};if(typeof window==="undefined"||window===null){crypto=require("crypto");base64HmacSha1=function(string,key){var hmac;hmac=crypto.createHmac("sha1",key);hmac.update(string);return hmac.digest("base64")};base64Sha1=function(string){var hash;hash=crypto.createHash("sha1");hash.update(string);return hash.digest("base64")}}hmacSha1=function(string,key,length,keyLength){var hash1,i,ipad,opad;if(key.length>16){key=sha1(key,keyLength)}ipad=function(){var _i,_results;_results=[];for(i=_i=0;_i<16;i=++_i){_results.push(key[i]^909522486)}return _results}();opad=function(){var _i,_results;_results=[];for(i=_i=0;_i<16;i=++_i){_results.push(key[i]^1549556828)}return _results}();hash1=sha1(ipad.concat(string),64+length);return sha1(opad.concat(hash1),64+20)};sha1=function(string,length){var a,a0,b,b0,c,c0,d,d0,e,e0,ft,i,j,kt,limit,state,t,_i;string[length>>2]|=1<<31-((length&3)<<3);string[(length+8>>6<<4)+15]=length<<3;state=Array(80);a=1732584193;b=-271733879;c=-1732584194;d=271733878;e=-1009589776;i=0;limit=string.length;while(i<limit){a0=a;b0=b;c0=c;d0=d;e0=e;for(j=_i=0;_i<80;j=++_i){if(j<16){state[j]=string[i+j]}else{state[j]=rotateLeft32(state[j-3]^state[j-8]^state[j-14]^state[j-16],1)}if(j<20){ft=b&c|~b&d;kt=1518500249}else if(j<40){ft=b^c^d;kt=1859775393}else if(j<60){ft=b&c|b&d|c&d;kt=-1894007588}else{ft=b^c^d;kt=-899497514}t=add32(add32(rotateLeft32(a,5),ft),add32(add32(e,state[j]),kt));e=d;d=c;c=rotateLeft32(b,30);b=a;a=t}a=add32(a,a0);b=add32(b,b0);c=add32(c,c0);d=add32(d,d0);e=add32(e,e0);i+=16}return[a,b,c,d,e]};rotateLeft32=function(value,count){return value<<count|value>>>32-count};add32=function(a,b){var high,low;low=(a&65535)+(b&65535);high=(a>>16)+(b>>16)+(low>>16);return high<<16|low&65535};arrayToBase64=function(array){var i,i2,limit,string,trit;string="";i=0;limit=array.length*4;while(i<limit){i2=i;trit=(array[i2>>2]>>(3-(i2&3)<<3)&255)<<16;i2+=1;trit|=(array[i2>>2]>>(3-(i2&3)<<3)&255)<<8;i2+=1;trit|=array[i2>>2]>>(3-(i2&3)<<3)&255;string+=_base64Digits[trit>>18&63];string+=_base64Digits[trit>>12&63];i+=1;if(i>=limit){string+="="}else{string+=_base64Digits[trit>>6&63]}i+=1;if(i>=limit){string+="="}else{string+=_base64Digits[trit&63]}i+=1}return string};_base64Digits="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";stringToArray=function(string){var array,i,mask,_i,_ref;array=[];mask=255;for(i=_i=0,_ref=string.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){array[i>>2]|=(string.charCodeAt(i)&mask)<<(3-(i&3)<<3)}return array};Dropbox.Oauth=function(){function Oauth(options){this.key=this.k=null;this.secret=this.s=null;this.token=null;this.tokenSecret=null;this._appHash=null;this.reset(options)}Oauth.prototype.reset=function(options){var k,s,secret,_ref;if(options.secret){this.k=this.key=options.key;this.s=this.secret=options.secret;this._appHash=null}else if(options.key){this.key=options.key;this.secret=null;secret=atob(dropboxEncodeKey(this.key).split("|",2)[1]);_ref=secret.split("?",2),k=_ref[0],s=_ref[1];this.k=decodeURIComponent(k);this.s=decodeURIComponent(s);
this._appHash=null}else{if(!this.k){throw new Error("No API key supplied")}}if(options.token){return this.setToken(options.token,options.tokenSecret)}else{return this.setToken(null,"")}};Oauth.prototype.setToken=function(token,tokenSecret){if(token&&!tokenSecret){throw new Error("No secret supplied with the user token")}this.token=token;this.tokenSecret=tokenSecret||"";this.hmacKey=DropboxXhr.urlEncodeValue(this.s)+"&"+DropboxXhr.urlEncodeValue(tokenSecret);return null};Oauth.prototype.authHeader=function(method,url,params){var header,oauth_params,param,value,_i,_len;this.addAuthParams(method,url,params);oauth_params=[];for(param in params){value=params[param];if(param.substring(0,6)==="oauth_"){oauth_params.push(param)}}oauth_params.sort();header=[];for(_i=0,_len=oauth_params.length;_i<_len;_i++){param=oauth_params[_i];header.push(DropboxXhr.urlEncodeValue(param)+'="'+DropboxXhr.urlEncodeValue(params[param])+'"');delete params[param]}return"OAuth "+header.join(",")};Oauth.prototype.addAuthParams=function(method,url,params){this.boilerplateParams(params);params.oauth_signature=this.signature(method,url,params);return params};Oauth.prototype.boilerplateParams=function(params){params.oauth_consumer_key=this.k;params.oauth_nonce=this.nonce();params.oauth_signature_method="HMAC-SHA1";if(this.token){params.oauth_token=this.token}params.oauth_timestamp=Math.floor(Date.now()/1e3);params.oauth_version="1.0";return params};Oauth.prototype.nonce=function(){return Date.now().toString(36)+Math.random().toString(36)};Oauth.prototype.signature=function(method,url,params){var string;string=method.toUpperCase()+"&"+DropboxXhr.urlEncodeValue(url)+"&"+DropboxXhr.urlEncodeValue(DropboxXhr.urlEncode(params));return base64HmacSha1(string,this.hmacKey)};Oauth.prototype.appHash=function(){if(this._appHash){return this._appHash}return this._appHash=base64Sha1(this.k).replace(/\=/g,"")};return Oauth}();if(Date.now==null){Date.now=function(){return(new Date).getTime()}}DropboxOauth=Dropbox.Oauth;dropboxEncodeKey=function(key,secret){var i,k,result,s,x,y,z,_i,_j,_ref,_ref1,_results;if(secret){secret=[encodeURIComponent(key),encodeURIComponent(secret)].join("?");key=function(){var _i,_ref,_results;_results=[];for(i=_i=0,_ref=key.length/2;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){_results.push((key.charCodeAt(i*2)&15)*16+(key.charCodeAt(i*2+1)&15))}return _results}()}else{_ref=key.split("|",2),key=_ref[0],secret=_ref[1];key=atob(key);key=function(){var _i,_ref1,_results;_results=[];for(i=_i=0,_ref1=key.length;0<=_ref1?_i<_ref1:_i>_ref1;i=0<=_ref1?++_i:--_i){_results.push(key.charCodeAt(i))}return _results}();secret=atob(secret)}s=function(){_results=[];for(_i=0;_i<256;_i++){_results.push(_i)}return _results}.apply(this);y=0;for(x=_j=0;_j<256;x=++_j){y=(y+s[i]+key[x%key.length])%256;_ref1=[s[y],s[x]],s[x]=_ref1[0],s[y]=_ref1[1]}x=y=0;result=function(){var _k,_ref2,_ref3,_results1;_results1=[];for(z=_k=0,_ref2=secret.length;0<=_ref2?_k<_ref2:_k>_ref2;z=0<=_ref2?++_k:--_k){x=(x+1)%256;y=(y+s[x])%256;_ref3=[s[y],s[x]],s[x]=_ref3[0],s[y]=_ref3[1];k=s[(s[x]+s[y])%256];_results1.push(String.fromCharCode((k^secret.charCodeAt(z))%256))}return _results1}();key=function(){var _k,_ref2,_results1;_results1=[];for(i=_k=0,_ref2=key.length;0<=_ref2?_k<_ref2:_k>_ref2;i=0<=_ref2?++_k:--_k){_results1.push(String.fromCharCode(key[i]))}return _results1}();return[btoa(key.join("")),btoa(result.join(""))].join("|")};Dropbox.PulledChanges=function(){PulledChanges.parse=function(deltaInfo){if(deltaInfo&&typeof deltaInfo==="object"){return new Dropbox.PulledChanges(deltaInfo)}else{return deltaInfo}};PulledChanges.prototype.blankSlate=void 0;PulledChanges.prototype.cursorTag=void 0;PulledChanges.prototype.changes=void 0;PulledChanges.prototype.shouldPullAgain=void 0;PulledChanges.prototype.shouldBackOff=void 0;function PulledChanges(deltaInfo){var entry;this.blankSlate=deltaInfo.reset||false;this.cursorTag=deltaInfo.cursor;this.shouldPullAgain=deltaInfo.has_more;this.shouldBackOff=!this.shouldPullAgain;if(deltaInfo.cursor&&deltaInfo.cursor.length){this.changes=function(){var _i,_len,_ref,_results;_ref=deltaInfo.entries;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){entry=_ref[_i];_results.push(Dropbox.PullChange.parse(entry))}return _results}()}else{this.changes=[]}}return PulledChanges}();Dropbox.PullChange=function(){PullChange.parse=function(entry){if(entry&&typeof entry==="object"){return new Dropbox.PullChange(entry)}else{return entry}};PullChange.prototype.path=void 0;PullChange.prototype.wasRemoved=void 0;PullChange.prototype.stat=void 0;function PullChange(entry){this.path=entry[0];this.stat=Dropbox.Stat.parse(entry[1]);if(this.stat){this.wasRemoved=false}else{this.stat=null;this.wasRemoved=true}}return PullChange}();Dropbox.PublicUrl=function(){PublicUrl.parse=function(urlData,isDirect){if(urlData&&typeof urlData==="object"){return new Dropbox.PublicUrl(urlData,isDirect)}else{return urlData}};PublicUrl.prototype.url=void 0;PublicUrl.prototype.expiresAt=void 0;PublicUrl.prototype.isDirect=void 0;PublicUrl.prototype.isPreview=void 0;function PublicUrl(urlData,isDirect){this.url=urlData.url;this.expiresAt=new Date(Date.parse(urlData.expires));if(isDirect===true){this.isDirect=true}else if(isDirect===false){this.isDirect=false}else{this.isDirect=Date.now()-this.expiresAt<=864e5}this.isPreview=!this.isDirect}return PublicUrl}();Dropbox.CopyReference=function(){CopyReference.parse=function(refData){if(refData&&(typeof refData==="object"||typeof refData==="string")){return new Dropbox.CopyReference(refData)}else{return refData}};CopyReference.prototype.tag=void 0;CopyReference.prototype.expiresAt=void 0;function CopyReference(refData){if(typeof refData==="object"){this.tag=refData.copy_ref;this.expiresAt=new Date(Date.parse(refData.expires))}else{this.tag=refData;this.expiresAt=new Date}}return CopyReference}();Dropbox.Stat=function(){Stat.parse=function(metadata){if(metadata&&typeof metadata==="object"){return new Dropbox.Stat(metadata)}else{return metadata}};Stat.prototype.path=null;Stat.prototype.name=null;Stat.prototype.inAppFolder=null;Stat.prototype.isFolder=null;Stat.prototype.isFile=null;Stat.prototype.isRemoved=null;Stat.prototype.typeIcon=null;Stat.prototype.versionTag=null;Stat.prototype.mimeType=null;Stat.prototype.size=null;Stat.prototype.humanSize=null;Stat.prototype.hasThumbnail=null;Stat.prototype.modifiedAt=null;Stat.prototype.clientModifiedAt=null;function Stat(metadata){var lastIndex,nameSlash,_ref,_ref1;this.path=metadata.path;if(this.path.substring(0,1)!=="/"){this.path="/"+this.path}lastIndex=this.path.length-1;if(lastIndex>=0&&this.path.substring(lastIndex)==="/"){this.path=this.path.substring(0,lastIndex)}nameSlash=this.path.lastIndexOf("/");this.name=this.path.substring(nameSlash+1);this.isFolder=metadata.is_dir||false;this.isFile=!this.isFolder;this.isRemoved=metadata.is_deleted||false;this.typeIcon=metadata.icon;if((_ref=metadata.modified)!=null?_ref.length:void 0){this.modifiedAt=new Date(Date.parse(metadata.modified))}else{this.modifiedAt=null}if((_ref1=metadata.client_mtime)!=null?_ref1.length:void 0){this.clientModifiedAt=new Date(Date.parse(metadata.client_mtime))}else{this.clientModifiedAt=null}switch(metadata.root){case"dropbox":this.inAppFolder=false;break;case"app_folder":this.inAppFolder=true;break;default:this.inAppFolder=null}this.size=metadata.bytes||0;this.humanSize=metadata.size||"";this.hasThumbnail=metadata.thumb_exists||false;if(this.isFolder){this.versionTag=metadata.hash;this.mimeType=metadata.mime_type||"inode/directory"}else{this.versionTag=metadata.rev;this.mimeType=metadata.mime_type||"application/octet-stream"}}return Stat}();Dropbox.UserInfo=function(){UserInfo.parse=function(userInfo){if(userInfo&&typeof userInfo==="object"){return new Dropbox.UserInfo(userInfo)}else{return userInfo}};UserInfo.prototype.name=null;UserInfo.prototype.email=null;UserInfo.prototype.countryCode=null;UserInfo.prototype.uid=null;UserInfo.prototype.referralUrl=null;UserInfo.prototype.publicAppUrl=null;UserInfo.prototype.quota=null;UserInfo.prototype.usedQuota=null;UserInfo.prototype.privateBytes=null;UserInfo.prototype.sharedBytes=null;function UserInfo(userInfo){var lastIndex;this.name=userInfo.display_name;this.email=userInfo.email;this.countryCode=userInfo.country||null;this.uid=userInfo.uid.toString();if(userInfo.public_app_url){this.publicAppUrl=userInfo.public_app_url;lastIndex=this.publicAppUrl.length-1;if(lastIndex>=0&&this.publicAppUrl.substring(lastIndex)==="/"){this.publicAppUrl=this.publicAppUrl.substring(0,lastIndex)}}else{this.publicAppUrl=null}this.referralUrl=userInfo.referral_link;this.quota=userInfo.quota_info.quota;this.privateBytes=userInfo.quota_info.normal||0;this.sharedBytes=userInfo.quota_info.shared||0;this.usedQuota=this.privateBytes+this.sharedBytes}return UserInfo}();if(typeof window!=="undefined"&&window!==null){if(window.XDomainRequest&&!("withCredentials"in new XMLHttpRequest)){DropboxXhrRequest=window.XDomainRequest;DropboxXhrIeMode=true;DropboxXhrCanSendForms=false}else{DropboxXhrRequest=window.XMLHttpRequest;DropboxXhrIeMode=false;DropboxXhrCanSendForms=window.navigator.userAgent.indexOf("Firefox")===-1}}else{DropboxXhrRequest=require("xmlhttprequest").XMLHttpRequest;DropboxXhrIeMode=false;DropboxXhrCanSendForms=false}Dropbox.Xhr=function(){function Xhr(){}Xhr.Request=DropboxXhrRequest;Xhr.ieMode=DropboxXhrIeMode;Xhr.canSendForms=DropboxXhrCanSendForms;Xhr.request=function(method,url,params,authHeader,callback){return this.request2(method,url,params,authHeader,null,null,callback)};Xhr.request2=function(method,url,params,authHeader,body,responseType,callback){var headers,paramsInUrl,queryString;paramsInUrl=method==="GET"||body!=null||this.ieMode;if(paramsInUrl){queryString=DropboxXhr.urlEncode(params);if(queryString.length!==0){url=[url,"?",DropboxXhr.urlEncode(params)].join("")}}headers={};if(authHeader){headers["Authorization"]=authHeader}if(body!=null){if(typeof body==="string"){headers["Content-Type"]="text/plain; charset=utf8"}}else if(!paramsInUrl){headers["Content-Type"]="application/x-www-form-urlencoded";body=DropboxXhr.urlEncode(params)}return DropboxXhr.xhrRequest(method,url,headers,body,responseType,callback)};Xhr.multipartRequest=function(url,fileField,params,authHeader,callback){var body,boundary,fileData,fileType,headers,useFormData;url=[url,"?",DropboxXhr.urlEncode(params)].join("");fileData=fileField.value;useFormData=typeof fileData==="object"&&(typeof Blob!=="undefined"&&Blob!==null&&fileField.value instanceof Blob||typeof File!=="undefined"&&File!==null&&fileField.value instanceof File);if(useFormData){headers={};body=new FormData;body.append(fileField.name,fileData,fileField.fileName)}else{fileType=fileField.contentType||"application/octet-stream";boundary=this.multipartBoundary();headers={"Content-Type":"multipart/form-data; boundary="+boundary};body=["--",boundary,"\r\n",'Content-Disposition: form-data; name="',fileField.name,'"; filename="',fileField.fileName,'"\r\n',"Content-Type: ",fileType,"\r\n","Content-Transfer-Encoding: binary\r\n\r\n",fileData,"\r\n","--",boundary,"--","\r\n"].join("")}if(authHeader){headers["Authorization"]=authHeader}return DropboxXhr.xhrRequest("POST",url,headers,body,null,callback)};Xhr.multipartBoundary=function(){return[Date.now().toString(36),Math.random().toString(36)].join("----")};Xhr.xhrRequest=function(method,url,headers,body,responseType,callback){var header,value,xhr;xhr=new this.Request;if(this.ieMode){xhr.onload=function(){return DropboxXhr.onLoad(xhr,method,url,callback)};xhr.onerror=function(){return DropboxXhr.onError(xhr,method,url,callback)}}else{xhr.onreadystatechange=function(){return DropboxXhr.onReadyStateChange(xhr,method,url,responseType,callback)}}xhr.open(method,url,true);if(responseType){if(responseType==="b"){if(xhr.overrideMimeType){xhr.overrideMimeType("text/plain; charset=x-user-defined")}}else{xhr.responseType=responseType}}if(!this.ieMode){for(header in headers){if(!__hasProp.call(headers,header))continue;value=headers[header];xhr.setRequestHeader(header,value)}}if(body!=null){xhr.send(body)}else{xhr.send()}return xhr};Xhr.urlEncode=function(object){var chunks,key,value;chunks=[];for(key in object){value=object[key];chunks.push(this.urlEncodeValue(key)+"="+this.urlEncodeValue(value))}return chunks.sort().join("&")};Xhr.urlEncodeValue=function(object){return encodeURIComponent(object.toString()).replace(/\!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")};Xhr.urlDecode=function(string){var kvp,result,token,_i,_len,_ref;result={};_ref=string.split("&");for(_i=0,_len=_ref.length;_i<_len;_i++){token=_ref[_i];kvp=token.split("=");result[decodeURIComponent(kvp[0])]=decodeURIComponent(kvp[1])}return result};Xhr.onReadyStateChange=function(xhr,method,url,responseType,callback){var apiError,bytes,dirtyText,e,i,metadata,metadataJson,text,_i,_ref;if(xhr.readyState!==4){return true}if(xhr.status<200||xhr.status>=300){apiError=new Dropbox.ApiError(xhr,method,url);callback(apiError);return true}metadataJson=xhr.getResponseHeader("x-dropbox-metadata");if(metadataJson!=null?metadataJson.length:void 0){try{metadata=JSON.parse(metadataJson)}catch(_error){e=_error;metadata=void 0}}else{metadata=void 0}if(responseType){if(responseType==="b"){dirtyText=xhr.responseText!=null?xhr.responseText:xhr.response;bytes=[];for(i=_i=0,_ref=dirtyText.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){bytes.push(String.fromCharCode(dirtyText.charCodeAt(i)&255))}text=bytes.join("");callback(null,text,metadata)}else{callback(null,xhr.response,metadata)}return true}text=xhr.responseText!=null?xhr.responseText:xhr.response;switch(xhr.getResponseHeader("Content-Type")){case"application/x-www-form-urlencoded":callback(null,DropboxXhr.urlDecode(text),metadata);break;case"application/json":case"text/javascript":callback(null,JSON.parse(text),metadata);break;default:callback(null,text,metadata)}return true};Xhr.onLoad=function(xhr,method,url,callback){var text;text=xhr.responseText;switch(xhr.contentType){case"application/x-www-form-urlencoded":callback(null,DropboxXhr.urlDecode(text),void 0);break;case"application/json":case"text/javascript":callback(null,JSON.parse(text),void 0);break;default:callback(null,text,void 0)}return true};Xhr.onError=function(xhr,method,url,callback){var apiError;apiError=new Dropbox.ApiError(xhr,method,url);callback(apiError);return true};return Xhr}();DropboxXhr=Dropbox.Xhr;if((typeof module!=="undefined"&&module!==null?module.exports:void 0)!=null){module.exports=Dropbox}else if(typeof window!=="undefined"&&window!==null){window.Dropbox=Dropbox}else{throw new Error("This library only supports node.js and modern browsers.")}Dropbox.atob=atob;Dropbox.btoa=btoa;Dropbox.hmac=base64HmacSha1;Dropbox.sha1=base64Sha1;Dropbox.encodeKey=dropboxEncodeKey;(function(){var $,Auth,Binary,Class,Client,DB,Events,Model,Nimbus,Share,isArray,makeArray,moduleKeywords;if(window.Nimbus==null){Nimbus=winodw.Nimbus={}}Nimbus=window.Nimbus;Nimbus.version="0.0.1";$=Nimbus.$=this.jQuery||this.Zepto||function(){return arguments[0]};Nimbus.dictModel={};makeArray=function(args){return Array.prototype.slice.call(args,0)};isArray=function(value){return Object.prototype.toString.call(value)==="[object Array]"};if(typeof Array.prototype.indexOf==="undefined"){Array.prototype.indexOf=function(value){var i;i=0;while(i<this.length){if(this[i]===value){return i}i++}return-1}}Events={bind:function(ev,callback){var calls,evs,i;evs=ev.split(" ");calls=this._callbacks||(this._callbacks={});i=0;while(i<evs.length){(this._callbacks[evs[i]]||(this._callbacks[evs[i]]=[])).push(callback);i++}return this},trigger:function(){var args,calls,ev,i,l,list;args=makeArray(arguments);ev=args.shift();if(!(calls=this._callbacks)){return false}if(!(list=this._callbacks[ev])){return false}i=0;l=list.length;while(i<l){if(list[i].apply(this,args)===false){return false}i++}return true},unbind:function(ev,callback){var calls,i,l,list;if(!ev){this._callbacks={};return this}if(!(calls=this._callbacks)){return this}if(!(list=calls[ev])){return this}if(!callback){delete this._callbacks[ev];return this}i=0;l=list.length;while(i<l){if(callback===list[i]){list=list.slice();list.splice(i,1);calls[ev]=list;break}i++}return this}};if(typeof Object.create!=="function"){Object.create=function(o){var F;F=function(){};F.prototype=o;return new F}}moduleKeywords=["included","extended"];Class={inherited:function(){},created:function(){},prototype:{initialize:function(){},init:function(){}},create:function(include,extend){var object;object=Object.create(this);object.parent=this;object.prototype=object.fn=Object.create(this.prototype);if(include){object.include(include)}if(extend){object.extend(extend)}object.created();this.inherited(object);return object},init:function(){var instance;instance=Object.create(this.prototype);instance.parent=this;instance.initialize.apply(instance,arguments);instance.init.apply(instance,arguments);return instance},proxy:function(func){var thisObject;thisObject=this;return function(){return func.apply(thisObject,arguments)}},proxyAll:function(){var functions,i,_results;functions=makeArray(arguments);i=0;_results=[];while(i<functions.length){this[functions[i]]=this.proxy(this[functions[i]]);_results.push(i++)}return _results},include:function(obj){var included,key;for(key in obj){if(moduleKeywords.indexOf(key)===-1){this.fn[key]=obj[key]}}included=obj.included;if(included){included.apply(this)}return this},extend:function(obj){var extended,key;for(key in obj){if(moduleKeywords.indexOf(key)===-1){this[key]=obj[key]}}extended=obj.extended;if(extended){extended.apply(this)}return this}};Class.prototype.proxy=Class.proxy;Class.prototype.proxyAll=Class.proxyAll;Class.inst=Class.init;Class.sub=Class.create;Nimbus.guid=function(){var id,verified,verify_guide;verify_guide=function(g_id){var x,y,_ref;_ref=Nimbus.dictModel;for(x in _ref){y=_ref[x];if(y.exists(g_id)){return false}}return true};verified=false;while(!verified){id="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r,v;r=Math.random()*16|0;v=c==="x"?r:r&3|8;return v.toString(16)}).toUpperCase();verified=verify_guide(id)}return id};Auth=Nimbus.Auth=Class.create();Auth.extend({reinitialize:function(){var cloud,service,sync_service;log("reintialize called");if(localStorage["last_sync_object"]!=null){log("the service exists",localStorage["service"]);sync_service=JSON.parse(localStorage["last_sync_object"]);if(Nimbus.Auth.sync_services==null){Nimbus.Auth.sync_services={};Nimbus.Auth.sync_services.synchronous=sync_service.synchronous}else{service=Nimbus.Auth.sync_services[sync_service.service];if(service.app_id!==sync_service.app_id){cloud=sync_service.service;sync_service=service;sync_service.service=cloud;localStorage.clear()}}this.setup(sync_service);return this.initialize()}},setup:function(sync_service){var item,key,service,value;if(typeof sync_service==="string"){console.log("Current sync service",sync_service);sync_service=JSON.parse(Base64.decode(sync_service))}if(!this.app_name){this.app_name=sync_service.app_name}if(!this.app_name){for(item in sync_service){if(sync_service[item].app_name){this.app_name=sync_service[item].app_name;if(this.app_name){break}}}}if(sync_service.service!=null){log("setup called on a service",sync_service.service);log("setup object",sync_service);for(key in sync_service){value=sync_service[key];this[key]=value}if(Nimbus.Auth.sync_services!=null&&Nimbus.Auth.sync_services.synchronous!=null){sync_service.synchronous=Nimbus.Auth.sync_services.synchronous}else{sync_service.synchronous=true}sync_service.app_name=this.app_name;localStorage["last_sync_object"]=JSON.stringify(sync_service);if(!sync_service.synchronous){Nimbus.Model.Local.async_doc_setup()}switch(this.service){case"Dropbox":this.extend(Nimbus.Auth.Dropbox_auth);this._authorize=this.proxy(this.authenticate_dropbox);this.initialize=this.proxy(this.initialize_dropbox);this.authorized=this.proxy(this.dropbox_authorized);this.logout=function(){this.proxy(this.logout_dropbox);this.clear_storage()};Nimbus.Binary.setup(this.service);log("service is dropbox");break;case"GDrive":this.extend(Nimbus.Auth.GDrive);this.init_scope();this._authorize=this.proxy(this.authenticate_gdrive);this.initialize=this.proxy(this.initialize_gdrive);this.authorized=this.proxy(this.gdrive_authorized);this.logout=function(){this.proxy(this.logout_gdrive);this.clear_storage()};Nimbus.Binary.setup(this.service);log("service is GDrive");Nimbus.Share.setup(this.service);break;case"Realtime":startRealtime(key,app_name);break;default:log("Invalid service name")}}else{log("new method for setup, the service is there");this.sync_services=this.sync_object=sync_service;this.models={};if(localStorage["service"]!=null){if(localStorage["service"]==="GDrive"){service=this.sync_services["GDrive"];service["service"]="GDrive";this.setup(service)}else{service=this.sync_services["Dropbox"];service["service"]="Dropbox";this.setup(service)}}else{this.extend(Nimbus.Auth.Multi);this._authorize=this.proxy(this.authenticate_service);this.initialize=this.proxy(this.initialize_service)}}this.authorize=function(type){var obj;if(this.service&&type&&type!==this.service){localStorage.clear();obj=this.sync_object[type];obj.service=type;this.setup(obj)}return this._authorize(type)}},clear_storage:function(){log("Will clear localStorage or indexedDB");localStorage.clear();PouchDB.destroy(this.app_name)},authorized:function(){return log("authorized not yet setup")},state:function(){return localStorage["state"]},authorize:function(){return log("authorize not yet setup")},initialize:function(){return log("initialize not setup")},authorized_callback:function(){return log("authorized callback undefined")},app_ready_func:function(){log("app_ready");return this.app_ready=true},set_app_ready:function(callback){var cb;log("set app ready");if(this.app_ready!=null&&this.app_ready){if(this.service==="GDrive"){return window.folder_initialize(callback)}else{return callback()}}else{cb=function(){if(this.service==="GDrive"){return window.folder_initialize(callback)}else{return callback()}};return this.app_ready_func=cb}},logout:function(){return log("logout not implemented")}});Client=Nimbus.Client=Class.create();Share=Nimbus.Share=Class.create();Share.extend({setup:function(sync_service){switch(sync_service){case"GDrive":log("share api with GDrive");this.extend(Nimbus.Client.GDrive);this.get_users=this.proxy(this.get_shared_users);this.add_user=this.proxy(this.add_share_user);this.remove_user=this.proxy(this.remove_share_user);this.get_me=this.proxy(this.get_current_user);this.get_spaces=this.proxy(this.get_app_folders);this.switch_spaces=this.proxy(this.switch_to_app_folder);return this.switch_file_real=this.proxy(this.switch_to_app_file_real);default:return log("share not supported with this service")}},get_users:function(){return log("users not implemented")},add_user:function(email){return log("add a user")},remove_user:function(id){return log("removed user")},get_me:function(){return log("get currently logged user")},get_spaces:function(){return log("get current spaces")},switch_spaces:function(id){return log("switch space")}});Binary=Nimbus.Binary=Class.create();Binary.extend({setup:function(sync_service){log("binary setup called");switch(sync_service){case"Dropbox":this.extend(Nimbus.Client.Dropbox.Binary);Nimbus.Client.Dropbox.Binary.binary_setup();return log("service is dropbox");case"GDrive":this.extend(Nimbus.Client.GDrive.Binary);Nimbus.Client.GDrive.Binary.binary_setup();return log("service is GDrive");case"Realtime":return log("service is  Realtime");default:return log("Invalid service name")}},upload_blob:function(blob,name,callback){return log("upload blob")},upload_file:function(file,callback){return log("upload blob")},read_file:function(binary,callback){return log("read file")},share_link:function(binary,callback){return log("share link")},direct_link:function(binary,callback){return log("direct link")},delete_file:function(binary){return log("delete file")}});DB=Nimbus.DB=Class.create();DB.extend(Events);DB.extend({setup_db:function(type){log("setup db");switch(type){case"localStorage":return Storage.prototype.setItem=function(key,value){if(this===window.localStorage){return log("local storage called")}else{return _setItem.apply(this,arguments)}}}}});Model=Nimbus.Model=Class.create();Model.extend(Events);Model.extend({loaded:false,check_loaded:function(){if(this.loaded){return true}else{console.log("The model is not loaded yet! Wait for the model to be done with setup.");return false}},service_setup:function(model){var atts;log("service setup model",model);atts=model.attributes;switch(Nimbus.Auth.service){case"Dropbox":log("extend as Dropbox");model.extend(Nimbus.Model.general_sync);model.extend(Nimbus.Model.Dropbox);atts.push("synced");atts.push("time");model.attributes=atts;break;case"GDrive":log("extend as GDrive");model.extend(Nimbus.Model.general_sync);model.extend(Nimbus.Model.Realtime);atts.push("gid");atts.push("synced");atts.push("time");atts.push("type");model.attributes=atts;break;default:log("Invalid service name")}return model},setup:function(name,atts,callback){var Deletion,model;log("model setup");model=Model.sub();if(name){model.name=name}if(atts){model.attributes=atts}if(Nimbus.Auth.sync_services.synchronous!=null&&Nimbus.Auth.sync_services.synchronous){model.extend(Nimbus.Model.LocalSync)}else{model.extend(Nimbus.Model.Local)}Nimbus.dictModel[name]=model;if(Nimbus.Auth.service!=null||Nimbus.Auth.sync_services!=null||name==="binary"||name==="binary_Deletion"){log("model 1",model);if(name.indexOf("_Deletion")<0){model=this.service_setup(model)}}else{log("name:",name);log("Please setup Nimbus.Auth first before creating models")}if(name.indexOf("_Deletion")<0){Deletion=Nimbus.Model.setup(name+"_"+"Deletion",["deletion_id","listid"]);Deletion.extend(Nimbus.Model.Local);Deletion.fetch();model.DeletionStorage=Deletion}log(model);model.fetch();if(name.indexOf("_Deletion")<0){Nimbus.dictModel[name]=model}else{delete Nimbus.dictModel[name]}return model},created:function(sub){this.records={};return this.attributes=this.attributes?makeArray(this.attributes):[]},find:function(id){var record;record=this.records[id];if(!record){throw"Unknown record"}return record.clone()},exists:function(id){var e;try{return this.find(id)}catch(_error){e=_error;return false}},refresh:function(values){var i,il,record;values=this.fromJSON(values);this.records={};i=0;il=values.length;while(i<il){record=values[i];record.newRecord=false;this.records[record.id]=record;i++}this.trigger("refresh");return this},select:function(callback){var key,result;result=[];for(key in this.records){if(callback(this.records[key])){result.push(this.records[key])}}return this.cloneArray(result)},findByAttribute:function(name,value){var key;for(key in this.records){if(this.records[key][name]===value){return this.records[key].clone()}}},findAllByAttribute:function(name,value){return this.select(function(item){return item[name]===value})},each:function(callback){var key,_results;_results=[];for(key in this.records){_results.push(callback(this.records[key]))}return _results},all:function(){return this.cloneArray(this.recordsValues())},first:function(){var record;record=this.recordsValues()[0];return record&&record.clone()},last:function(){var record,values;values=this.recordsValues();record=values[values.length-1];return record&&record.clone()},count:function(){return this.recordsValues().length},deleteAll:function(){var key,_results;_results=[];for(key in this.records){_results.push(delete this.records[key])}return _results},destroyAll:function(){var key,_results;_results=[];for(key in this.records){_results.push(this.records[key].destroy())}return _results},update:function(id,atts){return this.find(id).updateAttributes(atts)},create:function(atts){var record;record=this.init(atts);return record.save()},destroy:function(id){return this.find(id).destroy()},sync:function(callback){return this.bind("change",callback)},fetch:function(callbackOrParams){if(!this.loaded&&callbackOrParams!=null){this.loadLocal(callbackOrParams)}if(typeof callbackOrParams==="function"){return this.bind("fetch",callbackOrParams)}else{return this.trigger.apply(this,["fetch"].concat(makeArray(arguments)))}},toJSON:function(){return this.recordsValues()},fromJSON:function(objects){var i,results;if(!objects){return}if(typeof objects==="string"){objects=JSON.parse(objects)}if(isArray(objects)){results=[];i=0;while(i<objects.length){results.push(this.init(objects[i]));i++}return results}else{return this.init(objects)}},recordsValues:function(){var key,result;result=[];for(key in this.records){result.push(this.records[key])}return result},cloneArray:function(array){var i,result;result=[];i=0;while(i<array.length){result.push(array[i].clone());i++}return result}});return Model.include({model:true,newRecord:true,init:function(atts){var parent_type;if(atts){this.load(atts)}parent_type=this.parent.name;this.parent=function(){return Nimbus.dictModel[parent_type]};return this.trigger("init",this)},isNew:function(){return this.newRecord},isValid:function(){return!this.validate()},validate:function(){},load:function(atts){var name,_results;_results=[];for(name in atts){_results.push(this[name]=atts[name])}return _results},attributes:function(){var attr,i,result;result={};i=0;while(i<this.parent().attributes.length){attr=this.parent().attributes[i];result[attr]=this[attr];i++}result.id=this.id;return result},eql:function(rec){return rec&&rec.id===this.id&&rec.parent()===this.parent()},save:function(){var error;error=this.validate();if(error){this.trigger("error",this,error);return false}this.trigger("beforeSave",this);if(this.newRecord){this.create()}else{this.update()}this.trigger("save",this);return this},updateAttribute:function(name,value){this[name]=value;return this.save()},updateAttributes:function(atts){this.load(atts);return this.save()},destroy:function(){this.trigger("beforeDestroy",this);delete this.parent().records[this.id];this.destroyed=true;this.trigger("destroy",this);return this.trigger("change",this,"destroy")},dup:function(){var result;result=this.parent().init(this.attributes());result.newRecord=this.newRecord;return result},clone:function(){return Object.create(this)},reload:function(){var original;if(this.newRecord){return this}original=this.parent().find(this.id);this.load(original.attributes());return original},toJSON:function(){return this.attributes()},exists:function(){return this.id&&this.id in this.parent().records},update:function(){var clone,records;this.trigger("beforeUpdate",this);records=this.parent().records;records[this.id].load(this.attributes());clone=records[this.id].clone();this.trigger("update",clone);return this.trigger("change",clone,"update")},create:function(){var clone,records;this.trigger("beforeCreate",this);if(!this.id){this.id=Nimbus.guid()}this.newRecord=false;records=this.parent().records;records[this.id]=this.dup();clone=records[this.id].clone();this.trigger("create",clone);return this.trigger("change",clone,"create")},bind:function(events,callback){return this.parent().bind(events,this.proxy(function(record){if(record&&this.eql(record)){return callback.apply(this,arguments)}}))},trigger:function(){var e;try{return this.parent().trigger.apply(this.parent(),arguments)}catch(_error){e=_error;return log(e)}}})})();Set=function(){function Set(set){this._set=set===void 0?[]:set;this.length=this._set.length;this.contains=function(element){return this._set.indexOf(element)!==-1}}Set.prototype.union=function(s){var A,B,i,set;A=s.length>this.length?s:this;B=s.length>this.length?this:s;set=A.copy();i=0;while(i<B.length){set.add(B._set[i]);i++}return set};Set.prototype.intersection=function(s){var A,B,element,i,set;set=new Set;A=s.length>this.length?s:this;B=s.length>this.length?this:s;i=0;while(i<B.length){element=B._set[i];if(A.contains(element)){set.add(element)
}i++}return set};Set.prototype.difference=function(s){var element,i,set;set=new Set;i=0;while(i<this.length){element=this._set[i];if(!s.contains(element)){set.add(element)}i++}return set};Set.prototype.symmetricDifference=function(s){return this.union(s).difference(this.intersection(s))};Set.prototype.isSuperSet=function(s){var i;i=0;while(i<s.length){if(!this.contains(s._set[i])){return false}i++}return true};Set.prototype.isSubSet=function(s){var i;i=0;while(i<this.length){if(!s.contains(this._set[i])){return false}i++}return true};Set.prototype.add=function(element){if(this._set.indexOf(element)===-1){this._set.push(element);this.length++}return this.length};Set.prototype.remove=function(element){var i;i=this._set.indexOf(element);if(i!==-1){this.length--;return this._set.splice(i,1)[0]}else{return null}};Set.prototype.copy=function(){return new Set(this._set.slice())};Set.prototype.asArray=function(){return this._set};return Set}();exports=this;exports.Set=Set;DelayedOp=function(){function DelayedOp(callback){this.callback=callback;this.ready=__bind(this.ready,this);this.ok=__bind(this.ok,this);this.wait=__bind(this.wait,this);this.count=1}DelayedOp.prototype.wait=function(){return this.count++};DelayedOp.prototype.ok=function(){if(!--this.count){return this.callback()}};DelayedOp.prototype.ready=function(){return this.ok()};return DelayedOp}();OneOp=function(){function OneOp(){this.execute_callback=__bind(this.execute_callback,this);this.add_last_call=__bind(this.add_last_call,this);this.add_call=__bind(this.add_call,this);this.running=false;this.callbacks=[]}OneOp.prototype.add_call=function(callback){this.running=true;return this.callbacks.push(callback)};OneOp.prototype.add_last_call=function(callback){return this.last_callback=callback};OneOp.prototype.execute_callback=function(){var func,_i,_len,_ref;_ref=this.callbacks;for(_i=0,_len=_ref.length;_i<_len;_i++){func=_ref[_i];func()}this.callbacks=[];if(this.last_callback!=null){this.last_callback()}return this.running=false};return OneOp}();DelayedSyncAnimation=function(){function DelayedSyncAnimation(){this.ready=__bind(this.ready,this);this.ok=__bind(this.ok,this);this.wait=__bind(this.wait,this);this.count=1}DelayedSyncAnimation.prototype.wait=function(){return this.count++};DelayedSyncAnimation.prototype.ok=function(){if(!--this.count){return log("ok executed")}};DelayedSyncAnimation.prototype.ready=function(){return this.ok()};return DelayedSyncAnimation}();exports=this;exports.DelayedOp=DelayedOp;exports.OneOp=OneOp;exports.DelayedSyncAnimation=DelayedSyncAnimation;window.debug=false;window.log=function(){var stuff;stuff=1<=arguments.length?__slice.call(arguments,0):[];if(window.debug){return console.log(stuff)}};window.one_time_sync=false;window.keys=function(item){var key,keys,value;keys=[];for(key in item){value=item[key];keys.push(key)}return keys};Nimbus.Model.general_sync={cloudcache:{},create_object_dictionary:function(){var dict,obj,_i,_len,_ref;dict={};log("object:",this);_ref=this.all();for(_i=0,_len=_ref.length;_i<_len;_i++){obj=_ref[_i];dict[obj.id]=obj}return dict},sync_model_base_algo:function(){var cloud,cloud_set,cloud_time,d_array,deleted_set,dlist,eq,id,local,local_item,local_set,local_time,utc,utl,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1,_ref2,_ref3;if(!navigator.onLine||this.is_cloud_available===false){return}log("#ONE TIME SYNC ALGO RUNNING",this.name);window.one_time_sync=true;window.currently_syncing=true;local=this.create_object_dictionary();cloud=this.cloudcache;local_set=new Set(keys(local));cloud_set=new Set(keys(cloud));log("local_set",local_set);log("cloud_set",cloud_set);d_array=[];_ref=this.DeletionStorage.all();for(_i=0,_len=_ref.length;_i<_len;_i++){dlist=_ref[_i];this.delete_from_cloud(dlist.id);d_array.push(dlist.id);dlist.destroy()}deleted_set=new Set(d_array);log("deleted set",deleted_set);log("#the set of ids that are there locally but not there on the cloud",local_set.difference(cloud_set)._set);_ref1=local_set.difference(cloud_set)._set;for(_j=0,_len1=_ref1.length;_j<_len1;_j++){id=_ref1[_j];local_item=local[id];if(local_item["synced"]!=null&&local_item.synced){log("id for deletion",id);local[id].destroy()}else{this.add_to_cloud(local_item)}}log("#the set of ids that are there on the cloud but not there locally minus deletions",cloud_set.difference(local_set).difference(deleted_set)._set);_ref2=cloud_set.difference(local_set).difference(deleted_set)._set;for(_k=0,_len2=_ref2.length;_k<_len2;_k++){id=_ref2[_k];this.add_from_cloud(id)}log("#the set of ids that are there in the cloud and locally",cloud_set.intersection(local_set)._set);utc=[];utl=[];eq=[];_ref3=cloud_set.intersection(local_set)._set;for(_l=0,_len3=_ref3.length;_l<_len3;_l++){id=_ref3[_l];local_time=new Date(local[id].time);cloud_time=new Date(cloud[id].time);log("local_time",local_time.toString());log("cloud_time",cloud_time.toString());if(local_time-cloud_time===0){log("equal time stamp do nothin",cloud[id].title);eq.push(id)}else if(local_time-cloud_time>0){this.update_to_cloud(local[id]);utc.push(id)}else{this.update_to_local(local[id]);utl.push(id)}}window.currently_syncing=false;window.one_time_sync=false;log("updated to cloud",utc.length,utc);log("updated to local",utl.length,utl);return log("equal timestamp",eq.length,eq)},real_time_sync:function(record,method,e){var d,syncable;log("method",method);log("record",record);this.saveLocal(record,method);if(window.currently_syncing){return true}else{if(method==="update"){this.records[record.id].time=(new Date).toString()}}syncable=navigator.onLine&&(localStorage["state"]==="Working"||Nimbus.Client.GDrive.check_auth());if(!syncable){console.log("syncing is not setup correctly or the instance is not online");return true}switch(method){case"destroy":if(record.synced){if(syncable){log("deletion in cloud");return this.delete_from_cloud(record.id)}else{d=Deletion.init({id:record.id});return d.save()}}break;case"create":return this.add_to_cloud(record,function(){});case"update":return this.update_to_cloud(record,function(){});case"read":return this.update_to_local(record,function(){});default:return log("REAL TIME SYNCING FAILED, THIS METHOD NOT IMPLEMENTED")}},delta_update:function(){var change;return change=this.get_delta}};Nimbus.Model.Local={classname:"Nimbus.Model.Local",extended:function(){this.sync(this.proxy(this.saveLocal));return this.fetch(this.proxy(this.loadLocal))},async_doc_setup:function(){if(!window._indexdb&&Nimbus.Auth.app_name){window._indexdb=new PouchDB(Nimbus.Auth.app_name);Nimbus.Storage={};Nimbus.is_async_done=false;_indexdb.allDocs({include_docs:true},function(err,response){var doc,one,rows,_i,_len;if(!err){rows=response.rows;for(_i=0,_len=rows.length;_i<_len;_i++){one=rows[_i];doc=one.doc;if(doc["type"]&&doc.data){if(!Nimbus.Storage[doc["type"]]){Nimbus.Storage[doc["type"]]=[]}Nimbus.Storage[doc["type"]].push(JSON.parse(doc.data))}}return Nimbus.is_async_done=true}})}},saveLocal:function(record,method){var db,result,self,_data,_i,_len,_ref;if(!window._indexdb&&Nimbus.Auth.app_name){window._indexdb=new PouchDB(Nimbus.Auth.app_name)}if(!window._indexdb){result=JSON.stringify(this);localStorage[this.name]=result;return}db=window._indexdb;self=this;if(record){_data={_id:record.id,type:this.name,data:JSON.stringify(record)};db.get(record.id,function(err,res){if(!err){return db.remove(res,function(e,r){if(method==="destroy"){return}return db.put(_data)})}else{return db.put(_data)}})}else{_ref=this.records;for(_i=0,_len=_ref.length;_i<_len;_i++){record=_ref[_i];_data={_id:key,type:this.name,data:JSON.stringify(record)};db.get(key,function(err,res){if(!err){_data._rev=res._rev}return db.put(_data)})}}},loadLocal:function(callback){var db,name,result,self;if(!window._indexdb&&Nimbus.Auth.app_name){window._indexdb=new PouchDB(Nimbus.Auth.app_name)}if(!window._indexdb){result=localStorage[this.name];if(!result){return}result=JSON.parse(result);this.refresh(result);return}self=this;db=window._indexdb;name=self.type;if(Nimbus.is_async_done){if(Nimbus.Storage[name]){self.refresh(Nimbus.Storage[name])}else{self.refresh([])}}else{self.refresh([])}}};Nimbus.Model.LocalSync={classname:"Nimbus.Model.LocalSync",extended:function(){this.sync(this.proxy(this.saveLocal));return this.fetch(this.proxy(this.loadLocal))},saveLocal:function(){var result;result=JSON.stringify(this);return localStorage[this.name]=result},loadLocal:function(callback){var result;result=localStorage[this.name];if(!result){return}result=JSON.parse(result);this.refresh(result);if(callback!=null){return callback()}}};Nimbus.Model.Dropbox={cloudcache:{},last_hash:"",hash:"",toCloudStructure:function(object){log("local to cloud structure");return JSON.stringify(object)},fromCloudStructure:function(value){log("changes cloud to local data in the form a dictionary");return value},diff_objects:function(previous,current){var diff,f,v;diff={};for(f in previous){v=previous[f];if(current[f]!==previous[f]){diff[f]=[current[f],previous[f]]}}if(previous["parent_id"]!=null!==(current["parent_id"]!=null)){diff["parent_id"]=["one of them is null"]}return diff},add_to_cloud:function(object,callback){log("add to cloud",object.name);return Nimbus.Client.Dropbox.putFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object.id+".txt"),this.toCloudStructure(object),function(resp){log(object.name,"finished being added to cloud");log("resp",resp);window.currently_syncing=true;object.time=resp.modified;object.synced=true;object.save();window.currently_syncing=false;if(callback!=null){return callback(resp)}})},delete_from_cloud:function(object_id,callback){log("delete from cloud",object_id);log("delete route","/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object_id+".txt"));return Nimbus.Client.Dropbox.deletePath("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object_id+".txt"),function(){log("finished delete from cloud",object_id);if(callback!=null){return callback()}})},update_to_cloud:function(object,callback){log("updated to cloud",object.name);return Nimbus.Client.Dropbox.putFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object.id+".txt"),this.toCloudStructure(object),function(resp){log(object.name,"finished being updated to cloud");window.currently_syncing=true;object.time=resp.modified;object.synced=true;object.save();window.currently_syncing=false;if(callback!=null){return callback(resp)}})},add_from_cloud:function(object_id,callback){log("add from cloud",object_id);return Nimbus.Client.Dropbox.getFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object_id+".txt"),function(_this){return function(data){var converted,x;log("cloud read data",data);window.currently_syncing=true;converted=_this.fromCloudStructure(data);x=_this.init(converted);x.synced=true;x.time=_this.cloudcache[object_id].time;x.save();window.currently_syncing=false;if(callback!=null){return callback(data)}}}(this))},update_to_local:function(object,callback){log("update to local",object.name);return Nimbus.Client.Dropbox.getFileContents("/"+Nimbus.Auth.app_name+("/"+this.name+"/"+object.id+".txt"),function(_this){return function(data){var converted,x;log("cloud read data",data);window.currently_syncing=true;converted=_this.fromCloudStructure(data);x=_this.find(object.id);converted.time=_this.cloudcache[object.id].time;x.updateAttributes(converted);return window.currently_syncing=false}}(this))},sync_all:function(cb){log("syncs all the data, normally happens at the start of a program or coming back from offline");window.current_syncing=new DelayedOp(function(_this){return function(){log("call back sync called");window.current_syncing=new DelayedOp(function(){window.current_syncing=null;if(cb!=null){return cb()}});_this.sync_model_base_algo();return window.current_syncing.ready()}}(this));this.load_all_from_cloud();return window.current_syncing.ready()},load_all_from_cloud:function(){var error;log("loads all the data from the cloud locally, probably not feasible with dropbox and changes need to happen");this.cloudcache={};try{return Nimbus.Client.Dropbox.getMetadataList("/"+Nimbus.Auth.app_name+"/"+this.name,function(_this){return function(data){var id,title,x,_i,_len,_ref;log("call back load called");log("data",data);_ref=data.contents;for(_i=0,_len=_ref.length;_i<_len;_i++){x=_ref[_i];title=x.path;id=title.replace("/"+Nimbus.Auth.app_name+"/"+(""+_this.name+"/"),"").replace(".txt","");_this.cloudcache[id]={id:id,time:x.modified}}return _this.is_cloud_available=true}}(this),function(_this){return function(error){console.log("ERROR: error called for metadataList, folder should be created");_this.is_cloud_available=false;Nimbus.Client.Dropbox.createFolder("/"+Nimbus.Auth.app_name+"/"+_this.name,function(data){return log("call back create folder called",data)});return _this.cloudcache={}}}(this))}catch(_error){error=_error;_this.is_cloud_available=false;return log("trying to get the folder failed, probably cuz it don't exist",error)}},get_delta:function(){return log("get the delta for ",this.name," since last synced")},extended:function(){this.sync(this.proxy(this.real_time_sync));return this.fetch(this.proxy(this.loadLocal))}};Nimbus.Auth.Dropbox_auth={authenticate_dropbox:function(){localStorage["key"]=this.key;localStorage["secret"]=this.secret;localStorage["state"]="Auth";return Nimbus.Client.Dropbox.get_request_token(this.key,this.secret,Nimbus.Client.Dropbox.authorize_token)},initialize_dropbox:function(){log("initialization called");if(location.protocol==="chrome-extension:"){log("Chrome edition authentication");chrome.tabs.onUpdated.addListener(function(tabId,changeInfo,tab){if(tab.title==="API Request Authorized"){chrome.tabs.remove(tabId);return Nimbus.Client.Dropbox.get_access_token(function(data){localStorage["state"]="Working";if(Nimbus.Auth.authorized_callback!=null){Nimbus.Auth.authorized_callback()}Nimbus.Auth.app_ready_func();console.log("NimbusBase is working! Chrome edition.");return Nimbus.track.google.registered_user()})}})}if(localStorage["state"]!=null&&localStorage["state"]==="Auth"){return Nimbus.Client.Dropbox.get_access_token(function(data){localStorage["state"]="Working";if(Nimbus.Auth.authorized_callback!=null){Nimbus.Auth.authorized_callback()}Nimbus.Auth.app_ready_func();console.log("NimbusBase is working!");return Nimbus.track.google.registered_user()})}else{return Nimbus.Auth.app_ready_func()}},dropbox_authorized:function(){if(Nimbus.Auth.service==="Dropbox"){if(localStorage["state"]==="Working"){return true}else{return false}}else{return false}},logout_dropbox:function(callback){var k,v,_ref;localStorage.clear();if(Nimbus.dictModel!=null){_ref=Nimbus.dictModel;for(k in _ref){v=_ref[k];v.records={}}}if(this.sync_services!=null){Nimbus.Auth.setup(this.sync_services)}if(callback!=null){return callback()}}};REALTIME_MIMETYPE="application/vnd.google-apps.drive-sdk";realTimeEvents={};Nimbus.Model.Realtime={cloudcache:{},callback:[],toCloudStructure:function(object){log("local to cloud structure");object["type"]=this.name;return JSON.stringify(object)},fromCloudStructure:function(value){log("changes cloud to local data in the form a dictionary");return JSON.parse(value)},diff_objects:function(previous,current){var diff,f,v;diff={};for(f in previous){v=previous[f];if(current[f]!==previous[f]){diff[f]=[current[f],previous[f]]}}if(previous["parent_id"]!=null!==(current["parent_id"]!=null)){diff["parent_id"]=["one of them is null"]}return diff},add_to_cloud:function(object,callback){var content;log("add to cloud",object);window.currently_syncing=true;object.time=(new Date).toString();object.type=this.name;object.synced=true;object.save();window.currently_syncing=false;content=this.toCloudStructure(object);return window.todo.set(object.id,content)},delete_from_cloud:function(object_id,callback){log("delete from cloud",object_id,window.todo.has(object_id));if(window.todo.has(object_id)){return window.todo["delete"](object_id)}},update_to_cloud:function(object,callback){var content;log("updated to cloud",object.id);content=this.toCloudStructure(object);return window.todo.set(object.id,content)},add_from_cloud:function(object_id,callback){var converted,data,x;log("add from cloud GDrive",object_id);data=window.todo.get(object_id);window.currently_syncing=true;converted=this.fromCloudStructure(data);x=this.init(converted);x.synced=true;x.save();return window.currently_syncing=false},update_to_local:function(object,callback){var converted,data,x;log("update to local",object);data=window.todo.get(object.id);window.currently_syncing=true;converted=this.fromCloudStructure(data);x=this.init(converted);x.synced=true;x.save();return window.currently_syncing=false},sync_all:function(cb){log("syncs all the data, normally happens at the start of a program or coming back from offline");this.load_all_from_cloud();this.sync_model_base_algo();window.current_syncing=new DelayedOp(function(_this){return function(){log("call back sync called");window.current_syncing=new DelayedOp(function(){window.current_syncing=null;if(cb!=null){return cb()}});_this.sync_model_base_algo();return window.current_syncing.ready()}}(this));this.load_all_from_cloud();return window.current_syncing.ready()},load_all_from_cloud:function(){var content,x,_i,_len,_ref,_results;log("loads all the data from the cloud locally");this.cloudcache={};_ref=window.todo.keys();_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){x=_ref[_i];content=this.fromCloudStructure(window.todo.get(x));if(content.type===this.name){_results.push(this.cloudcache[x]=content)}else{_results.push(void 0)}}return _results},get_delta:function(){return log("get the delta for ",this.name," since last synced")},add_realtime_callback:function(callback){return log("filler")},process_callback_chain:function(mode,obj,isLocal){var handler,index,_ref;log("filler");_ref=realTimeEvents[this.name];for(index in _ref){handler=_ref[index];handler(mode,obj,isLocal)}},extended:function(){this.sync(this.proxy(this.real_time_sync));return this.fetch(this.proxy(this.loadLocal))},onUpdate:function(callback){if(!realTimeEvents[this.name]){realTimeEvents[this.name]=[]}return realTimeEvents[this.name].push(callback)}};window.initializeModel=function(model){var field;log("model initialization",model);field=model.createMap({});return model.getRoot().set("todo",field)};window.onFileLoaded=function(doc){var process_event,todo;log("file loaded",doc);window.doc=doc;process_event=function(event){var a,current_event,model,obj;log("PROCESS EVENT");log(event);current_event="NONE";if(event.oldValue!=null){obj=JSON.parse(event.oldValue)}if(event.newValue!=null){obj=JSON.parse(event.newValue)}log("object",obj);window.obj=obj;model=Nimbus.dictModel[obj.type];if(event.oldValue===null){log("add event");model.add_from_cloud(obj.id);current_event="CREATE"}else if(event.newValue===null){log("delete event");window.currently_syncing=true;if(model.exists(obj.id)){a=model.find(obj.id);a.destroy()}window.currently_syncing=false;current_event="DELETE"}else{log("changing the data inside a entry event");model.update_to_local(obj);current_event="UPDATE"}model.process_callback_chain(current_event,obj,event.isLocal);log("EVENT: ",current_event," OBJ: ",obj);if(window.realtime_update_handler!=null){return window.realtime_update_handler(current_event,obj,event.isLocal)}};todo=doc.getModel().getRoot().get("todo");window.todo=todo;if(window.real_time_callback!=null){window.real_time_callback()}return todo.addEventListener(gapi.drive.realtime.EventType.VALUE_CHANGED,process_event)};window.create_share_client=function(){var share_client;share_client=new gapi.drive.share.ShareClient(Nimbus.Auth.app_id);share_client.setItemIds(c_file.id);share_client.showSettingsDialog();return window.share_client=share_client};window.handleErrors=handleErrors=function(e){if(e.type===gapi.drive.realtime.ErrorType.TOKEN_REFRESH_REQUIRED){return gapi.auth.authorize({client_id:Nimbus.Auth.key,scope:Nimbus.Auth.scope,immediate:true,authuser:localStorage.authuser||0},function(data){return console.log("authorize the app after error")})}else if(e.type===gapi.drive.realtime.ErrorType.CLIENT_ERROR){return alert("An Error happened: "+e.message)}else if(e.type===gapi.drive.realtime.ErrorType.NOT_FOUND){return alert("The file was not found. It does not exist or you do not have read access to the file.")}};window.startRealtime=function(callback){var current_user_account;current_user_account=Nimbus.Share.get_user_email();if(!localStorage.current_user_account||localStorage.current_user_account!==current_user_account){delete localStorage.last_opened_workspace}localStorage.current_user_account=current_user_account;if(callback!=null){window.real_time_callback=callback}return gapi.load("auth:client,drive-realtime,drive-share",function(){log("gapi for everything loaded");return Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.drive-sdk."+Nimbus.Auth.app_id+"'",function(data){var c_file,i,index,workspace,x,_ref;console.log("drive apps",data);window.app_files=data.items;i=[];workspace=0;_ref=data.items;for(index in _ref){x=_ref[index];log(x.mimeType);if(x.mimeType.indexOf("application/vnd.google-apps.drive-sdk")>=0){if(localStorage.last_opened_workspace&&x.id===localStorage.last_opened_workspace){workspace=index}i.push(x)}}log("index",i);if(i.length>0){log("file there");c_file=i[workspace];window.c_file=c_file;return gapi.drive.realtime.load(c_file.id,onFileLoaded,initializeModel,handleErrors)}else{log("file not there");Nimbus.Client.GDrive.insertFile("",Nimbus.Auth.app_name,"application/vnd.google-apps.drive-sdk",null,function(data){log("finished insertFile",data);window.c_file=data;window.app_files.push(data);return gapi.drive.realtime.load(data.id,onFileLoaded,initializeModel,handleErrors)});return log("need to create file for app")}})})};window.load_new_file=function(file_id,callback,exception_handle){if(callback!=null){window.real_time_callback=callback}return Nimbus.Share.getFile(file_id,function(data){window.c_file=data;if(!data.id){return}if(exception_handle&&exception_handle instanceof Function){return gapi.drive.realtime.load(file_id,onFileLoaded,initializeModel,exception_handle)}else{return gapi.drive.realtime.load(file_id,onFileLoaded,initializeModel,handleErrors)}})};Nimbus.Client.Dropbox={get_request_token:function(key,secret,callback){var header,xhr;xhr=new XMLHttpRequest;xhr.open("POST","https://api.dropbox.com/1/oauth/request_token",true);header='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+key+'",oauth_signature="'+secret+'&"';log(header);xhr.setRequestHeader("Authorization",header);xhr.onreadystatechange=function(){var data,i,k,pair,pairs,request_token,result,v,_i,_len;if(this.readyState===4){if(this.status===200){data=this.response;log(data);pairs=data.split(/&/);request_token={};for(_i=0,_len=pairs.length;_i<_len;_i++){i=pairs[_i];pair=i.split(RegExp("="),2);request_token[pair[0]]=pair[1]}log("Token result",request_token);for(k in request_token){v=request_token[k];localStorage[k]=v}window.request_token=request_token;if(callback!=null){return callback(request_token)}}else{try{result=JSON.parse(result)}catch(_error){}return error(result,this.status,this)}}};return xhr.send()},authorize_token:function(request_token){var auth_url,ref,return_url;log("authorize url",document.URL);if(document.URL.slice(0,4)==="file"&&typeof cordova!=="undefined"&&cordova!==null){log("Phonegap login");auth_url="https://www.dropbox.com/1/oauth/authorize?oauth_token="+request_token.oauth_token;ref=window.open(auth_url,"_blank","location=yes");window.ref=ref;window.auth_count=0;ref.addEventListener("loadstop",function(event){console.log(event);console.log("event",event.url.indexOf("https://www.dropbox.com/1/oauth/authorize"));if(event.url.indexOf("https://www.dropbox.com/1/oauth/authorize")>=0){window.auth_count=window.auth_count+1;if(window.auth_count===2){Nimbus.Auth.Dropbox_auth.initialize_dropbox();return window.ref.close()}}});return ref.addEventListener("exit",function(event){return Nimbus.Auth.logout_dropbox()})}else if(document.URL.slice(0,4)==="http"){return_url="&oauth_callback="+encodeURIComponent(document.URL);auth_url="https://www.dropbox.com/1/oauth/authorize?oauth_token="+request_token.oauth_token+return_url;return location.replace(auth_url)}else if(document.URL.slice(0,6)==="chrome"){log("chrome app!");auth_url="https://www.dropbox.com/1/oauth/authorize?oauth_token="+request_token.oauth_token;return chrome.tabs.create({url:auth_url,selected:true},function(tab){return log("tab created",tab.id)})}else{auth_url="https://www.dropbox.com/1/oauth/authorize?oauth_token="+request_token.oauth_token;return location.replace(auth_url)}},get_access_token:function(callback){var auth_string,oauth_token,oauth_token_secret,xhr;oauth_token=localStorage["oauth_token"];oauth_token_secret=localStorage["oauth_token_secret"];auth_string='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+oauth_token+'",oauth_signature="'+Nimbus.Auth.secret+"&"+oauth_token_secret+'"';log("auth_string:",auth_string);xhr=new XMLHttpRequest;xhr.open("POST","https://api.dropbox.com/1/oauth/access_token",true);xhr.setRequestHeader("Authorization",auth_string);xhr.onreadystatechange=function(){var access_token,data,i,k,pair,pairs,result,v,_i,_len;if(this.readyState===4){if(this.status===200){data=this.response;log(data);pairs=data.split(/&/);access_token={};for(_i=0,_len=pairs.length;_i<_len;_i++){i=pairs[_i];pair=i.split(RegExp("="),2);access_token[pair[0]]=pair[1]}log("Access result",access_token);for(k in access_token){v=access_token[k];localStorage[k]=v}window.access_token=access_token;if(callback!=null){return callback(access_token)}}else{try{result=JSON.parse(result)}catch(_error){}return log(result,this.status,this)}}};return xhr.send()},send_request:function(method,url,body,success,failure){var auth_string,key,oauth_token,oauth_token_secret,pList,xhr;oauth_token=localStorage["oauth_token"];oauth_token_secret=localStorage["oauth_token_secret"];auth_string='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+oauth_token+'",oauth_signature="'+Nimbus.Auth.secret+"&"+oauth_token_secret+'"';log("auth_string:",auth_string);xhr=new XMLHttpRequest;xhr.open(method,url,true);xhr.setRequestHeader("Authorization",auth_string);xhr.onreadystatechange=function(){var result;if(this.readyState===4){if(this.status===200){result=this.response;try{result=JSON.parse(result)}catch(_error){}log("REQUEST RESULT",result);if(success!=null){success(result)}}else{try{result=JSON.parse(result)}catch(_error){}log(result,this.status,this);if(failure!=null){failure(result)}}if(window.current_syncing!=null){return window.current_syncing.ok()}}};if(method==="POST"){xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(body){pList=[];for(key in body){pList.push(encodeURIComponent(key)+"="+encodeURIComponent(body[key]))}body=pList.length>0?pList.join("&").replace(/%20/g,"+"):null}log(body)}log("send request params",method,url,body,success,failure);if(window.current_syncing!=null){window.current_syncing.wait()}xhr.send(body);return window.xhr=xhr},send_request_without_delay:function(method,url,body,success,failure){var auth_string,key,oauth_token,oauth_token_secret,pList,xhr;oauth_token=localStorage["oauth_token"];oauth_token_secret=localStorage["oauth_token_secret"];auth_string='OAuth oauth_version="1.0",oauth_signature_method="PLAINTEXT",oauth_consumer_key="'+Nimbus.Auth.key+'",oauth_token="'+oauth_token+'",oauth_signature="'+Nimbus.Auth.secret+"&"+oauth_token_secret+'"';log("auth_string:",auth_string);xhr=new XMLHttpRequest;xhr.open(method,url,true);xhr.setRequestHeader("Authorization",auth_string);xhr.onreadystatechange=function(){var result;if(this.readyState===4){if(this.status===200){result=this.response;try{result=JSON.parse(result)}catch(_error){}log("REQUEST RESULT",result);if(success!=null){return success(result)}}else{try{result=JSON.parse(result)}catch(_error){}log(result,this.status,this);if(failure!=null){return failure(result)}}}};if(method==="POST"){xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(body){pList=[];for(key in body){pList.push(encodeURIComponent(key)+"="+encodeURIComponent(body[key]))}body=pList.length>0?pList.join("&").replace(/%20/g,"+"):null}log(body)}log("send request params",method,url,body,success,failure);return xhr.send(body)},putFileContents:function(path,content,success,error){log("putFileContents");return Nimbus.Client.Dropbox.send_request("PUT","https://api-content.dropbox.com/1/files_put/sandbox"+path,content,success,error)},createFolder:function(path,success,error){log("createFolder");return Nimbus.Client.Dropbox.send_request("POST","https://api.dropbox.com/1/fileops/create_folder",{root:"sandbox",path:path},success,error)},deletePath:function(path,success,error){log("deletePath");return Nimbus.Client.Dropbox.send_request("POST","https://api.dropbox.com/1/fileops/delete",{root:"sandbox",path:path},success,error)},getFileContents:function(path,success,error){log("getFileContents");return Nimbus.Client.Dropbox.send_request("GET","https://api-content.dropbox.com/1/files/sandbox"+path,"",success,error)},getMetadataList:function(path,success,error){log("getMetadataList");return Nimbus.Client.Dropbox.send_request("GET","https://api.dropbox.com/1/metadata/sandbox"+path,"",success,error)},getAccountInfo:function(success,error){log("getAccountInfo");return Nimbus.Client.Dropbox.send_request_without_delay("GET","https://api.dropbox.com/1/account/info","",success,error)}};window.client=null;Nimbus.Client.Dropbox.Binary={binary_setup:function(){return window.binary=Nimbus.Model.setup("binary",["name","path","copied","directlink","sharelink","expiration"])},initialize_client:function(){log("initializing second client");if(Nimbus.Auth.key!=null){if(window.client==null){window.client=new Dropbox.Client({key:Nimbus.Auth.key,secret:Nimbus.Auth.secret,sandbox:true});return window.client.oauth.setToken(localStorage["oauth_token"],localStorage["oauth_token_secret"])}else{}}else{return log("can't upload file with no dropbox credentials")}},upload_blob:function(blob,name,callback){var come_back,new_file;log("upload new blob");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){new_file=binary.create({name:name,copied:false});come_back=function(error,stat){console.log("wrote file to cloud");console.log(error,stat);new_file.copied=true;new_file.path=stat.path;new_file.save();if(callback!=null){return callback(new_file)}};log("file name",name);return window.client.writeFile(name,blob,come_back)}else{return log("client won't initialize")}},upload_file:function(file,callback){var come_back,new_file;log("upload new file");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){new_file=binary.create({name:file.name,copied:false});come_back=function(error,stat){console.log("wrote file to cloud");console.log(error,stat);new_file.copied=true;new_file.path=stat.path;new_file.save();if(callback!=null){return callback(new_file)}};log("file name",file.name);return window.client.writeFile(file.name,file,come_back)}else{return log("client won't initialize")}},read_file:function(binary,callback){var come_back;log("read a binary file from the server");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){come_back=function(error,data,stat){console.log(error,data,stat);return callback(data)};return window.client.readFile(binary.path,{blob:true},come_back)}else{return log("client won't initialize")}},share_link:function(binary,callback){var come_back;log("get the share link");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){come_back=function(error,data){console.log(error,data);binary.sharelink=data.url;binary.save();return callback(data)};console.log(binary.path);return window.client.makeUrl(binary.path,{},come_back)}},direct_link:function(binary,callback){var come_back;
log("get the share link");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){if(binary.directlink!=null&&new Date(binary.expiration)>new Date){return callback({url:binary.directlink,expiresAt:binary.expiration})}else{come_back=function(error,url){console.log(error,url);binary.directlink=url.url;binary.expiration=url.expiresAt.toString();binary.save();return callback(url)};return window.client.makeUrl(binary.path,{download:true,downloadHack:true},come_back)}}},delete_file:function(binary){var come_back;log("delete file");Nimbus.Client.Dropbox.Binary.initialize_client();if(window.client!=null){come_back=function(error,stat){return binary.destroy()};return window.client.remove(binary.path,come_back)}else{return log("client won't initialize")}}};Nimbus.Client.GDrive={check_auth:function(){var token;log("checking if this is authenticated");if(location.protocol==="chrome-extension:"){if(typeof gapi!=="undefined"&&gapi!==null&&gapi.auth!=null&&gapi.auth.getToken()===null&&window.todo!=null){token=Nimbus.Auth.GDrive.getLocalOauth2Token();if(token==null||Nimbus.Auth.GDrive.isTokenExpires(token)){return false}else{gapi.auth.setToken(token);return true}}}return typeof gapi!=="undefined"&&gapi!==null&&gapi.auth!=null&&gapi.auth.getToken()!==null&&Object.keys(gapi.auth.getToken()).length!==0&&window.todo!=null},authorize:function(client_id,scopes,callback){log("authorized called");return gapi.auth.authorize({client_id:client_id,scope:scopes,immediate:false,authuser:localStorage.authuser||0,prompt:"select_account"},callback)},insertFile:function(content,title,contentType,parent,callback,properties){var base64Data,boundary,close_delim,delimiter,metadata,multipartRequestBody,params;log("putFileContents");boundary="-------314159265358979323846";delimiter="\r\n--"+boundary+"\r\n";close_delim="\r\n--"+boundary+"--";base64Data=btoa(content);metadata={title:title,mimeType:contentType};if(parent!=null){metadata["parents"]=[{kind:"drive#fileLink",id:parent}]}if(properties){metadata.properties=properties}multipartRequestBody=delimiter+"Content-Type: application/json\r\n\r\n"+JSON.stringify(metadata)+delimiter+"Content-Type: "+contentType+"\r\n"+"Content-Transfer-Encoding: base64\r\n"+"\r\n"+base64Data+close_delim;log("MULTI: ",multipartRequestBody);if(!callback){callback=function(file){return log("Update Complete ",file)}}params={path:"/upload/drive/v2/files",method:"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+boundary+'"'},body:multipartRequestBody};return this.make_request(params,callback)},deleteFile:function(file_id,callback){var params;log("deletePath");if(!callback){callback=function(_this){return function(resp){var params;params={path:"/drive/v2/files/"+file_id,method:"DELETE"};_this.make_request(params,function(data){return log("delete complete",data)});return log("Delete Complete ",resp)}}(this)}params={path:"/drive/v2/files/"+file_id+"/trash",method:"POST"};return this.make_request(params,callback)},getFile:function(file_id,callback){var params;log("getFileContents");if(!callback){callback=function(resp){return log("Read Complete ",resp)}}params={path:"/drive/v2/files/"+file_id,method:"GET"};return this.make_request(params,callback)},readFile:function(url,callback){var accessToken,xhr;if(!callback){callback=function(resp){return log("Read Complete ",resp)}}accessToken=gapi.auth.getToken().access_token;xhr=new XMLHttpRequest;xhr.open("GET",url);xhr.setRequestHeader("Authorization","Bearer "+accessToken);xhr.onload=function(){callback(xhr.responseText);if(window.current_syncing!=null){return window.current_syncing.ok()}};xhr.onerror=function(){return callback(null)};if(window.current_syncing!=null){window.current_syncing.wait()}return xhr.send()},updateFile:function(content,title,contentType,file_id,folder_id,callback){var base64Data,boundary,close_delim,delimiter,metadata,multipartRequestBody,params;log("updateFileContents");boundary="-------314159265358979323846";delimiter="\r\n--"+boundary+"\r\n";close_delim="\r\n--"+boundary+"--";contentType="text/html";metadata={mimeType:contentType};base64Data=btoa(content);metadata={title:title,mimeType:contentType};multipartRequestBody=delimiter+"Content-Type: application/json\r\n\r\n"+JSON.stringify(metadata)+delimiter+"Content-Type: "+contentType+"\r\n"+"Content-Transfer-Encoding: base64\r\n"+"\r\n"+base64Data+close_delim;if(!callback){callback=function(file){return log("Update Complete ",file)}}params={path:"/upload/drive/v2/files/"+file_id,method:"PUT",params:{fileId:file_id,uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+boundary+'"'},body:multipartRequestBody};return this.make_request(params,callback)},getMetadataList:function(query,callback){var params;log("getMetadataList");if(!callback){callback=function(file){return log("List of files",file)}}params={path:"/drive/v2/files",method:"GET",params:{q:query}};return this.make_request(params,callback)},make_request:function(params,callback){params["callback"]=function(data){if(callback!=null){callback(data)}if(window.current_syncing!=null){return window.current_syncing.ok()}};if(window.current_syncing!=null){window.current_syncing.wait()}return gapi.client.request(params)},get_current_user:function(callback){var params,process;log("get current user");process=function(_this){return function(file){var user;log("About called ",file);user={};user.name=file["user"].displayName;user.id=file["user"].permissionId;if(file["user"].picture!=null){user.pic=file["user"].picture.url}if(callback!=null){return callback(user)}}}(this);params={path:"/drive/v2/about",method:"GET"};return this.make_request(params,process)},get_current_user_info:function(callback){var params,process;log("get current user");process=function(_this){return function(user){if(callback!=null){return callback(user)}}}(this);params={path:"/plus/v1/people/me",method:"GET"};return this.make_request(params,process)},add_share_user:function(email,callback){var app_folder_id,params,process;log("&&& add share user");process=function(_this){return function(person){var p;log("Add Share user Complete ",person);p={id:person.id,name:person.name,role:person.role};if(person.photoLink!=null){p["pic"]=person.photoLink}if(callback!=null){return callback(p)}}}(this);app_folder_id=window.folder["binary_files"].id;params={path:"/drive/v2/files/"+app_folder_id+"/permissions",method:"POST",params:{fileId:app_folder_id},body:{role:"writer",type:"user",value:email}};return this.make_request(params,process)},add_share_user_real:function(email,callback,file_id){var fid,params,process;log("&&& add share user");fid=file_id?file_id:window.c_file.id;process=function(_this){return function(person){var p;log("Add Share user Complete ",person);p={id:person.id,name:person.name,role:person.role};if(person.photoLink!=null){p["pic"]=person.photoLink}if(callback!=null){return callback(p)}}}(this);params={path:"/drive/v2/files/"+fid+"/permissions",method:"POST",params:{fileId:fid},body:{role:"writer",type:"user",value:email}};return this.make_request(params,process)},remove_share_user:function(id,callback){var app_folder_id,params;log("&&& remove a user from sharing this app");app_folder_id=window.folder["binary_files"].id;if(!callback){callback=function(file){return log("Permission Removal Complete ",file)}}params={path:"/drive/v2/files/"+app_folder_id+"/permissions/"+id,method:"DELETE"};return this.make_request(params,callback)},remove_share_user_real:function(id,callback,file_id){var params;log("&&& remove a user from sharing this app");if(!callback){callback=function(file){return log("Permission Removal Complete ",file)}}file_id=file_id?file_id:window.c_file.id;params={path:"/drive/v2/files/"+file_id+"/permissions/"+id,method:"DELETE"};return this.make_request(params,callback)},get_user_email:function(){var access_token,data,xhr;if(window.user_email!=null){return window.user_email}access_token=gapi.auth.getToken().access_token;data=null;xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(xhr.readyState===4){if(xhr.status===200){return data=JSON.parse(xhr.responseText)}else{return log("get user email failed with status "+xhr.status)}}};xhr.open("GET","https://www.googleapis.com/oauth2/v1/tokeninfo?access_token="+access_token,false);xhr.send(null);if((data!=null?data.email:void 0)!=null){window.user_email=data.email;return data.email}return null},get_shared_users_real:function(callback){var params,process;log("&&& get shared users");process=function(_this){return function(file){var p,perm,permissions,_i,_len,_ref;log("Update Complete ",file);permissions=[];_ref=file.items;for(_i=0,_len=_ref.length;_i<_len;_i++){p=_ref[_i];perm={id:p.id,name:p.name,role:p.role};if(p.photoLink!=null){perm["pic"]=p.photoLink}permissions.push(perm)}log("permissions",permissions);if(callback!=null){return callback(permissions)}}}(this);params={path:"/drive/v2/files/"+window.c_file.id+"/permissions",method:"GET"};return this.make_request(params,process)},get_shared_users:function(callback){var app_folder_id,params,process;log("&&& get shared users");app_folder_id=window.folder["binary_files"].id;process=function(_this){return function(file){var p,perm,permissions,_i,_len,_ref;log("Update Complete ",file);permissions=[];_ref=file.items;for(_i=0,_len=_ref.length;_i<_len;_i++){p=_ref[_i];perm={id:p.id,name:p.name,role:p.role};if(p.photoLink!=null){perm["pic"]=p.photoLink}permissions.push(perm)}log("permissions",permissions);if(callback!=null){return callback(permissions)}}}(this);params={path:"/drive/v2/files/"+app_folder_id+"/permissions",method:"GET"};return this.make_request(params,process)},get_app_folders:function(callback){log("&&& get app folders");return Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.folder' and title = '"+Nimbus.Auth.app_name+"'",function(data){var f,folders,s,spaces,_i,_len;log(data);folders=data.items;spaces=[];if(data.items!=null){for(_i=0,_len=folders.length;_i<_len;_i++){f=folders[_i];s={};s.id=f.id;s.owner=f.ownerNames[0];spaces.push(s)}}log(spaces);if(callback!=null){return callback(spaces)}})},switch_to_app_folder:function(id,callback){log("###switch to app folder");window.folder={};window.folder[Nimbus.Auth.app_name]={title:Nimbus.Auth.app_name,id:id};window.current_syncing=new DelayedOp(function(_this){return function(){if(callback!=null){return callback()}}}(this));localStorage["main_folder_id"]=id;Nimbus.Client.GDrive.getMetadataList("mimeType = 'application/vnd.google-apps.folder'",function(data){var a,k,v,x,_i,_len,_ref,_results;a=data.items;log("###rewriting folders",a);for(_i=0,_len=a.length;_i<_len;_i++){x=a[_i];log(x);if(x.parents.length>0&&x.parents[0].id===id){window.folder[x.title]=x}}if(Nimbus.dictModel!=null){_ref=Nimbus.dictModel;_results=[];for(k in _ref){v=_ref[k];_results.push(v.records={})}return _results}});return window.current_syncing.ready()},switch_to_app_file_real:function(id,callback){localStorage.last_opened_workspace=id;window.current_syncing=new DelayedOp(function(_this){return function(){if(callback!=null){return callback()}}}(this));if(window._indexdb){_indexdb.allDocs({include_docs:true},function(err,res){var row,_i,_len,_ref,_results;if(!err){_ref=res.rows;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){row=_ref[_i];_results.push(_indexdb.remove(row.doc,function(e,r){return log("ok",e,r)}))}return _results}})}Nimbus.Share.getFile(id,function(data){var k,v,_ref;if(!data.id){return}window.c_file=data;if(Nimbus.dictModel!=null){_ref=Nimbus.dictModel;for(k in _ref){v=_ref[k];v.records={};if(Nimbus.Storage){Nimbus.Storage[v.name]=[]}}}return gapi.drive.realtime.load(id,onFileLoaded,initializeModel,handleErrors)});return window.current_syncing.ready()},build_params:function(obj){var k,params_arr,v;params_arr=function(){var _results;_results=[];for(k in obj){v=obj[k];_results.push(""+encodeURIComponent(k)+"="+encodeURIComponent(v))}return _results}();return params_arr.join("&")},extract_params_from_url:function(){var m,params,queryString,regex;params={};queryString=location.hash.substring(1);regex=/([^&=]+)=([^&]*)/g;while(m=regex.exec(queryString)){params[decodeURIComponent(m[1])]=decodeURIComponent(m[2])}return params},request_access_token:function(){var params,params_str,redirect_uri,url;redirect_uri=Nimbus.Auth.redirect_uri||window.location.protocol+"//"+window.location.host+window.location.pathname;params={response_type:"token",client_id:Nimbus.Auth.key,redirect_uri:redirect_uri,scope:Nimbus.Auth.scope,state:"gdrive_get_access_token",prompt:"select_account"};params_str=Nimbus.Client.GDrive.build_params(params);url="https://accounts.google.com/o/oauth2/auth?"+params_str;return window.open(url,"_self")},request_validate_token:function(token){var data,xhr;xhr=new XMLHttpRequest;data=null;xhr.onreadystatechange=function(){var _ref;if(xhr.readyState===4){if((_ref=xhr.status)===200||_ref===400){return data=JSON.parse(xhr.responseText)}else{return log("validate access token failed with status "+xhr.status)}}};xhr.open("GET","https://www.googleapis.com/oauth2/v1/tokeninfo?access_token="+token,false);xhr.send(null);return data},is_token_validate:function(token){var data,result;result=false;data=this.request_validate_token(token);if(data==null){return false}if(!("error"in data)&&(data!=null?data.audience:void 0)===Nimbus.Auth.key){result=true}return result},handle_auth_redirected:function(){return typeof history.replaceState==="function"?history.replaceState("",document.title,window.location.pathname):void 0},is_auth_redirected:function(){var params;params=this.extract_params_from_url();if(params.state==="gdrive_get_access_token"&&"token_type"in params&&params.token_type==="Bearer"){if(params.authuser){localStorage.authuser=params.authuser}return true}return false}};Nimbus.Client.GDrive.Binary={binary_setup:function(){return window.binary=Nimbus.Model.setup("binary",["name","path","copied","directlink","sharelink","expiration","file_id"])},initialize_client:function(run){log("initializing client");if(Nimbus.Auth.key!=null&&Nimbus.Auth.scope!=null){if(!Nimbus.Client.GDrive.check_auth()){return Nimbus.Client.GDrive.authorize(Nimbus.Auth.key,Nimbus.Auth.scope,function(){log("GDrive authorized");if(run){return run()}})}else{if(run){return run()}}}else{return log("can't upload file with no GDrive credentials")}},upload_blob:function(blob,name,callback){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var reader;log("upload new blob");reader=new FileReader;reader.readAsBinaryString(blob);return reader.onload=function(){var come_back,content,contentType,new_file,parent;content=reader.result;contentType=blob.type||"application/octet-stream";parent=window.folder["binary_files"].id;new_file=binary.create({name:name});come_back=function(file){console.log("upload file to cloud");console.log(file);new_file.copied=true;new_file.file_id=file.id;new_file.directlink=file.webContentLink;new_file.save();if(callback!=null){return callback(new_file)}};return Nimbus.Client.GDrive.insertFile(content,name,contentType,parent,come_back)}})},upload_file:function(file,callback){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var reader;log("upload new file");reader=new FileReader;reader.readAsBinaryString(file);return reader.onload=function(){var come_back,content,contentType,name,new_file,parent;name=file.name;content=reader.result;contentType=file.type||"application/octet-stream";parent=window.folder["binary_files"].id;new_file=binary.create({name:name});come_back=function(file){console.log("upload file to cloud");console.log(file);new_file.copied=true;new_file.file_id=file.id;new_file.directlink=file.webContentLink;new_file.save();new_file._file=file;if(callback!=null){return callback(new_file)}};return Nimbus.Client.GDrive.insertFile(content,name,contentType,parent,come_back)}})},read_file:function(binary,callback){return Nimbus.Client.GDrive.Binary.initialize_client(function(){var param;log("read metadata of a file from the server");param={path:"/drive/v2/files/"+binary.file_id};return Nimbus.Client.GDrive.make_request(param,function(data){console.log(data);if(callback){return callback(data)}})})},share_link:function(binary,callback){return Nimbus.Client.GDrive.Binary.initialize_client(function(){log("get the share link");if(callback){return callback("")}})},direct_link:function(binary,callback){return Nimbus.Client.GDrive.Binary.initialize_client(function(){log("get the direct link");if(callback){return callback(binary.directlink)}})},delete_file:function(binary){return Nimbus.Client.GDrive.Binary.initialize_client(function(){log("delete file",binary);return Nimbus.Client.GDrive.deleteFile(binary.file_id,function(){return binary.destroy()})})}};window.nimbus_error=[];Nimbus.Model.GDrive={cloudcache:{},last_hash:"",hash:"",toCloudStructure:function(object){log("local to cloud structure");return JSON.stringify(object)},fromCloudStructure:function(value){log("changes cloud to local data in the form a dictionary");return JSON.parse(value)},diff_objects:function(previous,current){var diff,f,v;diff={};for(f in previous){v=previous[f];if(current[f]!==previous[f]){diff[f]=[current[f],previous[f]]}}if(previous["parent_id"]!=null!==(current["parent_id"]!=null)){diff["parent_id"]=["one of them is null"]}return diff},add_to_cloud:function(object,callback){var parent,parent_name;log("add to cloud",object);parent_name=object.parent.name;parent=window.folder[parent_name].id;return Nimbus.Client.GDrive.insertFile(this.toCloudStructure(object),object.id,"text/plain",parent,function(data){log("logging data inserted",data);window.currently_syncing=true;object.gid=data.id;object.time=data.modifiedDate;object.synced=true;object.save();return window.currently_syncing=false})},delete_from_cloud:function(object_id,callback){log("delete from cloud",object_id);return Nimbus.Client.GDrive.getMetadataList("title = '"+object_id+"'",function(data){var id;log("data",data);if(data.items.length>0){id=data.items[0].id;Nimbus.Client.GDrive.deleteFile(id);if(callback!=null){return callback()}}else{return log("file to be deleted not there")}})},update_to_cloud:function(object,callback){var comeback,parent,parent_name,update_comback;log("updated to cloud",object.name);parent_name=object.parent.name;parent=window.folder[parent_name].id;update_comback=function(_this){return function(data){log("logging data inserted",data);window.currently_syncing=true;object.time=data.modifiedDate;object.save();object.synced=true;return window.currently_syncing=false}}(this);comeback=function(_this){return function(data){var id;id=data.items[0].id;return Nimbus.Client.GDrive.updateFile(_this.toCloudStructure(object),object.id,"text/plain",id,parent,function(data){log("logging data inserted",data);window.currently_syncing=true;object.time=data.modifiedDate;object.save();return window.currently_syncing=false})}}(this);if(object.gid!=null){return Nimbus.Client.GDrive.updateFile(this.toCloudStructure(object),object.id,"text/plain",object.gid,parent,function(data){log("logging data updated",data);window.currently_syncing=true;object.time=data.modifiedDate;object.save();return window.currently_syncing=false})}else{return Nimbus.Client.GDrive.getMetadataList("title = '"+object.id+"'",comeback)}},add_from_cloud:function(object_id,callback){var process_data;log("add from cloud GDrive",object_id);process_data=function(_this){return function(data){var converted,x;log("cloud url data",JSON.parse(data));window.currently_syncing=true;converted=_this.fromCloudStructure(data);x=_this.init(converted);x.synced=true;x.time=_this.cloudcache[object_id].time;x.save();return window.currently_syncing=false}}(this);return Nimbus.Client.GDrive.getMetadataList("title = '"+object_id+"'",function(data){var url;log("cloud read data",data);window.data=data;if(data.items!=null&&data.items.length>=1){url=window.data.items[0].downloadUrl;return Nimbus.Client.GDrive.readFile(url,process_data)}else{return log("This data is not there")}})},update_to_local:function(object,callback){var process_data;log("update to local",object);process_data=function(_this){return function(data){var converted,x;log("cloud url data",JSON.parse(data));window.currently_syncing=true;converted=_this.fromCloudStructure(data);x=_this.find(object.id);converted.time=_this.cloudcache[object.id].time;x.updateAttributes(converted);return window.currently_syncing=false}}(this);return Nimbus.Client.GDrive.getMetadataList("title = '"+object.id+"'",function(data){var url;log("cloud read data",data);window.data=data;if(data.error!=null){window.nimbus_error.push({error:data.error,object:object});return console.log("##ERROR writing back to local",data.error,"object: ",object)}else{if(data.items.length>=1){url=window.data.items[0].downloadUrl;return Nimbus.Client.GDrive.readFile(url,process_data)}else{return log("This data is not there")}}})},sync_all:function(cb){log("syncs all the data, normally happens at the start of a program or coming back from offline");window.current_syncing=new DelayedOp(function(_this){return function(){log("call back sync called");window.current_syncing=new DelayedOp(function(){window.current_syncing=null;if(cb!=null){return cb()}});_this.sync_model_base_algo();return window.current_syncing.ready()}}(this));this.load_all_from_cloud();return window.current_syncing.ready()},load_all_from_cloud:function(){var fill_cache,folder_id,object_name;log("loads all the data from the cloud locally");this.cloudcache={};object_name=this.name;log("object name",object_name);if(window.folder!=null&&window.folder[object_name]!=null){folder_id=window.folder[object_name].id;fill_cache=function(_this){return function(data){var x,_i,_len,_ref,_results;log("cloud read data",object_name,data);window.data=data;if(data.items!=null){_ref=data.items;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){x=_ref[_i];_this.cloudcache[x.title]={id:x.title,time:x.modifiedDate};if(x.labels.trashed){_results.push(console.log("##### this is trashed #####",x))}else{_results.push(void 0)}}return _results}else{return log("###ERROR, no return data")}}}(this);Nimbus.Client.GDrive.getMetadataList("'"+folder_id+"' in parents",fill_cache);return _this.is_cloud_available=true}else{log("############################BIG ERROR no folder there for load from cloud");return _this.is_cloud_available=false}},get_delta:function(){return log("get the delta for ",this.name," since last synced")},extended:function(){this.sync(this.proxy(this.real_time_sync));return this.fetch(this.proxy(this.loadLocal))}};window.folder=null;window.folder_creation=new OneOp;window.creating={};window.handle_initialization=new OneOp;window.gdrive_initialized=false;window.folder_initialize=function(callback){var get_app_folder,properties,query,space_folder_name;space_folder_name=c_file.title+" files";query="mimeType = 'application/vnd.google-apps.folder' and title = '"+space_folder_name+"' and properties has { key='space' and value='"+c_file.id+"' and visibility='PRIVATE' }";properties=[{key:"space",value:c_file.id,visibility:"PRIVATE"}];get_app_folder=function(handle){return Nimbus.Client.GDrive.getMetadataList(query,function(data){if(handle){return handle(data)}})};log("&&& folder initialize");log("Nimbus.Client.GDrive.check_auth()",Nimbus.Client.GDrive.check_auth(),"Nimbus.Auth.service",Nimbus.Auth.service);if(Nimbus.Client.GDrive.check_auth()&&Nimbus.Auth.service==="GDrive"){log("this is authenticated and a GDrive app");return Nimbus.Client.GDrive.getMetadataList(query,function(data){var a,x,_i,_len;log("#data: ",data);window.folder={};a=data.items;if(localStorage["main_folder_id"]!=null){return window.folder[Nimbus.Auth.app_name]={title:Nimbus.Auth.app_name,id:localStorage["main_folder_id"]}}else if(!a.error){for(_i=0,_len=a.length;_i<_len;_i++){x=a[_i];if(x.owners[0].permissionId===c_file.owners[0].permissionId){window.folder.binary_files=x;break}}if(window.folder["binary_files"]==null){return Nimbus.Client.GDrive.insertFile("",c_file.title+" files","application/vnd.google-apps.folder",null,function(data){log("binary_files folder data",data);log("binary ready callback",binary_ready_callback);window.folder["binary_files"]=data;if(window.binary_ready_callback){window.binary_ready_callback()}if(callback!=null){return callback()}},properties)}else{log("binary ready callback",binary_ready_callback);if(window.binary_ready_callback){window.binary_ready_callback()}if(callback!=null){return callback()}}}else{return console.log("error")}})}};Nimbus.Auth.GDrive={init_scope:function(){var isArray,user_email_scope,x;x=this.scope;isArray=Array.isArray||function(value){return{}.toString.call(value)==="[object Array]"};user_email_scope="https://www.googleapis.com/auth/userinfo.email";if(isArray(x)){if(__indexOf.call(x,user_email_scope)<0){x.push(user_email_scope)}}else{x=[x,user_email_scope]}if(x.indexOf("openid")===-1){x.push("openid")}return this.scope=x.join(" ")},get_token_from_code:function(code){var data,xhr;xhr=new XMLHttpRequest;data="code="+code+"&client_id="+this.key+"&client_secret="+this.client_secret+"&grant_type=authorization_code&redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob";window.data=data;xhr.open("POST","https://accounts.google.com/o/oauth2/token");xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhr.onreadystatechange=function(_this){return function(status,response){var e,result;if(xhr.readyState===4){try{result=JSON.parse(xhr.response);if(result["error"]){return console.log("error")}else{window.plugins.childBrowser.close();localStorage["phonegap_token"]=JSON.stringify(result);localStorage["state"]="Working";gapi.auth.setToken(result);_this.prepare_gdrive();return Nimbus.track.google.registered_user()}}catch(_error){e=_error;return console.log(e)}}}}(this);xhr.send(data);return window.xhr=xhr},authenticate_gdrive:function(){var auth_url,cb,url;log("this should bring up a prompt to initialize into GDrive");localStorage["d_key"]=this.key;localStorage["secret"]=this.scope;localStorage["state"]="Auth";if(document.URL.slice(0,4)==="file"&&typeof cordova!=="undefined"&&cordova!==null){log("Phonegap google login");auth_url="https://accounts.google.com/o/oauth2/auth?response_type=code&client_id="+this.key+"&scope="+encodeURIComponent(this.scope)+"&approval_prompt=auto&redirect_uri=urn:ietf:wg:oauth:2.0:oob";window.auth_url=auth_url;cb=window.plugins.childBrowser;if(cb!==null){cb.onLocationChange=function(loc){return locChanged(loc)};cb.onClose=function(){return onCloseBrowser()};cb.onOpenExternal=function(){return onOpenExternal()};url=auth_url+"###var sendToApp = function(_key, _val) {var iframe = document.createElement('IFRAME');iframe.setAttribute('src', _key + ':##sendToApp##' + _val);document.documentElement.appendChild(iframe);iframe.parentNode.removeChi(iframe);iframe = null;};var log=function(_mssg){sendToApp('ios-log',_mssg);}; var html = document.getElementById('code').value; log(html);";cb.onJSCallback=function(backStr){cb.code=backStr;if(backStr&&backStr!=null&&backStr!=="(null)"){cb.close();console.log("will get some toaken");return Nimbus.Auth.get_token_from_code(backStr)}};return cb.showWebPage(url)}}else if(location.protocol==="chrome-extension:"){log("chrome extension authorize");return this.oauth2_authorize()}else{return Nimbus.Client.GDrive.request_access_token()}},initialize_gdrive:function(){log("This part should reflect what initialization needs to be done for GDrive auth");Nimbus.gdrive_initialized=true;if(Nimbus.loaded){if(location.protocol==="chrome-extension:"){return this.oauth2_authorize_second_half()}else{if(Nimbus.Client.GDrive.is_auth_redirected()){Nimbus.Client.GDrive.handle_auth_redirected()}console.log("GDrive loaded");if(localStorage["phonegap_token"]){gapi.auth.setToken(JSON.parse(localStorage["phonegap_token"]));return _this.prepare_gdrive()}return gapi.auth.authorize({client_id:this.key,scope:this.scope,immediate:true,authuser:localStorage.authuser||0},function(_this){return function(data){log("client load handled GDrive");log(data);if(data!==null){return _this.prepare_gdrive()}}}(this))}}},gdrive_authorized:function(){return Nimbus.Client.GDrive.check_auth()},logout_gdrive:function(callback){var k,v,_ref;localStorage.clear();gapi.auth.setToken(null);if(Nimbus.dictModel!=null){_ref=Nimbus.dictModel;for(k in _ref){v=_ref[k];v.records={}}}if(this.sync_services!=null){Nimbus.Auth.setup(this.sync_services)}if(callback!=null){return callback()}},prepare_gdrive:function(){window.binary_ready_callback=function(){if(Nimbus.Auth.authorized_callback!=null){return Nimbus.Auth.authorized_callback()}};return window.startRealtime(function(){log("CURRENT SYNCING CALLBACK");Nimbus.Auth.app_ready_func();Nimbus.track.google.registered_user();return setInterval(function(){var is_token_expired,is_token_there;is_token_there=gapi.auth.getToken()!=null&&gapi.auth.getToken().access_token==null;if(gapi.auth.getToken()){is_token_expired=gapi.auth.getToken().expires_at-(new Date).getTime()/1e3<60*10}else{is_token_expired=true}if(is_token_there||is_token_expired){return gapi.auth.authorize({client_id:Nimbus.Auth.key,scope:Nimbus.Auth.scope,immediate:true,authuser:localStorage.authuser||0},function(data){return console.log("token refreshed")})}return null},6e4)})},oauth2_authorize:function(){var background,params,url;background=chrome.extension.getBackgroundPage();background.NimbusAuth2=function(background_window){var NimbusAuth2;NimbusAuth2={OAUTH2_REDIRECT_URI:"http://www.google.com/robots.txt",getExtensionId:function(){return background_window.chrome.i18n.getMessage("@@extension_id")},isOauth2AuthorizeRedirected:function(base,state){if(base===this.OAUTH2_REDIRECT_URI&&state===this.getExtensionId()){return true}return false},parseParamsString:function(queryString){var m,params,regex;params={};regex=/([^&=]+)=([^&]*)/g;while(m=regex.exec(queryString)){params[background_window.decodeURIComponent(m[1])]=background_window.decodeURIComponent(m[2])}return params},parseRedirectedURL:function(url){var base_url,hash,params,_ref;_ref=url.split("#"),base_url=_ref[0],hash=_ref[1];params=this.parseParamsString(hash);return{base_url:base_url,params:params}},generateRedirectListener:function(){var listener;listener=function(_this){return function(tab_id,change_info,tab){var entension_windows,url_obj,w,_i,_len;if(change_info.status!=="loading"){return}url_obj=_this.parseRedirectedURL(tab.url);if(_this.isOauth2AuthorizeRedirected(url_obj.base_url,url_obj.params.state)){background_window.chrome.tabs.onUpdated.removeListener(listener);background_window.chrome.tabs.remove(tab_id);url_obj["saved_time"]=(new background_window.Date).getTime();background_window.localStorage["_nimbusGDriveAuthObj"]=background_window.JSON.stringify(url_obj);if(_this.isPackagedApp()){background_window.console.log("in packaged app");entension_windows=background_window.chrome.extension.getViews({type:"tab"});for(_i=0,_len=entension_windows.length;_i<_len;_i++){w=entension_windows[_i];if(w.Nimbus.Auth.GDrive.oauth_status_flag==="ongoing"){w.Nimbus.Auth.GDrive.oauth2_authorize_second_half()}}}else if(_this.isBrowserAction()){background_window.console.log("in browser action")}return null}}}(this);return listener},installRedirectedListener:function(){return background_window.chrome.tabs.onUpdated.addListener(this.generateRedirectListener())},isBrowserAction:function(){return"browser_action"in background_window.chrome.runtime.getManifest()},isPackagedApp:function(){return"app"in background_window.chrome.runtime.getManifest()}};return NimbusAuth2}(background);Nimbus.Auth.GDrive.oauth_status_flag="ongoing";background.NimbusAuth2.installRedirectedListener();url="https://accounts.google.com/o/oauth2/auth?";params={client_id:this.key,scope:this.scope,redirect_uri:this.OAUTH2_REDIRECT_URI,state:this.getExtensionId(),response_type:"token",approval_prompt:"auto"};url+=this.buildParamsString(params);return chrome.tabs.create({url:url})},oauth2_authorize_second_half:function(){var issued_at,save_token,token,url_obj;
if(localStorage._nimbusGDriveAuthObj!=null){url_obj=JSON.parse(localStorage["_nimbusGDriveAuthObj"]);if("error"in url_obj){throw new Error("authorization failed with error: "+url_obj.error)}save_token=url_obj.params;issued_at=Math.round(url_obj.saved_time/1e3);save_token.client_id=this.key;save_token.scope=this.scope;save_token.response_type="token";save_token.issued_at=issued_at.toString();save_token.expires_at=(issued_at+parseInt(save_token.expires_in)).toString();save_token.state="";delete localStorage["_nimbusGDriveAuthObj"];localStorage["_chromeExtensionAuth2Token"]=JSON.stringify(save_token)}if(localStorage["_chromeExtensionAuth2Token"]){token=JSON.parse(localStorage["_chromeExtensionAuth2Token"]);gapi.auth.setToken(token);Nimbus.Auth.GDrive.oauth_status_flag="finish";return this.prepare_gdrive()}},OAUTH2_REDIRECT_URI:"http://www.google.com/robots.txt",getExtensionId:function(){return chrome.i18n.getMessage("@@extension_id")},buildParamsString:function(obj){var k,params_arr,v;params_arr=function(){var _results;_results=[];for(k in obj){v=obj[k];_results.push(""+encodeURIComponent(k)+"="+encodeURIComponent(v))}return _results}();return params_arr.join("&")},getLocalOauth2Token:function(token){if(Nimbus.Auth.GDrive._cacheToken!=null){return Nimbus.Auth.GDrive._cacheToken}if(localStorage._chromeExtensionAuth2Token!=null){token=JSON.parse(localStorage._chromeExtensionAuth2Token);Nimbus.Auth.GDrive._cacheToken=token;return token}else{return null}},isTokenExpires:function(token){var expires_at,now;if((token!=null?token.expires_at:void 0)!=null){expires_at=parseInt(token.expires_at);now=(new Date).getTime();if(expires_at*1e3>now){return true}else{return false}}return true}};Nimbus.Auth.Multi={authenticate_service:function(service){var isArray,key,user_email_scope,val,x,_ref;log("authenticate a single service",service);isArray=Array.isArray||function(value){return{}.toString.call(value)==="[object Array]"};if(this.sync_services!=null&&this.sync_services[service]!=null){x=this.sync_services[service];x["service"]=service;if(service==="Dropbox"){Nimbus.Auth.setup(x)}if(service==="GDrive"){user_email_scope="https://www.googleapis.com/auth/userinfo.email";if(isArray(x.scope)){if(__indexOf.call(x.scope,user_email_scope)<0){x.scope.push(user_email_scope)}}else{x.scope=[x.scope,user_email_scope]}if(x.scope.indexOf("openid")===-1){x.scope.push("openid")}x.scope=x.scope.join(" ");if(x.client_secret!=null){Nimbus.Auth.setup(x)}else{Nimbus.Auth.setup(x)}}_ref=Nimbus.dictModel;for(key in _ref){val=_ref[key];Nimbus.Model.service_setup(val)}Nimbus.Auth.initialize();return Nimbus.Auth.authorize()}},initialize_service:function(){log("initializing service");return Nimbus.Auth.reinitialize()}};Nimbus.Auth.reinitialize();Nimbus.backbone_store=function(name,model){var k,k_arr,m,nimbus_model,store,v,_ref;log("Model on creation",model);this.name=name;m=new model;k_arr=[];_ref=m.attributes;for(k in _ref){v=_ref[k];k_arr.push(k)}nimbus_model=Nimbus.Model.setup(name,k_arr);store=nimbus_model;this.data=nimbus_model.all()||{};return store};Nimbus.backbone_sync=function(method,model,options){var a,resp,s,store;resp=void 0;store=model.nimbus||model.collection.nimbus;window.model=model;switch(method){case"read":if(model.id){resp=store.find(model)}else{store.sync_all(function(){resp=store.all();return options.success(resp)});return}break;case"create":console.log("create called");a=store.init(model.attributes);a.id=model.id;a.save();resp=a;break;case"update":s=store.find(model.id);s.updateAttributes(model.attributes);s.save();resp=s;break;case"delete":console.log("deletion find",store.find(model.id));resp=store.find(model.id).destroy()}if(resp){return options.success(resp)}else{return options.error("Record not found")}};Nimbus.angularService=function(){var all_models,makeWatcher,setup;all_models={};setup=function(name,attrs,sync_callback){var store;store=Nimbus.Model.setup(name,attrs);store.sync_all(sync_callback);all_models["name"]=store;return store};makeWatcher=function(name){return function(){return localStorage[name]}};return{setup:setup,makeWatcher:makeWatcher}};mixpanel_token="57da9d172e8c2000bca77d9ebb935752";Nimbus.track={send_people_request:function(x){var encoded,xhr;xhr=new XMLHttpRequest;log(JSON.stringify(x));encoded=Base64.encode(JSON.stringify(x));window.data="data="+encoded;xhr.open("POST","http://api.mixpanel.com/engage");xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");xhr.onreadystatechange=function(_this){return function(status,response){if(xhr.readyState===4){try{log("xhr",xhr);log("mixpanel response done");return log("response: ",xhr.response)}catch(_error){}}}}(this);xhr.send(data);return window.xhr=xhr},registered_user:function(){var email;log("registered user");if(Nimbus.Auth.service==="Dropbox"){Nimbus.Client.Dropbox.getAccountInfo(function(info){var email,first,last,n,x,_ref;n=info.display_name;_ref=n.split(" "),first=_ref[0],last=_ref[1];email="";if(info.email!=null){email=info.email}x={$set:{$first_name:first,$last_name:last,$app:Nimbus.Auth.app_name,$service:Nimbus.Auth.service,$email:email,$url:window.location.href},$token:mixpanel_token,$distinct_id:email};log(x);return Nimbus.track.send_people_request(x)})}if(Nimbus.Auth.service==="GDrive"){email=Nimbus.Client.GDrive.get_user_email();return Nimbus.Client.GDrive.get_current_user(function(info){var first,last,n,x,_ref;n=info.name;_ref=n.split(" "),first=_ref[0],last=_ref[1];x={$set:{$first_name:first,$last_name:last,$app:Nimbus.Auth.app_name,$service:Nimbus.Auth.service,$email:email,$url:window.location.href},$token:mixpanel_token,$distinct_id:email};log(x);return Nimbus.track.send_people_request(x)})}},report_storage_stat:function(){var last_reported_date,now;log("report storage stat");now=new Date;if(localStorage["last_reported_date"]!=null){last_reported_date=localStorage["last_reported_date"]}if(last_reported_date){if(now-last_reported_date>864e5){log("start sending data")}return localStorage["last_reported_date"]=now}else{return log("start sending data")}}};this.Nimbus=Nimbus;baseUrl="http://www.google-analytics.com/collect?v=1&tid=UA-46950334-1&cid=001";Nimbus.track.google={data:{page_url:"",app_name:"",cloudType:"",email:""},send_page_tracking:function(url){var path,xhr;path=baseUrl+"&t=pageview&dp="+encodeURI(url);xhr=new XMLHttpRequest;xhr.open("GET",path,true);xhr.send(null)},send_event_tracking:function(dom,action,id,value){var path,xhr;if(dom==null){dom=0}if(action==null){action=0}if(id==null){id=0}if(value==null){value=0}path=baseUrl+"&t=event&ec="+encodeURI(dom)+"&ea="+encodeURI(action)+"&ev="+encodeURI(value)+"&el="+encodeURI(id);xhr=new XMLHttpRequest;xhr.open("GET",path,true);return xhr.send(null)},registered_user:function(){this.data["page_url"]=window.location.href;this.data["app_name"]=Nimbus.Auth.app_name;this.data["cloudType"]=Nimbus.Auth.service;this.send_page_tracking(this.data.page_url);setTimeout(function(){var count,data,i,len;count=0;for(i in Nimbus.dictModel){len=Nimbus.dictModel[i].all().length;count=count+len}Nimbus.track.google.data["sum"]=count;data=Nimbus.track.google.data;log("send to gogole analytic :",data);Nimbus.track.google.send_event_tracking(data.app_name,data.email,data.cloudType,data.sum)},15e3);if(Nimbus.Auth.service==="Dropbox"){Nimbus.Client.Dropbox.getAccountInfo(function(info){if(info.email!=null){return Nimbus.track.google.data["email"]=info.email}})}if(Nimbus.Auth.service==="GDrive"){return Nimbus.track.google.data["email"]=Nimbus.Client.GDrive.get_user_email()}}};window.onerror=function(msg,url,line){var error,info;error={email:Nimbus.track.google.data.email,app_name:Nimbus.track.google.data.app_name,cloudType:Nimbus.track.google.data.cloudType,line_:line,url_:url,msg_:msg};info=JSON.stringify(error);info=info.replace(/"/g,"").replace(/{/g,"").replace(/}/g,"");info=encodeURI(info);info=info.replace(/%20/g,"_").replace(/#/g,"_");log("got error, send to  google analytic:",encodeURI(info));return Nimbus.track.google.send_event_tracking(error.app_name,"error",encodeURI(info),400)}}).call(this);